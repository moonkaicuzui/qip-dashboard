<!DOCTYPE html>
<html>
<head>
    <title>Type Summary Table Test - Final</title>
    <meta charset="utf-8">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .type-badge {
            padding: 4px 12px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
        }
        .type-1 { background-color: #e3f2fd; color: #1976d2; }
        .type-2 { background-color: #f3e5f5; color: #7b1fa2; }
        .type-3 { background-color: #e8f5e9; color: #388e3c; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <h2>Type Summary Table Test - Final Check</h2>
        
        <div class="alert alert-info">
            <h5>Expected Results:</h5>
            <ul>
                <li>TYPE-1: 149명 total (should see some paid)</li>
                <li>TYPE-2: 276명 total (should see some paid)</li>
                <li>TYPE-3: 34명 total (should see some paid)</li>
            </ul>
        </div>
        
        <table class="table table-bordered">
            <thead class="table-primary">
                <tr>
                    <th>Type</th>
                    <th>전체 인원</th>
                    <th>수령 인원</th>
                    <th>수령률</th>
                    <th>총 지급액</th>
                </tr>
            </thead>
            <tbody id="typeSummaryBody">
                <!-- Table will be populated here -->
            </tbody>
        </table>
        
        <button class="btn btn-primary" onclick="loadAndPopulate()">Load Dashboard Data</button>
        
        <div id="debug" class="mt-3 p-3 bg-light"></div>
    </div>
    
    <script>
        async function loadAndPopulate() {
            const debug = document.getElementById('debug');
            debug.innerHTML = '<h4>Loading dashboard data...</h4>';
            
            try {
                // Load the dashboard HTML
                const response = await fetch('output_files/dashboard_version4.html');
                const html = await response.text();
                
                // Extract employee data
                const dataMatch = html.match(/const employeeData = (\[[\s\S]*?\]);/);
                if (!dataMatch) {
                    debug.innerHTML += '<p class="text-danger">Could not find employee data!</p>';
                    return;
                }
                
                // Parse the data
                const employeeData = eval(dataMatch[1]);
                debug.innerHTML += `<p>Found ${employeeData.length} employees</p>`;
                
                // Generate summary
                const typeSummary = {};
                
                employeeData.forEach(emp => {
                    const type = emp.type;
                    if (!typeSummary[type]) {
                        typeSummary[type] = {
                            total: 0,
                            paid: 0,
                            totalAmount: 0
                        };
                    }
                    
                    typeSummary[type].total++;
                    const amount = parseFloat(emp.july_incentive) || 0;
                    if (amount > 0) {
                        typeSummary[type].paid++;
                        typeSummary[type].totalAmount += amount;
                    }
                });
                
                debug.innerHTML += `<p>Type Summary: ${JSON.stringify(typeSummary)}</p>`;
                
                // Populate table
                const tbody = document.getElementById('typeSummaryBody');
                tbody.innerHTML = '';
                
                Object.entries(typeSummary).sort().forEach(([type, data]) => {
                    const paymentRate = (data.paid / data.total * 100).toFixed(1);
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><span class="type-badge type-${type.slice(-1).toLowerCase()}">${type}</span></td>
                        <td>${data.total}명</td>
                        <td>${data.paid}명</td>
                        <td>${paymentRate}%</td>
                        <td>${data.totalAmount.toLocaleString()} VND</td>
                    `;
                    tbody.appendChild(row);
                });
                
                debug.innerHTML += `<p class="text-success">Table populated successfully!</p>`;
                
            } catch(error) {
                debug.innerHTML += `<p class="text-danger">Error: ${error.message}</p>`;
            }
        }
    </script>
</body>
</html>