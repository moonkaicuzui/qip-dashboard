# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

QIP (Quality Inspection Process) Incentive Dashboard System - A comprehensive incentive calculation and visualization system for factory workers with Google Drive integration and JSON-based business rule configuration.

## Core Development Principles

### 1. No Fake Data Policy (절대 가짜 데이터 금지)
- **NEVER generate fake/dummy data under any circumstances**
- If data doesn't exist, display as empty, 0, or "데이터 없음" 
- "우리사전에 가짜 데이타는 없다" - This is a fundamental principle
- When previous month data is missing, DO NOT generate estimates or random values

### 2. JSON-Driven Configuration (하드코딩 금지)
- **ALL business logic must be configured through JSON files**
- Never hardcode conditions, thresholds, or business rules in Python/JavaScript code
- Use `position_condition_matrix.json` for all condition definitions
- Any business rule change should only require JSON file updates, not code changes
- This ensures maintainability and flexibility without developer intervention

## Key Commands

### One-Click Full Process
```bash
# Run complete incentive report generation (recommended)
./action.sh
```

### Individual Components
```bash
# Generate dashboard for specific month
python integrated_dashboard_final.py --month 8 --year 2025

# With Google Drive sync
python integrated_dashboard_final.py --month 8 --year 2025 --sync

# Step-by-step execution
python src/step0_create_monthly_config.py --month august --year 2025
python src/step1_인센티브_계산_개선버전.py --config config_files/config_august_2025.json
python src/step2_dashboard_version4.py --month august --year 2025
```

### Testing and Validation
```bash
# Run all tests
./test_final.sh

# Validate dashboard output
python validate_dashboard.py

# Check position conditions
python verify_all_positions.py
```

## Architecture and Core Components

### Business Logic Configuration System
The system uses JSON-based configuration to define all business rules, eliminating hardcoding:

1. **`config_files/position_condition_matrix.json`** - Master configuration defining:
   - All condition definitions (attendance, AQL, 5PRS, etc.)
   - Position-to-condition mapping by TYPE (TYPE-1, TYPE-2, TYPE-3)
   - Validation thresholds and rules
   - Special calculation cases (e.g., AQL_INSPECTOR)

2. **Monthly Config Files** (`config_files/config_[month]_[year].json`)
   - Generated by `step0_create_monthly_config.py`
   - Contains month-specific parameters and file paths

### Data Flow Pipeline

1. **Data Input Sources**
   - Incentive files: `input_files/[year]년 [month] 인센티브 지급 세부 정보.csv`
   - Attendance data: `input_files/attendance/`
   - AQL history: `input_files/AQL history/`
   - 5PRS data: `input_files/5prs data [month].csv`
   - Basic manpower: `input_files/basic manpower data [month].csv`

2. **Processing Steps**
   - **Step 0**: Config generation (`src/step0_create_monthly_config.py`)
   - **Step 1**: Incentive calculation (`src/step1_인센티브_계산_개선버전.py`)
   - **Step 2**: Dashboard generation (`src/step2_dashboard_version4.py` or `integrated_dashboard_final.py`)

3. **Output Files**
   - Excel: `output_files/output_QIP_incentive_[month]_[year]_최종완성버전_v6.0_Complete.xlsx`
   - HTML Dashboard: `output_files/dashboard_[year]_[month].html`
   - Metadata: JSON files with calculation details

### Critical Implementation Details

#### Dynamic Condition Evaluation
- All conditions are evaluated dynamically from `position_condition_matrix.json`
- Each employee gets a `condition_results` array with detailed evaluation results
- No hardcoded conditions - everything is configuration-driven

#### Previous Month Data Handling
- System attempts to load previous month data for comparison
- If data doesn't exist, shows as 0 or empty (NO fake data generation)
- Important: "우리사전에 가짜 데이타는 없다" (No fake data in our dictionary)

#### JavaScript Generation in Python
- Dashboard HTML is generated with embedded JavaScript
- Template literals use f-strings - escape braces as `{{}}` to avoid syntax errors
- Chart.js instances must be destroyed before recreation to prevent animation bugs

#### Type Classification
- TYPE-1: Management and specialized positions (higher incentive ranges)
- TYPE-2: Standard inspection positions (moderate incentive ranges)  
- TYPE-3: New QIP members (basic incentive, no conditions required)

### Google Drive Integration

The system includes Google Drive sync capabilities:
- Credentials: `credentials/service-account-key.json`
- Manager: `src/google_drive_manager.py`
- Auto-sync: `src/auto_run_with_drive.py`

### Common Issues and Solutions

1. **Template Literal Errors**: Ensure `{{}}` escaping in f-strings for JavaScript objects
2. **Chart Animation Bug**: Always destroy existing Chart.js instances before creating new ones
3. **Missing July Data**: System will show 0, not generate fake data
4. **Condition Evaluation**: Check `position_condition_matrix.json` for position mapping

### Language Support

The system supports multilingual labels (Korean, English, Vietnamese) configured in the JSON files. Dashboard UI primarily uses Korean with some English labels.

## Dependencies

Core: pandas, numpy, openpyxl
Google Drive: gspread, google-auth
Scheduling: schedule
See `requirements.txt` for full list

## Development Notes

- Always preserve existing data integrity - never generate fake data
- Maintain JSON-driven configuration approach for all business rules
- Test thoroughly with `test_final.sh` before deployment
- Dashboard HTML includes all data inline - no external dependencies required for viewing