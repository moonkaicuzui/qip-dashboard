<!DOCTYPE html>
<html>
<head>
    <title>Organization Chart Debug</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
</head>
<body>
    <h1>Organization Chart Debug Test</h1>
    <div id="results"></div>

    <script>
        // Load the dashboard HTML and extract employeeData
        fetch('output_files/Incentive_Dashboard_2025_09_Version_5.html')
            .then(response => response.text())
            .then(html => {
                // Extract employeeData from the HTML
                const match = html.match(/const employeeData = (\[[\s\S]*?\]);/);
                if (match) {
                    const employeeData = eval(match[1]);

                    // Analyze the data
                    const results = document.getElementById('results');

                    // Check TYPE distribution
                    const typeCount = {};
                    employeeData.forEach(emp => {
                        const type = emp.type || 'UNKNOWN';
                        typeCount[type] = (typeCount[type] || 0) + 1;
                    });

                    // Check for boss relationships
                    const hasBoss = employeeData.filter(emp => emp.boss_id && emp.boss_id !== '' && emp.boss_id !== 'nan');
                    const noBoss = employeeData.filter(emp => !emp.boss_id || emp.boss_id === '' || emp.boss_id === 'nan');

                    // Check TYPE-1 employees (excluding specific positions)
                    const excludedPositions = ['MODEL MASTER', 'AUDIT & TRAINING TEAM'];
                    const type1Employees = employeeData.filter(e =>
                        e.type === 'TYPE-1' &&
                        !excludedPositions.includes(e.position)
                    );

                    // Build hierarchy test
                    const hierarchyData = [];
                    const requiredIds = new Set();

                    // Add TYPE-1 employees
                    type1Employees.forEach(emp => {
                        requiredIds.add(emp.emp_no);
                    });

                    // Add boss chain
                    const addBossChain = (empId) => {
                        const emp = employeeData.find(e => e.emp_no === empId);
                        if (!emp) return;

                        if (emp.boss_id && emp.boss_id !== '' && emp.boss_id !== 'nan' && emp.boss_id !== '0') {
                            const bossExists = employeeData.some(e => e.emp_no === emp.boss_id);

                            if (bossExists && !requiredIds.has(emp.boss_id)) {
                                requiredIds.add(emp.boss_id);
                                addBossChain(emp.boss_id);
                            }
                        }
                    };

                    type1Employees.forEach(emp => {
                        addBossChain(emp.emp_no);
                    });

                    // Create hierarchy nodes
                    const idToEmployee = {};
                    employeeData.forEach(e => {
                        idToEmployee[e.emp_no] = e;
                    });

                    requiredIds.forEach(id => {
                        const emp = idToEmployee[id];
                        if (emp) {
                            let parentId = null;
                            if (emp.boss_id && emp.boss_id !== '' && emp.boss_id !== 'nan' && requiredIds.has(emp.boss_id)) {
                                parentId = emp.boss_id;
                            }

                            hierarchyData.push({
                                id: emp.emp_no,
                                name: emp.name,
                                position: emp.position,
                                parentId: parentId,
                                type: emp.type,
                                incentive: emp.august_incentive || 0
                            });
                        }
                    });

                    // Find root nodes
                    const rootNodes = hierarchyData.filter(n => !n.parentId || n.parentId === null);

                    results.innerHTML = `
                        <h2>Data Analysis Results:</h2>
                        <h3>1. Employee Data</h3>
                        <p>Total employees: ${employeeData.length}</p>

                        <h3>2. TYPE Distribution</h3>
                        <ul>
                            ${Object.entries(typeCount).map(([type, count]) =>
                                `<li>${type}: ${count} employees</li>`
                            ).join('')}
                        </ul>

                        <h3>3. Boss Relationships</h3>
                        <p>Employees with boss: ${hasBoss.length}</p>
                        <p>Employees without boss: ${noBoss.length}</p>

                        <h3>4. TYPE-1 Filtering</h3>
                        <p>TYPE-1 employees (after exclusions): ${type1Employees.length}</p>
                        <p>Sample TYPE-1 employees:</p>
                        <ul>
                            ${type1Employees.slice(0, 5).map(emp =>
                                `<li>${emp.name} (${emp.emp_no}) - ${emp.position} - Boss: ${emp.boss_name || 'None'} (${emp.boss_id || 'N/A'})</li>`
                            ).join('')}
                        </ul>

                        <h3>5. Hierarchy Building</h3>
                        <p>Required IDs (including boss chain): ${requiredIds.size}</p>
                        <p>Hierarchy nodes created: ${hierarchyData.length}</p>
                        <p>Root nodes found: ${rootNodes.length}</p>

                        <h3>6. Root Nodes</h3>
                        <ul>
                            ${rootNodes.map(node =>
                                `<li>${node.name} (${node.id}) - ${node.position} - Type: ${node.type}</li>`
                            ).join('')}
                        </ul>

                        <h3>7. D3 Hierarchy Test</h3>
                        <div id="d3test"></div>
                    `;

                    // Try to create D3 hierarchy
                    if (hierarchyData.length > 0) {
                        try {
                            const stratify = d3.stratify()
                                .id(d => d.id)
                                .parentId(d => d.parentId);

                            const root = stratify(hierarchyData);
                            document.getElementById('d3test').innerHTML =
                                `<p style="color: green;">✅ D3 hierarchy created successfully!</p>
                                 <p>Root: ${root.data.name}</p>
                                 <p>Total descendants: ${root.descendants().length}</p>
                                 <p>Total leaves: ${root.leaves().length}</p>
                                 <p>Tree height: ${root.height}</p>`;
                        } catch (error) {
                            document.getElementById('d3test').innerHTML =
                                `<p style="color: red;">❌ D3 hierarchy failed: ${error.message}</p>
                                 <p>This usually means there's a circular reference or missing parent.</p>`;

                            // Check for circular references or missing parents
                            const issues = [];
                            hierarchyData.forEach(node => {
                                if (node.parentId && !hierarchyData.find(n => n.id === node.parentId)) {
                                    issues.push(`Node ${node.name} (${node.id}) has missing parent: ${node.parentId}`);
                                }
                            });
                            if (issues.length > 0) {
                                document.getElementById('d3test').innerHTML +=
                                    `<p>Issues found:</p><ul>${issues.map(i => `<li>${i}</li>`).join('')}</ul>`;
                            }
                        }
                    } else {
                        document.getElementById('d3test').innerHTML =
                            '<p style="color: orange;">⚠️ No hierarchy data available to test</p>';
                    }

                } else {
                    results.innerHTML = '<p style="color: red;">Could not extract employeeData from dashboard HTML</p>';
                }
            })
            .catch(error => {
                document.getElementById('results').innerHTML =
                    `<p style="color: red;">Error loading dashboard: ${error.message}</p>`;
            });
    </script>
</body>
</html>