name: ğŸ”„ Auto Update Dashboard from Google Drive

on:
  schedule:
    # ë§¤ì‹œê°„ ì‹¤í–‰ (í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì¡°ì • í•„ìš”)
    - cron: '0 * * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

  # main ë¸Œëœì¹˜ í‘¸ì‹œì‹œ ì‹¤í–‰
  push:
    branches: [ main ]
    paths:
      - 'integrated_dashboard_final.py'
      - 'scripts/download_from_gdrive.py'
      - '.github/workflows/auto-update.yml'

# GitHub Actionsì— write ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
    # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    - uses: actions/checkout@v3
      with:
        persist-credentials: true
        fetch-depth: 0

    # 2. Python ì„¤ì •
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. ìºì‹œ ì„¤ì • (ë¹ ë¥¸ ì‹¤í–‰)
    - name: ğŸ“¦ Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“š Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client beautifulsoup4

    # 5. Google Driveì—ì„œ CSV ë‹¤ìš´ë¡œë“œ
    - name: ğŸ“¥ Download CSV from Google Drive
      env:
        GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        echo "Downloading latest CSV files from Google Drive..."
        python scripts/download_from_gdrive.py

    # 6. Attendance ë°ì´í„° ë³€í™˜ (CRITICAL!)
    - name: ğŸ”„ Convert Attendance Data
      run: |
        echo "Converting attendance data to processed format..."
        python src/convert_attendance_data.py

    # 7. Config íŒŒì¼ ìë™ ìƒì„±/ì—…ë°ì´íŠ¸
    - name: ğŸ”§ Auto-generate Config Files
      run: |
        echo "Auto-generating config files for new months..."
        python scripts/auto_generate_configs.py

    # 8. ì¸ì„¼í‹°ë¸Œ ìë™ ê³„ì‚°
    - name: ğŸ’° Calculate Incentives
      run: |
        echo "Calculating incentives for all months..."
        python scripts/auto_calculate_incentives.py

    # 8. ìë™ ê²€ì¦ ì‹¤í–‰ (NEW!)
    - name: ğŸ” Auto Validation
      run: |
        echo "Validating calculated incentives..."
        python scripts/auto_validation.py
      continue-on-error: false

    # 9. ëŒ€ì‹œë³´ë“œ HTML ìƒì„±
    - name: ğŸ¨ Generate Dashboard HTML
      run: |
        echo "Generating dashboard for all available months..."
        python scripts/generate_dashboard_for_pages.py

    # 10. GitHub Pages ë””ë ‰í† ë¦¬ ì¤€ë¹„
    - name: ğŸ“‚ Prepare GitHub Pages directory
      run: |
        # docs í´ë” ìƒì„± (GitHub Pagesìš©)
        mkdir -p docs

        # HTML íŒŒì¼ ë³µì‚¬
        cp output_files/*.html docs/ 2>/dev/null || true

        # index.html ìƒì„± (ì›” ì„ íƒ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)
        echo "<!DOCTYPE html>
        <html lang=\"ko\">
        <head>
            <meta charset='UTF-8'>
            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
            <meta http-equiv='refresh' content='0; url=selector.html'>
            <title>QIP ì¸ì„¼í‹°ë¸Œ ëŒ€ì‹œë³´ë“œ</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }
                .loading {
                    text-align: center;
                }
                .spinner {
                    border: 4px solid rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    border-top: 4px solid white;
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
                h2 {
                    margin: 0;
                    font-size: 1.5rem;
                }
                p {
                    margin: 10px 0 0;
                    opacity: 0.9;
                }
            </style>
        </head>
        <body>
            <div class=\"loading\">
                <div class=\"spinner\"></div>
                <h2>QIP ì¸ì„¼í‹°ë¸Œ ëŒ€ì‹œë³´ë“œ</h2>
                <p>ì›” ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...</p>
                <p>Redirecting to month selector...</p>
            </div>
        </body>
        </html>" > docs/index.html

        # ì›” ì„ íƒ í˜ì´ì§€ ìƒì„±
        python scripts/create_month_selector.py

    # 11. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
    - name: ğŸ“¤ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # ë³€ê²½ì‚¬í•­ ì²´í¬
        if [[ -n $(git status -s) ]]; then
          git add docs/*.html
          git add output_files/*.csv 2>/dev/null || true
          git commit -m "ğŸ”„ Auto update dashboard from Google Drive $(date '+%Y-%m-%d %H:%M:%S')"

          # Pull latest changes with rebase before pushing
          echo "Pulling latest changes from remote..."
          git pull --rebase origin main || {
            echo "âš ï¸ Rebase conflict detected, using theirs strategy for auto-generated files"
            git checkout --theirs docs/*.html output_files/*.csv 2>/dev/null || true
            git add docs/*.html output_files/*.csv 2>/dev/null || true
            git rebase --continue || true
          }

          git push
          echo "âœ… Dashboard updated successfully!"
        else
          echo "â„¹ï¸ No changes detected"
        fi

    # 12. GitHub Pages ë°°í¬ í™•ì¸
    - name: ğŸŒ Deploy to GitHub Pages
      run: |
        echo "Dashboard will be available at:"
        echo "https://moonkaicuzui.github.io/qip-dashboard/"
        echo ""
        echo "Individual month dashboards:"
        for file in docs/Incentive_Dashboard_*.html; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "https://moonkaicuzui.github.io/qip-dashboard/$filename"
          fi
        done