name: ğŸ”„ Auto Update Dashboard from Google Drive

on:
  schedule:
    # ë§¤ì‹œê°„ ì‹¤í–‰ (í•œêµ­ ì‹œê°„ ê¸°ì¤€ ì¡°ì • í•„ìš”)
    - cron: '0 * * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

  # main ë¸Œëœì¹˜ í‘¸ì‹œì‹œ ì‹¤í–‰
  push:
    branches: [ main ]
    paths:
      - 'integrated_dashboard_final.py'
      - 'scripts/download_from_gdrive.py'
      - '.github/workflows/auto-update.yml'

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
    # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    - uses: actions/checkout@v3
      with:
        persist-credentials: true
        fetch-depth: 0

    # 2. Python ì„¤ì •
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. ìºì‹œ ì„¤ì • (ë¹ ë¥¸ ì‹¤í–‰)
    - name: ğŸ“¦ Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“š Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client beautifulsoup4

    # 5. Google Driveì—ì„œ CSV ë‹¤ìš´ë¡œë“œ
    - name: ğŸ“¥ Download CSV from Google Drive
      env:
        GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        echo "Downloading latest CSV files from Google Drive..."
        python scripts/download_from_gdrive.py

    # 6. ëŒ€ì‹œë³´ë“œ HTML ìƒì„±
    - name: ğŸ¨ Generate Dashboard HTML
      run: |
        echo "Generating dashboard for all available months..."
        python scripts/generate_dashboard_for_pages.py

    # 7. GitHub Pages ë””ë ‰í† ë¦¬ ì¤€ë¹„
    - name: ğŸ“‚ Prepare GitHub Pages directory
      run: |
        # docs í´ë” ìƒì„± (GitHub Pagesìš©)
        mkdir -p docs

        # HTML íŒŒì¼ ë³µì‚¬
        cp output_files/*.html docs/ 2>/dev/null || true

        # index.html ìƒì„± (ìµœì‹  ì›” ëŒ€ì‹œë³´ë“œë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)
        latest_file=$(ls -t output_files/Incentive_Dashboard_*.html | head -1)
        if [ -f "$latest_file" ]; then
          filename=$(basename "$latest_file")
          echo "<!DOCTYPE html>
          <html>
          <head>
            <meta charset='UTF-8'>
            <meta http-equiv='refresh' content='0; url=$filename'>
            <title>QIP Dashboard</title>
          </head>
          <body>
            <p>Loading latest dashboard...</p>
          </body>
          </html>" > docs/index.html
        fi

        # ì›” ì„ íƒ í˜ì´ì§€ ìƒì„±
        python scripts/create_month_selector.py

    # 8. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
    - name: ğŸ“¤ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # ë³€ê²½ì‚¬í•­ ì²´í¬
        if [[ -n $(git status -s) ]]; then
          git add docs/*.html
          git add output_files/*.csv 2>/dev/null || true
          git commit -m "ğŸ”„ Auto update dashboard from Google Drive $(date '+%Y-%m-%d %H:%M:%S')"
          git push
          echo "âœ… Dashboard updated successfully!"
        else
          echo "â„¹ï¸ No changes detected"
        fi

    # 9. GitHub Pages ë°°í¬ í™•ì¸
    - name: ğŸŒ Deploy to GitHub Pages
      run: |
        echo "Dashboard will be available at:"
        echo "https://moonkaicuzui.github.io/qip-dashboard/"
        echo ""
        echo "Individual month dashboards:"
        for file in docs/Incentive_Dashboard_*.html; do
          if [ -f "$file" ]; then
            filename=$(basename "$file")
            echo "https://moonkaicuzui.github.io/qip-dashboard/$filename"
          fi
        done