name: ğŸ”„ Enhanced Auto Update Dashboard with Config Sync

on:
  schedule:
    # 30ë¶„ë§ˆë‹¤ ì‹¤í–‰ (ë°ì´í„° ì‹ ì„ ë„ ê°œì„ )
    - cron: '*/30 * * * *'

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

  # main ë¸Œëœì¹˜ í‘¸ì‹œì‹œ ì‹¤í–‰
  push:
    branches: [ main ]
    paths:
      - 'integrated_dashboard_final.py'
      - 'scripts/enhanced_download_with_config.py'
      - '.github/workflows/auto-update-enhanced.yml'

# GitHub Actionsì— write ê¶Œí•œ ë¶€ì—¬
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
    # 1. ì €ì¥ì†Œ ì²´í¬ì•„ì›ƒ
    - uses: actions/checkout@v3
      with:
        persist-credentials: true
        fetch-depth: 0

    # 2. Python ì„¤ì •
    - name: ğŸ Setup Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. ìºì‹œ ì„¤ì • (ë¹ ë¥¸ ì‹¤í–‰)
    - name: ğŸ“¦ Cache pip packages
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    # 4. ì˜ì¡´ì„± ì„¤ì¹˜
    - name: ğŸ“š Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install pandas numpy openpyxl google-auth google-auth-oauthlib google-auth-httplib2 google-api-python-client beautifulsoup4

    # 5. ğŸ†• í†µí•© ë‹¤ìš´ë¡œë“œ + Config ìë™ ì—…ë°ì´íŠ¸
    - name: ğŸ“¥ Download from Google Drive + Auto Update Config
      env:
        GOOGLE_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_SERVICE_ACCOUNT }}
        GDRIVE_FOLDER_ID: ${{ secrets.GDRIVE_FOLDER_ID }}
      run: |
        echo "====================================="
        echo "ğŸš€ í†µí•© ìë™í™” ì‹œìŠ¤í…œ ì‹¤í–‰"
        echo "====================================="
        echo ""
        echo "1. Google Driveì—ì„œ ìµœì‹  ë°ì´í„° ë‹¤ìš´ë¡œë“œ"
        echo "2. Config íŒŒì¼ ìë™ ì—…ë°ì´íŠ¸ (ì‹¤ì œ íŒŒì¼ ê²½ë¡œ ë°˜ì˜)"
        echo "3. Working days ìë™ ê³„ì‚° ë° ì—…ë°ì´íŠ¸"
        echo ""
        python scripts/enhanced_download_with_config.py

        # Config íŒŒì¼ ë³€ê²½ì‚¬í•­ í™•ì¸
        echo ""
        echo "ğŸ“‹ Config íŒŒì¼ ë³€ê²½ì‚¬í•­:"
        git diff config_files/*.json || true

    # 6. Attendance ë°ì´í„° ë³€í™˜ (CRITICAL!)
    - name: ğŸ”„ Convert Attendance Data
      run: |
        echo "Converting attendance data to processed format..."
        python src/convert_attendance_data.py

    # 7. ì¸ì„¼í‹°ë¸Œ ìë™ ê³„ì‚°
    - name: ğŸ’° Calculate Incentives
      run: |
        echo "Calculating incentives for all months..."
        python scripts/auto_calculate_incentives.py

    # 8. ìë™ ê²€ì¦ ì‹¤í–‰
    - name: ğŸ” Auto Validation
      run: |
        echo "Validating calculated incentives..."
        python scripts/auto_validation.py
      continue-on-error: false

    # 9. ëŒ€ì‹œë³´ë“œ HTML ìƒì„±
    - name: ğŸ¨ Generate Dashboard HTML
      run: |
        echo "Generating dashboard for all available months..."
        python scripts/generate_dashboard_for_pages.py

    # 10. GitHub Pages ë””ë ‰í† ë¦¬ ì¤€ë¹„
    - name: ğŸ“‚ Prepare GitHub Pages directory
      run: |
        # docs í´ë” ìƒì„± (GitHub Pagesìš©)
        mkdir -p docs

        # HTML íŒŒì¼ ë³µì‚¬
        cp output_files/*.html docs/ 2>/dev/null || true

        # CSV/Excel íŒŒì¼ ë³µì‚¬ (ë‹¤ìš´ë¡œë“œìš©)
        cp output_files/*.csv docs/ 2>/dev/null || true
        cp output_files/*.xlsx docs/ 2>/dev/null || true

        # index.html ìƒì„± (ì›” ì„ íƒ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸)
        echo "<!DOCTYPE html>
        <html lang=\"ko\">
        <head>
            <meta charset='UTF-8'>
            <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
            <meta http-equiv='refresh' content='0; url=selector.html'>
            <title>QIP ì¸ì„¼í‹°ë¸Œ ëŒ€ì‹œë³´ë“œ</title>
            <style>
                body {
                    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                    display: flex;
                    justify-content: center;
                    align-items: center;
                    height: 100vh;
                    margin: 0;
                    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                    color: white;
                }
                .loading {
                    text-align: center;
                }
                .spinner {
                    border: 4px solid rgba(255, 255, 255, 0.3);
                    border-radius: 50%;
                    border-top: 4px solid white;
                    width: 40px;
                    height: 40px;
                    animation: spin 1s linear infinite;
                    margin: 0 auto 20px;
                }
                @keyframes spin {
                    0% { transform: rotate(0deg); }
                    100% { transform: rotate(360deg); }
                }
            </style>
        </head>
        <body>
            <div class=\"loading\">
                <div class=\"spinner\"></div>
                <h2>QIP ì¸ì„¼í‹°ë¸Œ ëŒ€ì‹œë³´ë“œ</h2>
                <p>ì›” ì„ íƒ í˜ì´ì§€ë¡œ ì´ë™ ì¤‘...</p>
            </div>
        </body>
        </html>" > docs/index.html

        # ì›” ì„ íƒ í˜ì´ì§€ ìƒì„±
        python scripts/create_month_selector.py

    # 11. ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
    - name: ğŸ“¤ Commit and push changes
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"

        # ë³€ê²½ì‚¬í•­ ì²´í¬
        if [[ -n $(git status -s) ]]; then
          echo "ğŸ“ ë³€ê²½ì‚¬í•­ ë°œê²¬, ì»¤ë°‹ ì¤€ë¹„ ì¤‘..."

          # Add files we want to commit FIRST (before any stash)
          echo "ğŸ“¦ íŒŒì¼ ì¶”ê°€ ì¤‘..."
          git add config_files/*.json 2>/dev/null || true
          git add docs/*.html 2>/dev/null || true
          git add docs/*.csv 2>/dev/null || true
          git add docs/*.xlsx 2>/dev/null || true
          git add output_files/*.csv 2>/dev/null || true
          git add output_files/*.xlsx 2>/dev/null || true

          # Check if there are staged changes
          if [[ -n $(git diff --cached --name-only) ]]; then
            echo "âœ… Staged files:"
            git diff --cached --name-only

            # Pull latest changes before committing
            echo "Pulling latest changes from remote..."
            git pull --rebase origin main || {
              echo "âš ï¸ Rebase failed, aborting and retrying with merge..."
              git rebase --abort || true
              git pull origin main --no-rebase || true
            }

            # Commit changes
            TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
            git commit -m "ğŸ”„ Auto update dashboard + config sync from Google Drive $TIMESTAMP

            - Google Drive ë°ì´í„° ìë™ ë‹¤ìš´ë¡œë“œ
            - Config íŒŒì¼ ìë™ ì—…ë°ì´íŠ¸ (ì‹¤ì œ íŒŒì¼ ê²½ë¡œ ë°˜ì˜)
            - Working days ìë™ ê³„ì‚° ë° ì—…ë°ì´íŠ¸
            - ì¸ì„¼í‹°ë¸Œ ê³„ì‚° ë° ëŒ€ì‹œë³´ë“œ ìƒì„±" || {
              echo "âš ï¸ Commit failed"
              exit 0
            }

            # Push changes
            git push || {
              echo "âŒ Push failed, manual intervention required"
              exit 1
            }

            echo "âœ… Dashboard and config updated successfully!"
          else
            echo "â„¹ï¸ No files to commit after staging"
          fi
        else
          echo "â„¹ï¸ No changes detected"
        fi

    # 12. ì„±ê³µ ì•Œë¦¼
    - name: ğŸ‰ Success Notification
      run: |
        echo "=================================="
        echo "âœ… ìë™í™” ì™„ë£Œ!"
        echo "=================================="
        echo ""
        echo "ğŸ“Š ì—…ë°ì´íŠ¸ëœ í•­ëª©:"
        echo "  - Google Drive ë°ì´í„° ë™ê¸°í™”"
        echo "  - Config íŒŒì¼ ìë™ ì—…ë°ì´íŠ¸"
        echo "  - Working days ê³„ì‚° ë° ë°˜ì˜"
        echo "  - ì¸ì„¼í‹°ë¸Œ ê³„ì‚°"
        echo "  - ëŒ€ì‹œë³´ë“œ ìƒì„±"
        echo ""
        echo "ğŸŒ ëŒ€ì‹œë³´ë“œ URL:"
        echo "https://moonkaicuzui.github.io/qip-dashboard/"
        echo ""
        echo "ğŸ“ Config íŒŒì¼ë“¤:"
        ls -la config_files/config_*.json | tail -5
        echo ""
        echo "â° ë‹¤ìŒ ì‹¤í–‰: 1ì‹œê°„ í›„"