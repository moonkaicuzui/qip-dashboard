<!DOCTYPE html>
<html>
<head>
    <title>TYPE-1 ASSEMBLY INSPECTOR Organization Chart</title>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        h1 {
            text-align: center;
            color: #333;
        }
        #orgChart {
            width: 100%;
            height: 900px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow: hidden;
        }
        .node rect {
            cursor: pointer;
        }
        .node text {
            fill: white;
            font-size: 10px;
        }
        .link {
            fill: none;
            stroke: #666;
            stroke-width: 1.5;
        }
        .summary {
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .stats {
            display: flex;
            justify-content: space-around;
            margin-top: 10px;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #1f77b4;
        }
        .stat-label {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body>
    <h1>TYPE-1 ASSEMBLY INSPECTOR Organizational Hierarchy</h1>

    <div class="summary">
        <h3>Summary Statistics</h3>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-value">120</div>
                <div class="stat-label">TYPE-1 Assembly Inspectors</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">10</div>
                <div class="stat-label">Direct Bosses</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">1</div>
                <div class="stat-label">Manager (TRẦN THỊ BÍCH LY)</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">1</div>
                <div class="stat-label">A.Manager (LƯƠNG THỊ CẨM TIÊN)</div>
            </div>
        </div>
    </div>

    <div id="orgChart"></div>

    <script>
        // Load the hierarchy data from the Python script output
        fetch('assembly_inspector_hierarchy.json')
            .then(response => response.json())
            .then(data => drawOrgChart(data))
            .catch(error => {
                console.error('Error loading data:', error);
                // Use embedded sample data if file not found
                drawOrgChart(getSampleData());
            });

        function getSampleData() {
            // This is the actual data extracted from the Python analysis
            return [
                { id: "620070012", name: "TRẦN THỊ BÍCH LY", position: "MANAGER", parent_id: null },
                { id: "618030049", name: "LƯƠNG THỊ CẨM TIÊN", position: "A.MANAGER", parent_id: "620070012" },

                // Supervisors
                { id: "620020691", name: "VÕ VĂN KIỆT", position: "(V) SUPERVISOR", parent_id: "618030049" },
                { id: "620060128", name: "LÊ HUỲNH GIAO", position: "(V) SUPERVISOR", parent_id: "618030049" },
                { id: "619070072", name: "THÁI UYỂN NHI", position: "(V) SUPERVISOR", parent_id: "620020691" },
                { id: "618110042", name: "NGUYỄN THỊ HỒNG NHUNG", position: "(V) SUPERVISOR", parent_id: "618030049" },
                { id: "618040412", name: "CAO THỊ MIỀN", position: "(V) SUPERVISOR", parent_id: "618110042" },

                // Group Leaders
                { id: "619030390", name: "NGUYỄN THỊ BÍCH CHƯƠNG", position: "GROUP LEADER", parent_id: "620020691" },

                // Line Leaders
                { id: "619020468", name: "THỊ MY", position: "LINE LEADER", parent_id: "619030390" },
                { id: "621030759", name: "VŨ HỒNG TIÊN", position: "LINE LEADER", parent_id: "620060128" },
                { id: "620110408", name: "NGUYỄN VĂN LUÂN", position: "LINE LEADER", parent_id: "619070072" },
                { id: "622030022", name: "TRẦN NGÔ KIM TUYẾN", position: "LINE LEADER", parent_id: "619070072" },
                { id: "619080327", name: "NGUYỄN THỊ MỸ TRÂM", position: "LINE LEADER", parent_id: "620060128" },
                { id: "621110013", name: "SỬ HUYỀN TRANG", position: "LINE LEADER", parent_id: "618040412" },
                { id: "619100392", name: "PHẠM MINH HUY", position: "LINE LEADER", parent_id: "618040412" },

                // Sample Assembly Inspectors (showing just a few for clarity)
                { id: "621030996", name: "DANH MINH HIẾU", position: "ASSEMBLY INSPECTOR", parent_id: "619020468" },
                { id: "621040446", name: "THÁI THỊ XUÂN", position: "ASSEMBLY INSPECTOR", parent_id: "621030759" },
                { id: "621060243", name: "HÀ CÔNG NHANH", position: "ASSEMBLY INSPECTOR", parent_id: "619020468" },
                { id: "622021407", name: "DANH TRƯỜNG", position: "ASSEMBLY INSPECTOR", parent_id: "620110408" },
                { id: "622030320", name: "QUÁCH THANH TOÀN", position: "ASSEMBLY INSPECTOR", parent_id: "619030390" },
                { id: "620080271", name: "THỊ MINH PHƯỢNG", position: "ASSEMBLY INSPECTOR", parent_id: "622030022" }
            ];
        }

        function drawOrgChart(data) {
            const container = d3.select("#orgChart");
            const width = container.node().getBoundingClientRect().width;
            const height = 900;
            const margin = {top: 40, right: 120, bottom: 40, left: 120};

            // Clear existing content
            container.selectAll("*").remove();

            // Create SVG
            const svg = container
                .append("svg")
                .attr("width", width)
                .attr("height", height);

            const g = svg.append("g")
                .attr("transform", `translate(${margin.left},${margin.top})`);

            // Create hierarchy
            const stratify = d3.stratify()
                .id(d => d.id)
                .parentId(d => d.parent_id);

            const root = stratify(data);

            // Create tree layout (vertical)
            const treeLayout = d3.tree()
                .size([width - margin.left - margin.right, height - margin.top - margin.bottom])
                .separation((a, b) => {
                    // More separation for nodes with many children
                    const sep = a.parent === b.parent ? 1 : 2;
                    if (a.data.position === "ASSEMBLY INSPECTOR") return 0.5;
                    return sep;
                });

            treeLayout(root);

            // Add zoom functionality
            const zoom = d3.zoom()
                .scaleExtent([0.3, 3])
                .on("zoom", (event) => {
                    g.attr("transform", event.transform);
                });

            svg.call(zoom);

            // Draw links (step-style vertical)
            const link = g.selectAll(".link")
                .data(root.links())
                .enter().append("path")
                .attr("class", "link")
                .attr("d", d => {
                    const sx = d.source.x;
                    const sy = d.source.y + 25;
                    const tx = d.target.x;
                    const ty = d.target.y - 25;
                    const my = (sy + ty) / 2;

                    return `M ${sx} ${sy}
                            L ${sx} ${my}
                            L ${tx} ${my}
                            L ${tx} ${ty}`;
                });

            // Draw nodes
            const node = g.selectAll(".node")
                .data(root.descendants())
                .enter().append("g")
                .attr("class", "node")
                .attr("transform", d => `translate(${d.x},${d.y})`);

            // Add rectangles for nodes
            node.append("rect")
                .attr("x", d => d.data.position === "ASSEMBLY INSPECTOR" ? -40 : -60)
                .attr("y", -25)
                .attr("width", d => d.data.position === "ASSEMBLY INSPECTOR" ? 80 : 120)
                .attr("height", 50)
                .attr("rx", 5)
                .style("fill", d => {
                    const pos = d.data.position.toUpperCase();
                    if (pos === "MANAGER") return '#8b0000';
                    if (pos === "A.MANAGER") return '#1f77b4';
                    if (pos.includes("SUPERVISOR")) return '#2ca02c';
                    if (pos === "GROUP LEADER") return '#ff7f0e';
                    if (pos === "LINE LEADER") return '#d62728';
                    if (pos === "ASSEMBLY INSPECTOR") return '#9467bd';
                    return '#8c564b';
                })
                .style("stroke", "#333")
                .style("stroke-width", 2);

            // Add position text
            node.append("text")
                .attr("dy", -5)
                .attr("text-anchor", "middle")
                .text(d => d.data.position)
                .style("font-weight", "bold")
                .style("font-size", d => d.data.position === "ASSEMBLY INSPECTOR" ? "8px" : "10px");

            // Add name text
            node.append("text")
                .attr("dy", 10)
                .attr("text-anchor", "middle")
                .text(d => {
                    // Truncate long names for inspectors
                    const name = d.data.name;
                    if (d.data.position === "ASSEMBLY INSPECTOR" && name.length > 12) {
                        return name.substring(0, 10) + "...";
                    }
                    return name;
                })
                .style("font-size", d => d.data.position === "ASSEMBLY INSPECTOR" ? "7px" : "9px");

            // Add count badges for leaders
            const inspectorCounts = {};
            data.forEach(d => {
                if (d.position === "ASSEMBLY INSPECTOR" && d.parent_id) {
                    inspectorCounts[d.parent_id] = (inspectorCounts[d.parent_id] || 0) + 1;
                }
            });

            node.filter(d => inspectorCounts[d.id])
                .append("circle")
                .attr("cx", 45)
                .attr("cy", -15)
                .attr("r", 12)
                .style("fill", "red")
                .style("stroke", "white")
                .style("stroke-width", 2);

            node.filter(d => inspectorCounts[d.id])
                .append("text")
                .attr("x", 45)
                .attr("y", -11)
                .attr("text-anchor", "middle")
                .text(d => inspectorCounts[d.id])
                .style("font-size", "10px")
                .style("font-weight", "bold");

            // Set initial zoom to fit
            const bounds = g.node().getBBox();
            const fullWidth = width - margin.left - margin.right;
            const fullHeight = height - margin.top - margin.bottom;
            const midX = bounds.x + bounds.width / 2;
            const midY = bounds.y + bounds.height / 2;
            const scale = 0.8 / Math.max(bounds.width / fullWidth, bounds.height / fullHeight);

            svg.call(
                zoom.transform,
                d3.zoomIdentity
                    .translate(width / 2, height / 2)
                    .scale(scale)
                    .translate(-midX, -midY)
            );

            console.log(`Organization chart created with ${data.length} nodes`);
        }
    </script>
</body>
</html>