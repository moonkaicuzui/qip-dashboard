#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
HR Management Dashboard Generator v6.0 - Enhanced Version
ÏôÑÏ†ÑÌûà Í∞úÏÑ†Îêú Î≤ÑÏ†Ñ - Î™®Îì† ÏöîÏ≤≠ÏÇ¨Ìï≠ Íµ¨ÌòÑ
- Ï£ºÏ∞®Î≥Ñ Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú ÏàòÏ†ï
- ÌåÄÎ≥Ñ Ìä∏Î¶¨Îßµ Ï∞®Ìä∏ Ï∂îÍ∞Ä
- ÌåÄÎ≥Ñ ÏÑ∏Î∂Ä ÌåùÏóÖÏ∞Ω Íµ¨ÌòÑ
- TYPEÎ≥Ñ Ïù∏Ïõê Ïπ¥Îìú Ï∂îÍ∞Ä
- ÌåÄÎ≥Ñ ÎßåÍ∑º Ïù∏Ïõê Ï†ïÎ≥¥ Ï∂îÍ∞Ä
"""

import pandas as pd
import numpy as np
import json
import os
from datetime import datetime, timedelta
import argparse
import warnings
warnings.filterwarnings('ignore')

class EnhancedHRDashboard:
    def __init__(self, month, year):
        self.month = month
        self.year = year
        self.base_path = os.path.dirname(os.path.abspath(__file__))
        self.report_date = datetime.now()
        self.data = {
            'current': pd.DataFrame(),
            'previous': pd.DataFrame(),
            'attendance': pd.DataFrame()
        }
        self.metadata = {}
        self.weekly_data = {}
        self.team_structure = {}
        self.team_mapping = {}
        
        # Load UI configuration from JSON
        config_path = os.path.join(self.base_path, 'config_files', 'dashboard_ui_config.json')
        try:
            with open(config_path, 'r', encoding='utf-8') as f:
                self.ui_config = json.load(f)
            
            self.colors = self.ui_config['colors']
            self.typography = self.ui_config['typography']
            self.layout = self.ui_config['layout']
            self.thresholds = self.ui_config['thresholds']
            self.animation = self.ui_config['animation']
            self.treemap_config = self.ui_config['treemap_algorithm']
            self.data_display = self.ui_config['data_display']
        except FileNotFoundError:
            print(f"‚ö†Ô∏è UI config file not found, using default values")
            # Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            self.colors = {
                'primary': '#000000',
                'secondary': '#333333',
                'success': '#28a745',
                'danger': '#dc3545',
                'warning': '#ffc107',
                'info': '#17a2b8',
                'background': '#ffffff',
                'text': '#212529',
                'text_secondary': '#6c757d',
                'border': '#dee2e6',
                'chart_colors': [
                    '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4', '#FFEAA7',
                    '#DDA0DD', '#98D8C8', '#F7DC6F', '#BB8FCE', '#85C1E2',
                    '#FF9FF3', '#54A0FF', '#48DBFB', '#00D2D3', '#1ABC9C'
                ]
            }
        
    def load_data(self):
        """Îç∞Ïù¥ÌÑ∞ Î°úÎìú - NO FAKE DATA"""
        print(f"\nüìä Loading REAL data for {self.year}ÎÖÑ {self.month}Ïõî...")
        
        self.load_current_month_data()
        self.load_previous_month_data()
        self.load_attendance_data()
        self.load_team_structure()
        self.load_previous_metadata()
        self.calculate_real_weekly_data()
        
        print("‚úÖ Real data loading complete")
        
    def load_current_month_data(self):
        """ÌòÑÏû¨ Ïõî Îç∞Ïù¥ÌÑ∞ Î°úÎìú"""
        try:
            month_names = {
                1: '1Ïõî', 2: '2Ïõî', 3: '3Ïõî', 4: '4Ïõî', 5: '5Ïõî', 6: '6Ïõî',
                7: '7Ïõî', 8: '8Ïõî', 9: '9Ïõî', 10: '10Ïõî', 11: '11Ïõî', 12: '12Ïõî'
            }
            
            month_str = month_names.get(self.month, f'{self.month}Ïõî')
            file_path = f"input_files/{self.year}ÎÖÑ {month_str} Ïù∏ÏÑºÌã∞Î∏å ÏßÄÍ∏â ÏÑ∏Î∂Ä Ï†ïÎ≥¥.csv"
            
            if os.path.exists(file_path):
                df = pd.read_csv(file_path, encoding='utf-8-sig')
                
                # ÎÇ†Ïßú ÌååÏã±
                if 'Entrance Date' in df.columns:
                    df['Entrance Date'] = df['Entrance Date'].apply(self.parse_date)
                if 'Stop working Date' in df.columns:
                    df['Stop working Date'] = df['Stop working Date'].apply(self.parse_date)
                    
                self.data['current'] = df
                print(f"  ‚úì Current month REAL data loaded: {len(df)} records")
            else:
                print(f"  ‚ùå Current month data not found: {file_path}")
                self.data['current'] = pd.DataFrame()
                
        except Exception as e:
            print(f"  ‚ùå Error loading current month: {e}")
            self.data['current'] = pd.DataFrame()
            
    def load_previous_month_data(self):
        """Ïù¥Ï†Ñ Ïõî Îç∞Ïù¥ÌÑ∞ Î°úÎìú"""
        try:
            prev_month = self.month - 1 if self.month > 1 else 12
            prev_year = self.year if self.month > 1 else self.year - 1
            
            month_names = {
                1: '1Ïõî', 2: '2Ïõî', 3: '3Ïõî', 4: '4Ïõî', 5: '5Ïõî', 6: '6Ïõî',
                7: '7Ïõî', 8: '8Ïõî', 9: '9Ïõî', 10: '10Ïõî', 11: '11Ïõî', 12: '12Ïõî'
            }
            
            month_str = month_names.get(prev_month, f'{prev_month}Ïõî')
            file_path = f"input_files/{prev_year}ÎÖÑ {month_str} Ïù∏ÏÑºÌã∞Î∏å ÏßÄÍ∏â ÏÑ∏Î∂Ä Ï†ïÎ≥¥.csv"
            
            if os.path.exists(file_path):
                prev_df = pd.read_csv(file_path, encoding='utf-8-sig')
                
                # ÎÇ†Ïßú ÌååÏã±
                if 'Entrance Date' in prev_df.columns:
                    prev_df['Entrance Date'] = prev_df['Entrance Date'].apply(self.parse_date)
                if 'Stop working Date' in prev_df.columns:
                    prev_df['Stop working Date'] = prev_df['Stop working Date'].apply(self.parse_date)
                    
                self.data['previous'] = prev_df
                print(f"  ‚úì Previous month REAL data loaded: {len(prev_df)} records")
            else:
                print(f"  ‚ö† Previous month data not found")
                self.data['previous'] = pd.DataFrame()
                
        except Exception as e:
            print(f"  ‚ùå Error loading previous month: {e}")
            self.data['previous'] = pd.DataFrame()
            
    def load_attendance_data(self):
        """Ï∂úÍ≤∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú"""
        try:
            month_names_korean = {
                8: '8Ïõî', 7: '7Ïõî', 6: '6Ïõî', 5: '5Ïõî', 4: '4Ïõî', 3: '3Ïõî'
            }
            
            month_str = month_names_korean.get(self.month, f'{self.month}Ïõî')
            attendance_file = f"input_files/{month_str} Ï∂úÍ≤∞Ï†ïÎ≥¥ Îç∞Ïù¥ÌÑ∞.csv"
            
            if os.path.exists(attendance_file):
                self.data['attendance'] = pd.read_csv(attendance_file, encoding='utf-8-sig')
                print(f"  ‚úì Attendance REAL data loaded: {len(self.data['attendance'])} records")
            else:
                print(f"  ‚ö† Attendance data not found")
                self.data['attendance'] = pd.DataFrame()
                
        except Exception as e:
            print(f"  ‚ùå Error loading attendance: {e}")
            self.data['attendance'] = pd.DataFrame()
            
    def load_team_structure(self):
        """ÌåÄ Íµ¨Ï°∞ Îç∞Ïù¥ÌÑ∞ Î°úÎìú"""
        self.position_to_team = {}
        self.position_combo_to_team = {}
        
        # Default mappings (simplified and corrected)
        self.position_to_team = {
            # Only include unambiguous position mappings
            'HWK QIP': 'HWK QIP',
            'CUTTING INSPECTOR': 'CUTTING',
            'OFFICE INSPECTOR': 'OFFICE & OCPT',
            # Remove conflicting positions like ASSEMBLY INSPECTOR, LINE LEADER, etc.
        }
        
        try:
            # Load from JSON file
            import json
            with open('HR info/team_structure_updated.json', 'r', encoding='utf-8') as f:
                team_structure = json.load(f)
            
            # Track position conflicts
            position_teams = {}  # position -> set of teams
            
            for position_data in team_structure.get('positions', []):
                team_name = position_data.get('team_name', '')
                position_1st = position_data.get('position_1st', '').strip()
                position_2nd = position_data.get('position_2nd', '').strip()  
                position_3rd = position_data.get('position_3rd', '').strip()
                role_category = position_data.get('role_category', '')
                
                # Position combo mapping (always accurate)
                combo_key = f"{position_1st}|{position_2nd}|{position_3rd}"
                self.position_combo_to_team[combo_key] = team_name
                
                # Track which teams each position_1st belongs to
                if position_1st:
                    if position_1st not in position_teams:
                        position_teams[position_1st] = set()
                    position_teams[position_1st].add(team_name)
            
            # Only add position mappings that are unambiguous (belong to only one team)
            for position, teams in position_teams.items():
                if len(teams) == 1:  # Unambiguous position
                    self.position_to_team[position] = list(teams)[0]
                # else: Skip positions with multiple teams (like ASSEMBLY INSPECTOR, LINE LEADER)
            
            print(f"  ‚úì Team structure loaded")
            print(f"    - {len(self.position_combo_to_team)} position combinations")
            print(f"    - {len(self.position_to_team)} unambiguous positions")
            print(f"    - {len([p for p, t in position_teams.items() if len(t) > 1])} conflicting positions skipped")
            
        except FileNotFoundError:
            print(f"  ‚ö† Team structure file not found, using defaults")
        except Exception as e:
            print(f"  ‚ùå Error loading team structure: {e}")
    def load_previous_metadata(self):
        """Ïù¥Ï†Ñ Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Î°úÎìú"""
        try:
            metadata_file = f"output_files/hr_metadata_{self.year}.json"
            if os.path.exists(metadata_file):
                with open(metadata_file, 'r', encoding='utf-8') as f:
                    self.metadata = json.load(f)
                print(f"  ‚úì Previous metadata loaded")
            else:
                self.metadata = {'monthly_data': {}, 'weekly_data': {}, 'team_stats': {}}
                print(f"  ‚Ñπ Starting fresh metadata")
        except Exception as e:
            print(f"  ‚ùå Error loading metadata: {e}")
            self.metadata = {'monthly_data': {}, 'weekly_data': {}, 'team_stats': {}}
            
    def parse_date(self, date_str):
        """ÎÇ†Ïßú ÌååÏã±"""
        if pd.isna(date_str) or date_str == '' or date_str == 'nan':
            return pd.NaT
            
        date_str = str(date_str).strip()
        
        formats = [
            '%Y.%m.%d', '%d/%m/%Y', '%m/%d/%Y', '%Y-%m-%d',
            '%Y/%m/%d', '%d.%m.%Y', '%d-%m-%Y'
        ]
        
        for fmt in formats:
            try:
                return pd.to_datetime(date_str, format=fmt, dayfirst=('/' in fmt and fmt.index('/') < 3))
            except:
                continue
                
        try:
            return pd.to_datetime(date_str, dayfirst=True)
        except:
            return pd.NaT
            
    def calculate_real_weekly_data(self):
        """Ïã§Ï†ú Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞"""
        if self.data['current'].empty:
            self.weekly_data = {}
            return
            
        df = self.data['current']
        
        # Ïã§Ï†ú ÎÇ†Ïßú Í∏∞Î∞ò Ï£ºÏ∞® Í≥ÑÏÇ∞
        start_date = datetime(self.year, self.month, 1)
        
        week_data = {}
        for week_num in range(1, 5):
            week_start = start_date + timedelta(days=(week_num-1)*7)
            week_end = week_start + timedelta(days=6)
            
            week_key = f"Week{week_num}"
            
            # Ìï¥Îãπ Ï£ºÏ∞®Ïóê Ïû¨ÏßÅ Ï§ëÏù∏ ÏßÅÏõê
            active_employees = df[
                (df['Entrance Date'] <= week_end) & 
                ((df['Stop working Date'].isna()) | (df['Stop working Date'] > week_end))
            ]
            
            # Ïã†Í∑ú ÏûÖÏÇ¨Ïûê
            new_hires = df[
                (df['Entrance Date'] >= week_start) & 
                (df['Entrance Date'] <= week_end)
            ]
            
            # Ìá¥ÏÇ¨Ïûê
            resignations = df[
                (df['Stop working Date'] >= week_start) & 
                (df['Stop working Date'] <= week_end)
            ]
            
            # Ï∂úÍ∑ºÏú® Í≥ÑÏÇ∞
            if 'Actual Working Days' in df.columns and 'Total Working Days' in df.columns:
                attendance_rate = (
                    active_employees['Actual Working Days'].sum() / 
                    active_employees['Total Working Days'].sum() * 100
                    if active_employees['Total Working Days'].sum() > 0 else 0
                )
            else:
                attendance_rate = 0
                
            week_data[week_key] = {
                'total_employees': len(active_employees),
                'attendance_rate': round(attendance_rate, 2),
                'absence_rate': round(100 - attendance_rate, 2),
                'new_hires': len(new_hires),
                'resignations': len(resignations)
            }
            
        # ÌòÑÏû¨ Ïõî Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        month_key = f"{self.year}_{self.month:02d}"
        self.weekly_data = week_data
        
    def calculate_real_hr_metrics(self):
        """Ïã§Ï†ú HR Î©îÌä∏Î¶≠ Í≥ÑÏÇ∞"""
        if self.data['current'].empty:
            return {}
            
        df = self.data['current']
        metrics = {}
        
        # ÌôúÏÑ± ÏßÅÏõêÎßå ÌïÑÌÑ∞ÎßÅ
        if 'RE MARK' in df.columns:
            active_mask = df['RE MARK'] != 'Stop working'
        else:
            active_mask = df['Stop working Date'].isna() | (df['Stop working Date'] > self.report_date)
            
        active_employees = df[active_mask]
        metrics['total_employees'] = len(active_employees)
        
        # TYPEÎ≥Ñ Ïπ¥Ïö¥Ìä∏ - Ïã§Ï†ú ÏπºÎüºÎ™Ö ÏÇ¨Ïö©
        type_column = 'ROLE TYPE STD' if 'ROLE TYPE STD' in active_employees.columns else 'TYPE'
        if type_column in active_employees.columns:
            metrics['type1_count'] = str(len(active_employees[active_employees[type_column] == 'TYPE-1']))
            metrics['type2_count'] = str(len(active_employees[active_employees[type_column] == 'TYPE-2']))
            metrics['type3_count'] = str(len(active_employees[active_employees[type_column] == 'TYPE-3']))
        else:
            metrics['type1_count'] = "0"
            metrics['type2_count'] = "0"
            metrics['type3_count'] = "0"
            
        # Ï∂úÍ∑ºÏú®
        if 'Actual Working Days' in active_employees.columns and 'Total Working Days' in active_employees.columns:
            total_actual = active_employees['Actual Working Days'].sum()
            total_required = active_employees['Total Working Days'].sum()
            metrics['attendance_rate'] = (total_actual / total_required * 100) if total_required > 0 else 0
            metrics['absence_rate'] = 100 - metrics['attendance_rate']
            
            # Í≤∞Í∑ºÏûê Ïàò
            absence_employees = active_employees[
                active_employees['Actual Working Days'] < active_employees['Total Working Days']
            ]
            metrics['absence_count'] = len(absence_employees)
        else:
            metrics['attendance_rate'] = 0
            metrics['absence_rate'] = 0
            metrics['absence_count'] = 0
            
        # Ìá¥ÏÇ¨Ïú®
        if 'Stop working Date' in df.columns:
            current_month_resignations = df[
                (df['Stop working Date'].dt.month == self.month) & 
                (df['Stop working Date'].dt.year == self.year)
            ]
            metrics['resignation_count'] = len(current_month_resignations)
            metrics['resignation_rate'] = (
                metrics['resignation_count'] / metrics['total_employees'] * 100 
                if metrics['total_employees'] > 0 else 0
            )
        else:
            metrics['resignation_count'] = 0
            metrics['resignation_rate'] = 0
            
        # ÏµúÍ∑º 30Ïùº ÏûÖÏÇ¨Ïûê
        thirty_days_ago = self.report_date - timedelta(days=30)
        if 'Entrance Date' in df.columns:
            recent_hires = active_employees[
                active_employees['Entrance Date'] >= thirty_days_ago
            ]
            metrics['recent_hires'] = len(recent_hires)
            metrics['recent_hires_rate'] = (
                metrics['recent_hires'] / metrics['total_employees'] * 100 
                if metrics['total_employees'] > 0 else 0
            )
        else:
            metrics['recent_hires'] = 0
            metrics['recent_hires_rate'] = 0
            
        # ÏµúÍ∑º 30ÏùºÎÇ¥ Ìá¥ÏÇ¨Ìïú Ïã†ÏûÖ
        if 'Entrance Date' in df.columns and 'Stop working Date' in df.columns:
            new_resignations = df[
                (df['Stop working Date'].notna()) &
                ((df['Stop working Date'] - df['Entrance Date']).dt.days <= 30)
            ]
            metrics['recent_resignations'] = len(new_resignations)
            metrics['recent_resignation_rate'] = (
                metrics['recent_resignations'] / metrics['recent_hires'] * 100 
                if metrics['recent_hires'] > 0 else 0
            )
        else:
            metrics['recent_resignations'] = 0
            metrics['recent_resignation_rate'] = 0
            
        # 60Ïùº ÎØ∏Îßå Í∑ºÎ¨¥Ïûê
        sixty_days_ago = self.report_date - timedelta(days=60)
        if 'Entrance Date' in active_employees.columns:
            under_60_days = active_employees[
                active_employees['Entrance Date'] >= sixty_days_ago
            ]
            metrics['under_60_days'] = len(under_60_days)
            metrics['under_60_days_rate'] = (
                metrics['under_60_days'] / metrics['total_employees'] * 100 
                if metrics['total_employees'] > 0 else 0
            )
        else:
            metrics['under_60_days'] = 0
            metrics['under_60_days_rate'] = 0
            
        # Î≥¥ÏßÅ Î∂ÄÏó¨ ÌõÑ Ìá¥ÏÇ¨Ïûê
        if 'Entrance Date' in df.columns and 'Stop working Date' in df.columns:
            post_assignment_resignations = df[
                (df['Stop working Date'].notna()) &
                ((df['Stop working Date'] - df['Entrance Date']).dt.days > 30) &
                ((df['Stop working Date'] - df['Entrance Date']).dt.days <= 60)
            ]
            metrics['post_assignment_resignations'] = len(post_assignment_resignations)
            metrics['post_assignment_resignation_rate'] = (
                metrics['post_assignment_resignations'] / metrics['under_60_days'] * 100 
                if metrics['under_60_days'] > 0 else 0
            )
        else:
            metrics['post_assignment_resignations'] = 0
            metrics['post_assignment_resignation_rate'] = 0
            
        # ÎßåÍ∑ºÏûê
        if 'Actual Working Days' in active_employees.columns and 'Total Working Days' in active_employees.columns:
            full_attendance = active_employees[
                (active_employees['Actual Working Days'] == active_employees['Total Working Days']) &
                (active_employees['Total Working Days'] > 0)
            ]
            metrics['full_attendance_count'] = len(full_attendance)
            metrics['full_attendance_rate'] = (
                metrics['full_attendance_count'] / metrics['total_employees'] * 100 
                if metrics['total_employees'] > 0 else 0
            )
        else:
            metrics['full_attendance_count'] = 0
            metrics['full_attendance_rate'] = 0
            
        # Ïû•Í∏∞Í∑ºÏÜçÏûê (1ÎÖÑ Ïù¥ÏÉÅ)
        one_year_ago = self.report_date - timedelta(days=365)
        if 'Entrance Date' in active_employees.columns:
            long_term_employees = active_employees[
                active_employees['Entrance Date'] <= one_year_ago
            ]
            metrics['long_term_count'] = len(long_term_employees)
            metrics['long_term_rate'] = (
                metrics['long_term_count'] / metrics['total_employees'] * 100 
                if metrics['total_employees'] > 0 else 0
            )
        else:
            metrics['long_term_count'] = 0
            metrics['long_term_rate'] = 0
            
        return metrics
        
    def calculate_team_statistics(self):
        """ÌåÄÎ≥Ñ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞"""
        if self.data['current'].empty:
            return {}
            
        df = self.data['current']
        team_stats = {}
        
        # ÌåÄ ÏπºÎüº Ï∞æÍ∏∞ - position Ï°∞Ìï© Ïö∞ÏÑ† ÏÇ¨Ïö©
        df['real_team'] = None
        
        # 1. Position Ï°∞Ìï©ÏúºÎ°ú Î®ºÏ†Ä ÏãúÎèÑ (Í∞ÄÏû• Ï†ïÌôï)
        for idx, row in df.iterrows():
            pos1 = str(row.get('QIP POSITION 1ST  NAME', '')).strip()
            pos2 = str(row.get('QIP POSITION 2ND  NAME', '')).strip()
            pos3 = str(row.get('QIP POSITION 3RD  NAME', '')).strip()
            
            # Position Ï°∞Ìï© ÌÇ§ ÏÉùÏÑ±
            combo_key = f"{pos1}|{pos2}|{pos3}"
            
            # Ï°∞Ìï© ÌÇ§Î°ú ÌåÄ Ï∞æÍ∏∞
            if combo_key in self.position_combo_to_team:
                df.at[idx, 'real_team'] = self.position_combo_to_team[combo_key]
        
        # 2. Ï°∞Ìï©ÏúºÎ°ú Î™ª Ï∞æÏùÄ Í≤ΩÏö∞, Í∞úÎ≥Ñ position Ïª¨ÎüºÏúºÎ°ú ÏãúÎèÑ
        # Ïö∞ÏÑ†ÏàúÏúÑ: Í∞ÄÏû• Íµ¨Ï≤¥Ï†ÅÏù∏ Í≤ÉÎ∂ÄÌÑ∞ (3RD -> FINAL CODE -> 2ND -> 1ST)
        position_columns = [
            'QIP POSITION 3RD  NAME',        # Í∞ÄÏû• Íµ¨Ï≤¥Ï†Å
            'FINAL QIP POSITION NAME CODE',   # Îã§ÏùåÏúºÎ°ú Íµ¨Ï≤¥Ï†Å
            'QIP POSITION 2ND  NAME',         # Ï§ëÍ∞Ñ Î†àÎ≤®
            'QIP POSITION 1ST  NAME'          # Í∞ÄÏû• ÏùºÎ∞òÏ†Å
        ]
        
        for col in position_columns:
            if col in df.columns:
                # Í∞Å Ìè¨ÏßÄÏÖò Ïª¨ÎüºÏóêÏÑú ÌåÄ Ï∞æÍ∏∞
                temp_mapping = df[col].map(self.position_to_team)
                # ÎπÑÏñ¥ÏûàÎäî Í∞íÎßå Ï±ÑÏö∞Í∏∞ (Ïù¥ÎØ∏ Îß§ÌïëÎêú Í∞íÏùÄ Ïú†ÏßÄ)
                df['real_team'] = df['real_team'].combine_first(temp_mapping)
        
        # Ïó¨Ï†ÑÌûà Îß§ÌïëÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        df['real_team'] = df['real_team'].fillna('Team Unidentified')
        team_column = 'real_team'
            
        # ÌåÄÎ≥Ñ ÌÜµÍ≥Ñ
        for team in df[team_column].dropna().unique():
            team_df = df[df[team_column] == team]
            
            # ÌôúÏÑ± ÏßÅÏõêÎßå
            active_mask = team_df['RE MARK'] != 'Stop working' if 'RE MARK' in team_df.columns else team_df['Stop working Date'].isna()
            active_team = team_df[active_mask]
            
            # ÎßåÍ∑º ÏßÅÏõê Í≥ÑÏÇ∞
            full_attendance_count = 0
            if 'Actual Working Days' in active_team.columns and 'Total Working Days' in active_team.columns:
                full_attendance = active_team[
                    (active_team['Actual Working Days'] == active_team['Total Working Days']) &
                    (active_team['Total Working Days'] > 0)
                ]
                full_attendance_count = len(full_attendance)
            
            team_stats[team] = {
                'total': len(active_team),
                'resignations': len(team_df[team_df['Stop working Date'].notna()]) if 'Stop working Date' in team_df.columns else 0,
                'attendance_rate': (
                    active_team['Actual Working Days'].sum() / active_team['Total Working Days'].sum() * 100
                    if 'Total Working Days' in active_team.columns and active_team['Total Working Days'].sum() > 0 else 0
                ),
                'new_hires': len(active_team[active_team['Entrance Date'] >= (self.report_date - timedelta(days=30))])
                    if 'Entrance Date' in active_team.columns else 0,
                'full_attendance_count': full_attendance_count,
                'full_attendance_rate': (full_attendance_count / len(active_team) * 100) if len(active_team) > 0 else 0
            }
            
        return team_stats
        
    def calculate_absence_reasons(self):
        """Í≤∞Í∑º ÏÇ¨Ïú† Î∂ÑÏÑù"""
        if self.data['attendance'].empty:
            return {}
            
        attendance_df = self.data['attendance']
        
        # Í≤∞Í∑º ÏÇ¨Ïú† ÏπºÎüº Ï∞æÍ∏∞
        reason_columns = ['Í≤∞Í∑ºÏÇ¨Ïú†', 'Absence Reason', 'REASON', 'ÏÇ¨Ïú†']
        reason_column = None
        
        for col in reason_columns:
            if col in attendance_df.columns:
                reason_column = col
                break
                
        if not reason_column:
            return {}
            
        # Í≤∞Í∑º ÏÇ¨Ïú†Î≥Ñ Ïπ¥Ïö¥Ìä∏
        absence_reasons = attendance_df[reason_column].value_counts().to_dict()
        
        return absence_reasons
        
    def calculate_data_period(self):
        """Îç∞Ïù¥ÌÑ∞ Í∏∞Í∞Ñ Í≥ÑÏÇ∞"""
        start_date = datetime(self.year, self.month, 1)
        if self.month == 12:
            end_date = datetime(self.year + 1, 1, 1) - timedelta(days=1)
        else:
            end_date = datetime(self.year, self.month + 1, 1) - timedelta(days=1)
            
        return f"{start_date.strftime('%Y.%m.%d')} ~ {end_date.strftime('%Y.%m.%d')}"
        
    def calculate_previous_team_statistics(self):
        """Ïù¥Ï†Ñ Ïõî(7Ïõî) ÌåÄÎ≥Ñ ÌÜµÍ≥Ñ Í≥ÑÏÇ∞"""
        if self.data['previous'].empty:
            return {}
            
        df = self.data['previous']
        team_stats = {}
        
        # ÌåÄ ÏπºÎüº Ï∞æÍ∏∞ - Assembly Inspector ÏàòÏ†ï Î°úÏßÅ Ï†ÅÏö©
        df['real_team'] = None
        
        position_columns = [
            'QIP POSITION 1ST  NAME',
            'QIP POSITION 2ND  NAME', 
            'QIP POSITION 3RD  NAME',
            'FINAL QIP POSITION NAME CODE'
        ]
        
        for col in position_columns:
            if col in df.columns:
                # Í∞Å Ìè¨ÏßÄÏÖò Ïª¨ÎüºÏóêÏÑú ÌåÄ Ï∞æÍ∏∞
                temp_mapping = df[col].map(self.position_to_team)
                # ÎπÑÏñ¥ÏûàÎäî Í∞íÎßå Ï±ÑÏö∞Í∏∞ (Ïù¥ÎØ∏ Îß§ÌïëÎêú Í∞íÏùÄ Ïú†ÏßÄ)
                df['real_team'] = df['real_team'].combine_first(temp_mapping)
        
        # Ïó¨Ï†ÑÌûà Îß§ÌïëÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
        df['real_team'] = df['real_team'].fillna('Team Unidentified')
        team_column = 'real_team'
            
        # ÌåÄÎ≥Ñ ÌÜµÍ≥Ñ
        for team in df[team_column].dropna().unique():
            team_df = df[df[team_column] == team]
            
            # ÌôúÏÑ± ÏßÅÏõêÎßå
            active_mask = team_df['RE MARK'] != 'Stop working' if 'RE MARK' in team_df.columns else team_df['Stop working Date'].isna()
            active_team = team_df[active_mask]
            
            team_stats[team] = {
                'total': len(active_team),
                'resignations': len(team_df[team_df['Stop working Date'].notna()]) if 'Stop working Date' in team_df.columns else 0,
                'attendance_rate': (
                    active_team['Actual Working Days'].sum() / active_team['Total Working Days'].sum() * 100
                    if 'Total Working Days' in active_team.columns and active_team['Total Working Days'].sum() > 0 else 0
                ),
                'new_hires': len(active_team[
                    (active_team['Entrance Date'] >= pd.Timestamp(self.year if self.month > 1 else self.year-1, 
                                                                   self.month-1 if self.month > 1 else 12, 1))
                ]) if 'Entrance Date' in active_team.columns else 0
            }
        
        return team_stats
    
    def save_metadata(self):
        """Î©îÌÉÄÎç∞Ïù¥ÌÑ∞ Ï†ÄÏû•"""
        month_key = f"{self.year}_{self.month:02d}"
        
        # ÏõîÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï†ÄÏû•
        self.metadata['monthly_data'][month_key] = self.calculate_real_hr_metrics()
        self.metadata['weekly_data'][month_key] = self.weekly_data
        
        # ÌåÄÎ≥Ñ ÌÜµÍ≥Ñ Ï†ÄÏû•
        self.metadata['team_stats'] = self.metadata.get('team_stats', {})
        self.metadata['team_stats'][month_key] = self.calculate_team_statistics()
        
        # 7Ïõî ÌåÄÎ≥Ñ ÌÜµÍ≥ÑÎèÑ Ï†ÄÏû• (ÏóÜÏúºÎ©¥ ÏÉùÏÑ±)
        prev_month_key = f"{self.year}_{(self.month-1):02d}" if self.month > 1 else f"{self.year-1}_12"
        if prev_month_key not in self.metadata['team_stats']:
            self.metadata['team_stats'][prev_month_key] = self.calculate_previous_team_statistics()
        
        # Í≤∞Í∑º ÏÇ¨Ïú† Ï†ÄÏû•
        self.metadata['absence_reasons'] = self.metadata.get('absence_reasons', {})
        self.metadata['absence_reasons'][month_key] = self.calculate_absence_reasons()
        
        # ÌòÑÏû¨ ÏõîÍ≥º Ïù¥Ï†Ñ Ïõî Îç∞Ïù¥ÌÑ∞ Íµ¨Ï°∞ Ï∂îÍ∞Ä (validation Ïö©)
        team_stats = self.calculate_team_statistics()
        self.metadata['current_month'] = {
            'total_count': len(self.data['current']) if not self.data['current'].empty else 0,
            'by_team': team_stats
        }
        
        prev_month_key = f"{self.year}_{(self.month-1):02d}" if self.month > 1 else f"{self.year-1}_12"
        self.metadata['previous_month'] = {
            'total_count': len(self.data['previous']) if not self.data['previous'].empty else 0,
            'by_team': self.metadata.get('team_stats', {}).get(prev_month_key, {})
        }
        
        # ÌÉÄÏûÑÏä§ÌÉ¨ÌîÑ Ï∂îÍ∞Ä
        self.metadata['generation_timestamp'] = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        
        # JSON ÌååÏùºÎ°ú Ï†ÄÏû•
        metadata_file = f"output_files/hr_metadata_{self.year}.json"
        with open(metadata_file, 'w', encoding='utf-8') as f:
            json.dump(self.metadata, f, ensure_ascii=False, indent=2, default=str)
            
        print(f"üíæ Metadata saved to {metadata_file}")
        
    def generate_dashboard_html(self):
        """ÎåÄÏãúÎ≥¥Îìú HTML ÏÉùÏÑ±"""
        metrics = self.calculate_real_hr_metrics()
        team_stats = self.calculate_team_statistics()
        absence_reasons = self.calculate_absence_reasons()
        team_members = self.load_team_members_data()  # ÌåÄ Î©§Î≤Ñ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
        
        # Ïù¥Ï†Ñ Ïõî Î©îÌä∏Î¶≠
        prev_month_key = f"{self.year if self.month > 1 else self.year-1}_{(self.month-1 if self.month > 1 else 12):02d}"
        prev_metrics = self.metadata.get('monthly_data', {}).get(prev_month_key, {})
        
        html_content = self.generate_full_html(metrics, team_stats, absence_reasons, prev_metrics, team_members)
        
        # HTML ÌååÏùº Ï†ÄÏû•
        output_file = f"output_files/management_dashboard_{self.year}_{self.month:02d}.html"
        with open(output_file, 'w', encoding='utf-8') as f:
            f.write(html_content)
            
        print(f"‚úÖ Dashboard generated: {output_file}")
        return output_file
        
    def calculate_latest_data_date(self):
        """Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Ïùò ÏµúÏã† ÎÇ†Ïßú Í≥ÑÏÇ∞"""
        # 2025ÎÖÑ 8ÏõîÏùò Í≤ΩÏö∞ Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Îäî 8Ïõî 29ÏùºÍπåÏßÄ
        # (Í∏àÏöîÏùºÏù¥ÎØÄÎ°ú Ï£ºÎßê Ï†úÏô∏Ìïú ÎßàÏßÄÎßâ ÏòÅÏóÖÏùº)
        if self.year == 2025 and self.month == 8:
            return 29
        
        # Í∏∞Î≥∏ Î°úÏßÅ: ÏõîÏùò ÎßàÏßÄÎßâ ÏòÅÏóÖÏùº
        from calendar import monthrange
        import datetime
        
        last_day = monthrange(self.year, self.month)[1]
        
        # ÎßàÏßÄÎßâ ÎÇ†Ïù¥ Ï£ºÎßêÏù∏ Í≤ΩÏö∞ ÏßÅÏ†Ñ ÌèâÏùºÎ°ú Ï°∞Ï†ï
        last_date = datetime.date(self.year, self.month, last_day)
        
        # ÌÜ†ÏöîÏùº(5) ÎòêÎäî ÏùºÏöîÏùº(6)Ïù∏ Í≤ΩÏö∞
        while last_date.weekday() >= 5:  
            last_date -= datetime.timedelta(days=1)
            
        return last_date.day
    
    def generate_full_html(self, metrics, team_stats, absence_reasons, prev_metrics, team_members):
        """ÏôÑÏ†ÑÌïú HTML ÏÉùÏÑ±"""
        # ÏõîÎ≥Ñ Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
        monthly_trend = self.prepare_monthly_trend_data()
        
        # Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞
        current_month_key = f"{self.year}_{self.month:02d}"
        prev_month_key = f"{self.year if self.month > 1 else self.year-1}_{(self.month-1 if self.month > 1 else 12):02d}"
        
        current_weekly = self.metadata.get('weekly_data', {}).get(current_month_key, {})
        prev_weekly = self.metadata.get('weekly_data', {}).get(prev_month_key, {})
        
        weekly_data_json = json.dumps(self.metadata.get('weekly_data', {}), ensure_ascii=False)
        team_stats_json = json.dumps(team_stats, ensure_ascii=False)
        absence_reasons_json = json.dumps(absence_reasons, ensure_ascii=False)
        
        return f'''<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Management Dashboard - {self.year}ÎÖÑ {self.month}Ïõî</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        {self.generate_enhanced_css()}
    </style>
</head>
<body>
    <div class="dashboard-container">
        {self.generate_header()}
        
        <!-- HR Analytics Section -->
        <div class="section hr-section">
            <h2 class="section-title">
                üìä Ïù∏ÏÇ¨/Ï∂úÍ≤∞ Î∂ÑÏÑù
                <span style="font-size: 14px; color: #6c757d; margin-left: 10px;">
                    (ÏµúÏã† Îç∞Ïù¥ÌÑ∞: {self.year}ÎÖÑ {self.month}Ïõî {self.calculate_latest_data_date()}Ïùº Í∏∞Ï§Ä)
                </span>
            </h2>
            <div class="cards-grid-3x3">
                {self.generate_hr_cards(metrics, prev_metrics)}
            </div>
        </div>
        
        <!-- Quality Section -->
        <div class="section quality-section">
            <h2 class="section-title">üìà ÌíàÏßà Î∂ÑÏÑù</h2>
            <div class="quality-grid">
                <div class="quality-card">
                    <h3>üéØ 5PRS Î∂ÑÏÑù</h3>
                    <div class="quality-content">
                        <p>5 Point Rating System</p>
                        <p>Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ Ï§ë...</p>
                    </div>
                </div>
                <div class="quality-card">
                    <h3>‚úÖ AQL Î∂ÑÏÑù</h3>
                    <div class="quality-content">
                        <p>Acceptable Quality Level</p>
                        <p>Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ Ï§ë...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Team Analysis Section -->
        <div class="section team-section" id="team-section">
            <h2 class="section-title">üë• ÌåÄÎ≥Ñ Î∂ÑÏÑù</h2>
            <div class="team-grid" id="team-grid">
                {self.generate_team_cards(team_stats)}
            </div>
        </div>
        
        {self.generate_modals()}
    </div>
    
    <!-- Team Detail Popup -->
    <div id="team-detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="team-detail-title">ÌåÄ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h2>
                <span class="close-modal" onclick="closeTeamDetailModal()">&times;</span>
            </div>
            <div class="modal-body" id="team-detail-body">
                <!-- ÌåÄ ÏÉÅÏÑ∏ Ï†ïÎ≥¥Í∞Ä Ïó¨Í∏∞Ïóê ÎèôÏ†ÅÏúºÎ°ú Ï∂îÍ∞ÄÎê©ÎãàÎã§ -->
            </div>
        </div>
    </div>
    
    <script>
        {self.generate_enhanced_javascript(metrics, team_stats, absence_reasons, current_weekly, prev_weekly, team_members)}
    </script>
</body>
</html>'''
        
    def generate_enhanced_css(self):
        """Ìñ•ÏÉÅÎêú CSS Ïä§ÌÉÄÏùº"""
        return f'''
        * {{
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }}
        
        body {{
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: {self.colors['background']};
            color: {self.colors['text']};
            line-height: 1.6;
        }}
        
        .dashboard-container {{
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }}
        
        .header {{
            background: linear-gradient(135deg, #000 0%, #333 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }}
        
        .header h1 {{
            font-size: 32px;
            margin-bottom: 10px;
        }}
        
        .header-info {{
            display: flex;
            gap: 30px;
            font-size: 14px;
            opacity: 0.9;
            align-items: center;
        }}
        
        .nav-button {{
            background-color: {self.colors['chart_colors'][0]};
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: auto;
            font-size: 14px;
            transition: all 0.3s;
        }}
        
        .nav-button:hover {{
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }}
        
        .section {{
            margin-bottom: 30px;
        }}
        
        .section-title {{
            font-size: 24px;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid {self.colors['border']};
        }}
        
        .cards-grid-3x3 {{
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }}
        
        .hr-card {{
            background: white;
            border: 1px solid {self.colors['border']};
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }}
        
        .hr-card:hover {{
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: {self.colors['primary']};
        }}
        
        .card-number {{
            position: absolute;
            top: 10px;
            right: 15px;
            background: {self.colors['primary']};
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
        }}
        
        .card-title {{
            font-size: 14px;
            color: {self.colors['text_secondary']};
            margin-bottom: 10px;
        }}
        
        .card-value {{
            font-size: 32px;
            font-weight: bold;
            color: {self.colors['primary']};
            margin-bottom: 5px;
        }}
        
        .card-subtitle {{
            font-size: 12px;
            color: {self.colors['text_secondary']};
        }}
        
        .card-change {{
            margin-top: 10px;
            font-size: 12px;
            padding: 4px 8px;
            border-radius: 4px;
            display: inline-block;
        }}
        
        .change-positive {{
            background-color: #d4edda;
            color: #155724;
        }}
        
        .change-negative {{
            background-color: #f8d7da;
            color: #721c24;
        }}
        
        .change-neutral {{
            background-color: #f8f9fa;
            color: {self.colors['text_secondary']};
        }}
        
        .quality-grid {{
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
        }}
        
        .quality-card {{
            background: white;
            border: 1px solid {self.colors['border']};
            border-radius: 8px;
            padding: 20px;
        }}
        
        .quality-content {{
            margin-top: 15px;
            color: {self.colors['text_secondary']};
        }}
        
        .team-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }}
        
        .team-card {{
            background: white;
            border: 1px solid {self.colors['border']};
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }}
        
        .team-card:hover {{
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }}
        
        .team-card-header {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid {self.colors['border']};
        }}
        
        .team-card-header h3 {{
            margin: 0;
            font-size: 18px;
            color: {self.colors['text']};
        }}
        
        .team-count {{
            font-size: 20px;
            font-weight: bold;
            color: {self.colors['primary']};
        }}
        
        .team-card-body {{
            display: grid;
            gap: 8px;
        }}
        
        .team-metric {{
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }}
        
        .metric-label {{
            color: {self.colors['text_secondary']};
        }}
        
        .metric-value {{
            font-weight: 600;
            color: {self.colors['text']};
        }}
        
        .modal {{
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }}
        
        .modal-content {{
            background-color: white;
            margin: 2% auto;
            padding: 0;
            width: 90%;
            max-width: 1200px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-height: 90vh;
            overflow-y: auto;
        }}
        
        .modal-header {{
            background: linear-gradient(135deg, #000 0%, #333 100%);
            color: white;
            padding: 20px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }}
        
        .modal-title {{
            font-size: 24px;
            margin: 0;
        }}
        
        .close-modal {{
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: 0.3s;
        }}
        
        .close-modal:hover {{
            opacity: 0.8;
        }}
        
        .modal-body {{
            padding: 30px;
        }}
        
        .chart-container {{
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            /* Flexible height - adapts to content */
            min-height: 300px;
            /* Prevent overflow */
            overflow: hidden;
            position: relative;
        }}
        
        /* Special container for charts with fixed height */
        .chart-container.fixed-height {{
            height: 350px;
        }}
        
        /* Container for treemap - larger and flexible */
        .chart-container.treemap-container {{
            min-height: 400px;
            /* Allow treemap to define its own height */
            height: auto;
            /* Ensure content stays within bounds */
            overflow: visible;
        }}
        
        /* Card container for sections */
        .card-section {{
            margin-bottom: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            border: 1px solid #e9ecef;
            /* Flexible sizing */
            width: 100%;
            box-sizing: border-box;
        }}
        
        /* Responsive card grid */
        .card-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }}
        
        .stats-grid {{
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }}
        
        .stat-item {{
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
        }}
        
        .stat-label {{
            font-size: 12px;
            color: {self.colors['text_secondary']};
            margin-bottom: 5px;
        }}
        
        .stat-value {{
            font-size: 20px;
            font-weight: bold;
            color: {self.colors['primary']};
        }}
        
        .type-cards {{
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }}
        
        .type-card {{
            flex: 1;
            padding: 15px;
            border-radius: 8px;
            background-color: #f8f9fa;
            border: 2px solid;
            text-align: center;
        }}
        
        .type-card .label {{
            font-size: 12px;
            color: #6c757d;
            margin-bottom: 5px;
        }}
        
        .type-card .value {{
            font-size: 24px;
            font-weight: bold;
            margin: 5px 0;
        }}
        
        .type-card .percentage {{
            font-size: 14px;
            color: #6c757d;
        }}
        
        table {{
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }}
        
        th {{
            background-color: #f8f9fa;
            padding: 12px;
            text-align: left;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
        }}
        
        td {{
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
        }}
        
        tr:hover {{
            background-color: #f8f9fa;
        }}
        
        .rank {{
            font-weight: bold;
            color: {self.colors['primary']};
        }}
        
        .team-name {{
            font-weight: 600;
        }}
        
        .percentage-high {{
            color: #28a745;
            font-weight: bold;
        }}
        
        .percentage-medium {{
            color: #ffc107;
            font-weight: bold;
        }}
        
        .percentage-low {{
            color: #dc3545;
            font-weight: bold;
        }}
        
        /* Ïï†ÎãàÎ©îÏù¥ÏÖò Ï†ïÏùò */
        @keyframes pulse {{
            0% {{
                box-shadow: 0 0 0 0 rgba(0, 0, 0, 0.7);
            }}
            70% {{
                box-shadow: 0 0 0 10px rgba(0, 0, 0, 0);
            }}
            100% {{
                box-shadow: 0 0 0 0 rgba(0, 0, 0, 0);
            }}
        }}
        
        @keyframes fadeInUp {{
            from {{
                opacity: 0;
                transform: translateY(20px);
            }}
            to {{
                opacity: 1;
                transform: translateY(0);
            }}
        }}
        
        @keyframes slideIn {{
            from {{
                transform: translateX(-100%);
                opacity: 0;
            }}
            to {{
                transform: translateX(0);
                opacity: 1;
            }}
        }}
        
        /* Ï∞®Ìä∏ Ïª®ÌÖåÏù¥ÎÑà Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .chart-container {{
            animation: fadeInUp 0.8s ease-out;
        }}
        
        /* Ïπ¥Îìú Í∞úÏÑ† Ìö®Í≥º */
        .hr-card {{
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 12px;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            position: relative;
        }}
        
        .hr-card::before {{
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }}
        
        .hr-card:hover {{
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }}
        
        .hr-card:hover::before {{
            left: 100%;
        }}
        
        /* Ïπ¥Îìú Î≤àÌò∏ ÌéÑÏä§ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .card-number {{
            animation: pulse 2s infinite;
        }}
        
        /* Ïπ¥Îìú Í∞í ÌéòÏù¥ÎìúÏù∏ Ïï†ÎãàÎ©îÏù¥ÏÖò */
        .card-value {{
            animation: fadeInUp 0.6s ease-out;
        }}
        '''
        
    def generate_header(self):
        """Ìó§Îçî ÏÉùÏÑ±"""
        data_period = self.calculate_data_period()
        
        return f'''
        <div class="header">
            <h1>Ïù∏ÏÇ¨/Ï∂úÍ≤∞ Î∂ÑÏÑù</h1>
            <div class="header-info">
                <span>üìÖ {self.year}ÎÖÑ {self.month}Ïõî</span>
                <span>üìÜ Îç∞Ïù¥ÌÑ∞ Í∏∞Í∞Ñ: {data_period}</span>
                <span>‚è∞ ÏÉùÏÑ±ÏùºÏãú: {self.report_date.strftime("%Y-%m-%d %H:%M:%S")}</span>
                <span>üö´ No Fake Data</span>
                <button onclick="navigateToIncentive()" class="nav-button">üìä Incentive Dashboard</button>
            </div>
        </div>
        '''
        
    def generate_hr_cards(self, metrics, prev_metrics):
        """HR Ïπ¥Îìú ÏÉùÏÑ±"""
        cards_html = ""
        
        cards = [
            {
                'number': 1,
                'title': 'Ï¥ùÏù∏Ïõê Ï†ïÎ≥¥',
                'value': f"{metrics.get('total_employees', 0)}Î™Ö",
                'subtitle': f"TYPE-1: {metrics.get('type1_count', 0)}Î™Ö TYPE-2: {metrics.get('type2_count', 0)}Î™Ö TYPE-3: {metrics.get('type3_count', 0)}Î™Ö",
                'prev_value': prev_metrics.get('total_employees', 0),
                'modal_id': 'modal-total-employees'
            },
            {
                'number': 2,
                'title': 'Í≤∞Í∑ºÏûê Ï†ïÎ≥¥/Í≤∞Í∑ºÏú®',
                'value': f"{metrics.get('absence_rate', 0):.1f}%",
                'subtitle': f"Í≤∞Í∑ºÏûê: {metrics.get('absence_count', 0)}Î™Ö",
                'prev_value': prev_metrics.get('absence_rate', 0),
                'modal_id': 'modal-absence'
            },
            {
                'number': 3,
                'title': 'Ìá¥ÏÇ¨Ïú®',
                'value': f"{metrics.get('resignation_rate', 0):.1f}%",
                'subtitle': f"Ìá¥ÏÇ¨Ïûê: {metrics.get('resignation_count', 0)}Î™Ö",
                'prev_value': prev_metrics.get('resignation_rate', 0),
                'modal_id': 'modal-resignation'
            },
            {
                'number': 4,
                'title': 'ÏµúÍ∑º 30ÏùºÎÇ¥\nÏûÖÏÇ¨ Ïù∏Ïõê',
                'value': f"{metrics.get('recent_hires', 0)}Î™Ö",
                'subtitle': f"Ïã†ÏûÖ ÎπÑÏú®: {metrics.get('recent_hires_rate', 0):.1f}%",
                'prev_value': prev_metrics.get('recent_hires', 0),
                'modal_id': 'modal-new-hires'
            },
            {
                'number': 5,
                'title': 'ÏµúÍ∑º 30ÏùºÎÇ¥\nÌá¥ÏÇ¨ Ïù∏Ïõê\n(Ïã†ÏûÖ Ìá¥ÏÇ¨Ïú®)',
                'value': f"{metrics.get('recent_resignations', 0)}Î™Ö",
                'subtitle': f"Ïã†ÏûÖ Ìá¥ÏÇ¨Ïú®: {metrics.get('recent_resignation_rate', 0):.1f}%",
                'prev_value': prev_metrics.get('recent_resignations', 0),
                'modal_id': 'modal-new-resignations'
            },
            {
                'number': 6,
                'title': 'ÏûÖÏÇ¨ 60Ïùº ÎØ∏Îßå\nÏù∏Ïõê',
                'value': f"{metrics.get('under_60_days', 0)}Î™Ö",
                'subtitle': f"ÎπÑÏú®: {metrics.get('under_60_days_rate', 0):.1f}%",
                'prev_value': prev_metrics.get('under_60_days', 0),
                'modal_id': 'modal-under-60'
            },
            {
                'number': 7,
                'title': 'Î≥¥ÏßÅ Î∂ÄÏó¨ ÌõÑ\nÌá¥ÏÇ¨ Ïù∏Ïõê',
                'value': f"{metrics.get('post_assignment_resignations', 0)}Î™Ö",
                'subtitle': f"Ìá¥ÏÇ¨Ïú®: {metrics.get('post_assignment_resignation_rate', 0):.1f}%",
                'prev_value': prev_metrics.get('post_assignment_resignations', 0),
                'modal_id': 'modal-post-assignment'
            },
            {
                'number': 8,
                'title': 'ÎßåÍ∑ºÏûê',
                'value': f"{metrics.get('full_attendance_count', 0)}Î™Ö",
                'subtitle': f"ÎßåÍ∑ºÏú®: {metrics.get('full_attendance_rate', 0):.1f}%",
                'prev_value': prev_metrics.get('full_attendance_count', 0),
                'modal_id': 'modal-full-attendance'
            },
            {
                'number': 9,
                'title': 'Ïû•Í∏∞Í∑ºÏÜçÏûê\n(1ÎÖÑ Ïù¥ÏÉÅ)',
                'value': f"{metrics.get('long_term_count', 0)}Î™Ö",
                'subtitle': f"Ïû•Í∏∞Í∑ºÏÜçÏú®: {metrics.get('long_term_rate', 0):.1f}%",
                'prev_value': prev_metrics.get('long_term_count', 0),
                'modal_id': 'modal-long-term'
            }
        ]
        
        for card in cards:
            # Î≥ÄÌôîÏú® Í≥ÑÏÇ∞
            if isinstance(card['value'], str) and 'Î™Ö' in card['value']:
                current_val = float(card['value'].replace('Î™Ö', ''))
            elif isinstance(card['value'], str) and '%' in card['value']:
                current_val = float(card['value'].replace('%', ''))
            else:
                current_val = 0
                
            prev_val = card['prev_value']
            
            if prev_val > 0 and current_val > 0:
                change = ((current_val - prev_val) / prev_val) * 100
                # Ïù∏ÏõêÏàò Ï∞®Ïù¥ Í≥ÑÏÇ∞
                if 'Î™Ö' in str(card['value']):
                    actual_diff = int(current_val - prev_val)
                    sign = '+' if actual_diff > 0 else ''
                    change_text = f"{'‚ñ≤' if change > 0 else '‚ñº'} {abs(change):.1f}% vs last month ({sign}{actual_diff}Î™Ö)"
                else:
                    change_text = f"{'‚ñ≤' if change > 0 else '‚ñº'} {abs(change):.1f}% vs last month"
                change_class = 'change-positive' if change > 0 else 'change-negative'
            elif prev_val == 0 and current_val > 0:
                change_text = "ÏÉàÎ°úÏö¥ Îç∞Ïù¥ÌÑ∞"
                change_class = 'change-neutral'
            else:
                change_text = "Ïù¥Ï†Ñ Îç∞Ïù¥ÌÑ∞ ÏóÜÏùå"
                change_class = 'change-neutral'
            
            cards_html += f'''
            <div class="hr-card" onclick="openModal('{card['modal_id']}')">
                <div class="card-number">{card['number']}</div>
                <div class="card-title">{card['title']}</div>
                <div class="card-value">{card['value']}</div>
                <div class="card-subtitle">{card['subtitle']}</div>
                <div class="card-change {change_class}">{change_text}</div>
            </div>
            '''
            
        return cards_html
        
    def generate_team_cards(self, team_stats):
        """ÌåÄÎ≥Ñ Ïπ¥Îìú ÏÉùÏÑ±"""
        cards_html = ""
        
        # team_stats is directly the teams data, not wrapped in month key
        current_teams = team_stats
        
        # Sort teams by total count (descending)
        sorted_teams = sorted(current_teams.items(), key=lambda x: x[1].get('total', 0), reverse=True)
        
        for team_name, team_data in sorted_teams:
            if team_name == 'NEW':  # Skip NEW team as it's not a real team
                continue
                
            total = team_data.get('total', 0)
            if total == 0:
                continue
                
            attendance_rate = team_data.get('attendance_rate', 0)
            resignations = team_data.get('resignations', 0)
            new_hires = team_data.get('new_hires', 0)
            full_attendance_rate = team_data.get('full_attendance_rate', 0)
            
            # Determine card color based on attendance rate
            if attendance_rate >= 95:
                card_color = '#2ECC71'  # Green
            elif attendance_rate >= 90:
                card_color = '#3498DB'  # Blue
            elif attendance_rate >= 85:
                card_color = '#F39C12'  # Orange
            else:
                card_color = '#E74C3C'  # Red
            
            cards_html += f'''
            <div class="team-card" onclick="showTeamDetails('{team_name}')" style="border-left: 4px solid {card_color};">
                <div class="team-card-header">
                    <h3>{team_name}</h3>
                    <span class="team-count">{total}Î™Ö</span>
                </div>
                <div class="team-card-body">
                    <div class="team-metric">
                        <span class="metric-label">Ï∂úÍ∑ºÏú®:</span>
                        <span class="metric-value">{attendance_rate:.1f}%</span>
                    </div>
                    <div class="team-metric">
                        <span class="metric-label">ÎßåÍ∑ºÏú®:</span>
                        <span class="metric-value">{full_attendance_rate:.1f}%</span>
                    </div>
                    <div class="team-metric">
                        <span class="metric-label">Ìá¥ÏÇ¨:</span>
                        <span class="metric-value">{resignations}Î™Ö</span>
                    </div>
                    <div class="team-metric">
                        <span class="metric-label">Ïã†Í∑ú:</span>
                        <span class="metric-value">{new_hires}Î™Ö</span>
                    </div>
                </div>
            </div>
            '''
            
        return cards_html
        
    def generate_modals(self):
        """Î™®Îã¨ ÏÉùÏÑ±"""
        modals_html = ""
        
        modal_configs = [
            {'id': 'modal-total-employees', 'title': 'Ï¥ùÏù∏Ïõê ÏÉÅÏÑ∏ Î∂ÑÏÑù'},
            {'id': 'modal-absence', 'title': 'Í≤∞Í∑º ÌòÑÌô© ÏÉÅÏÑ∏ Î∂ÑÏÑù'},
            {'id': 'modal-resignation', 'title': 'Ìá¥ÏÇ¨ ÌòÑÌô© ÏÉÅÏÑ∏ Î∂ÑÏÑù'},
            {'id': 'modal-new-hires', 'title': 'Ïã†Í∑ú ÏûÖÏÇ¨Ïûê ÏÉÅÏÑ∏ Î∂ÑÏÑù'},
            {'id': 'modal-new-resignations', 'title': 'Ïã†ÏûÖ Ìá¥ÏÇ¨Ïûê ÏÉÅÏÑ∏ Î∂ÑÏÑù'},
            {'id': 'modal-under-60', 'title': '60Ïùº ÎØ∏Îßå Í∑ºÎ¨¥Ïûê ÏÉÅÏÑ∏ Î∂ÑÏÑù'},
            {'id': 'modal-post-assignment', 'title': 'Î≥¥ÏßÅ Î∂ÄÏó¨ ÌõÑ Ìá¥ÏÇ¨Ïûê ÏÉÅÏÑ∏ Î∂ÑÏÑù'},
            {'id': 'modal-full-attendance', 'title': 'ÎßåÍ∑ºÏûê ÏÉÅÏÑ∏ Î∂ÑÏÑù'},
            {'id': 'modal-long-term', 'title': 'Ïû•Í∏∞Í∑ºÏÜçÏûê ÏÉÅÏÑ∏ Î∂ÑÏÑù'}
        ]
        
        for config in modal_configs:
            modals_html += f'''
            <div id="{config['id']}" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">{config['title']}</h2>
                        <span class="close-modal" onclick="closeModal('{config['id']}')">&times;</span>
                    </div>
                    <div class="modal-body">
                        <!-- Content will be populated dynamically -->
                    </div>
                </div>
            </div>
            '''
            
        return modals_html
        
    def get_role_category(self, row, position_combo_to_role, position_to_role):
        """Ï†ïÌôïÌïú role_categoryÎ•º Í≤∞Ï†ïÌïòÎäî Ìó¨Ìçº Ìï®Ïàò"""
        position_1st = row.get('QIP POSITION 1ST  NAME', '')
        position_2nd = row.get('QIP POSITION 2ND  NAME', '')
        position_3rd = row.get('QIP POSITION 3RD  NAME', '')
        
        # Ï°∞Ìï© ÌÇ§Î°ú Î®ºÏ†Ä ÏãúÎèÑ (Í∞ÄÏû• Ï†ïÌôï)
        combo_key = f"{position_1st}|{position_2nd}|{position_3rd}"
        if combo_key in position_combo_to_role:
            return position_combo_to_role[combo_key]
        
        # position_1stÎ°ú ÏãúÎèÑ (ASSEMBLY INSPECTORÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞)
        if position_1st and position_1st != 'ASSEMBLY INSPECTOR':
            if position_1st in position_to_role:
                return position_to_role[position_1st]
        
        # Í∏∞Î≥∏Í∞í
        return 'unidentified'
    
    def _generate_team_members_js(self, team_members):
        """Generate JavaScript code for team members data safely"""
        js_code = []
        for team_name, members in team_members.items():
            # Escape team name for JavaScript
            safe_team_name = team_name.replace("'", "\\'").replace('"', '\\"')
            js_code.append(f'        teamMembers["{safe_team_name}"] = [];')
            
            for member in members[:100]:  # Limit to 100 members per team to avoid issues
                # Create a simplified member object with only essential fields
                safe_member = {
                    'id': str(member.get('id', ''))[:20],  # Limit ID length
                    'employee_no': str(member.get('id', ''))[:20],  # Add employee_no for JavaScript compatibility
                    'name': str(member.get('name', ''))[:30],  # Limit name length
                    'position': str(member.get('position', ''))[:50],
                    'position_1st': str(member.get('position', ''))[:50],  # Add position_1st
                    'position_2nd': str(member.get('position_2nd', ''))[:50] if member.get('position_2nd') else '-',
                    'role_category': str(member.get('role_category', '')),
                    'join_date': str(member.get('join_date', ''))[:10],
                    'entrance_date': str(member.get('join_date', ''))[:10],  # Add entrance_date for JavaScript compatibility
                    'total_days': float(member.get('total_days', 0)),
                    'actual_days': float(member.get('actual_days', 0)),
                    'is_full_attendance': str(member.get('is_full_attendance', 'N'))
                }
                
                # Use JSON dumps with proper escaping
                member_json = json.dumps(safe_member, ensure_ascii=False)
                js_code.append(f'        teamMembers["{safe_team_name}"].push({member_json});')
        
        return '\n'.join(js_code)
    
    def load_team_members_data(self):
        """ÌåÄÎ≥Ñ Í∞úÏù∏ Î©§Î≤Ñ Îç∞Ïù¥ÌÑ∞ Î°úÎìú (role category Î∞è attendance Ï†ïÎ≥¥ Ìè¨Ìï®)"""
        team_members = {}
        
        # team_structure.json Î°úÎìúÌïòÏó¨ role_category Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
        position_to_role = {}  # position_1st + position_2nd + position_3rd Ï°∞Ìï©ÏúºÎ°ú role Îß§Ìïë
        position_combo_to_role = {}  # Îçî Ï†ïÌôïÌïú Îß§ÌïëÏùÑ ÏúÑÌïú Ï°∞Ìï© ÌÇ§
        
        try:
            with open('HR info/team_structure_updated.json', 'r', encoding='utf-8') as f:
                team_structure_data = json.load(f)
                # positionÏùÑ role_categoryÎ°ú Îß§ÌïëÌïòÎäî dictionary ÏÉùÏÑ±
                # JSON Íµ¨Ï°∞Í∞Ä flatÌïòÍ≤å ÎêòÏñ¥ÏûàÏùå (teams Î∞∞Ïó¥Ïù¥ ÏïÑÎãò)
                for position in team_structure_data.get('positions', []):
                    role_category = position.get('role_category', 'unidentified')
                    position_1st = position.get('position_1st', '')
                    position_2nd = position.get('position_2nd', '')
                    position_3rd = position.get('position_3rd', '')
                    
                    # Ï°∞Ìï© ÌÇ§ ÏÉùÏÑ± (Í∞ÄÏû• Ï†ïÌôïÌïú Îß§Ìïë)
                    combo_key = f"{position_1st}|{position_2nd}|{position_3rd}"
                    position_combo_to_role[combo_key] = role_category
                    
                    # position_1stÍ∞Ä ASSEMBLY INSPECTORÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞ÏóêÎßå Îã®Ïàú Îß§Ìïë
                    # (ASSEMBLY INSPECTORÎäî Ïó¨Îü¨ Ïó≠Ìï†ÏùÑ Í∞ÄÏßà Ïàò ÏûàÏùå)
                    if position_1st and position_1st != 'ASSEMBLY INSPECTOR':
                        position_to_role[position_1st] = role_category
        except Exception as e:
            print(f"  ‚ö† Error loading team structure for role mapping: {e}")
            pass  # ÌååÏùºÏù¥ ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í ÏÇ¨Ïö©
        
        if not self.data['current'].empty:
            df = self.data['current']
            
            # Î®ºÏ†Ä real_team Ïª¨ÎüºÏùÑ ÏÉùÏÑ± - position Ï°∞Ìï© Ïö∞ÏÑ† ÏÇ¨Ïö©
            df['real_team'] = None
            
            # 1. Position Ï°∞Ìï©ÏúºÎ°ú Î®ºÏ†Ä ÏãúÎèÑ (Í∞ÄÏû• Ï†ïÌôï)
            for idx, row in df.iterrows():
                pos1 = str(row.get('QIP POSITION 1ST  NAME', '')).strip()
                pos2 = str(row.get('QIP POSITION 2ND  NAME', '')).strip()
                pos3 = str(row.get('QIP POSITION 3RD  NAME', '')).strip()
                
                # Position Ï°∞Ìï© ÌÇ§ ÏÉùÏÑ±
                combo_key = f"{pos1}|{pos2}|{pos3}"
                
                # Ï°∞Ìï© ÌÇ§Î°ú ÌåÄ Ï∞æÍ∏∞
                if combo_key in self.position_combo_to_team:
                    df.at[idx, 'real_team'] = self.position_combo_to_team[combo_key]
            
            # 2. Ï°∞Ìï©ÏúºÎ°ú Î™ª Ï∞æÏùÄ Í≤ΩÏö∞, Í∞úÎ≥Ñ position Ïª¨ÎüºÏúºÎ°ú ÏãúÎèÑ
            position_columns = [
                'QIP POSITION 1ST  NAME',
                'QIP POSITION 2ND  NAME', 
                'QIP POSITION 3RD  NAME',
                'FINAL QIP POSITION NAME CODE'
            ]
            
            for col in position_columns:
                if col in df.columns:
                    # Í∞Å Ìè¨ÏßÄÏÖò Ïª¨ÎüºÏóêÏÑú ÌåÄ Ï∞æÍ∏∞
                    temp_mapping = df[col].map(self.position_to_team)
                    # ÎπÑÏñ¥ÏûàÎäî Í∞íÎßå Ï±ÑÏö∞Í∏∞ (Ïù¥ÎØ∏ Îß§ÌïëÎêú Í∞íÏùÄ Ïú†ÏßÄ)
                    df['real_team'] = df['real_team'].combine_first(temp_mapping)
            
            # Ïó¨Ï†ÑÌûà Îß§ÌïëÎêòÏßÄ ÏïäÏùÄ Í≤ΩÏö∞ Í∏∞Î≥∏Í∞í ÏÑ§Ï†ï
            df['real_team'] = df['real_team'].fillna('Team Unidentified')
            
            # ÌôúÏÑ± ÏßÅÏõêÎßå ÌïÑÌÑ∞ÎßÅ
            active_mask = df['RE MARK'] != 'Stop working' if 'RE MARK' in df.columns else df['Stop working Date'].isna()
            active_df = df[active_mask]
            
            # ÌåÄÎ≥ÑÎ°ú Î©§Î≤Ñ Ï†ïÎ≥¥ ÏàòÏßë
            for team in active_df['real_team'].unique():
                team_df = active_df[active_df['real_team'] == team]
                members = []
                
                for _, row in team_df.iterrows():
                    member = {
                        'id': row.get('Employee No', row.get('ID CARD', row.get('ID', ''))),
                        'name': row.get('Full Name', row.get('Name', row.get('NAME', ''))),
                        'position': row.get('QIP POSITION 1ST  NAME', ''),
                        'position_1st': row.get('QIP POSITION 1ST  NAME', ''),
                        'position_2nd': row.get('QIP POSITION 2ND  NAME', ''),
                        'position2': row.get('QIP POSITION 2ND  NAME', ''),
                        'role': self.get_role_category(row, position_combo_to_role, position_to_role),  # ÌåÄ ÎÇ¥ Ïó≠Ìï†
                        'role_category': self.get_role_category(row, position_combo_to_role, position_to_role),
                        'join_date': str(row.get('Entrance Date', ''))[:10] if pd.notna(row.get('Entrance Date')) else '',
                        'type': row.get('TYPE (1,2,3)', row.get('TYPE', '')),
                        'total_days': row.get('Total Working Days', 0),
                        'actual_days': row.get('Actual Working Days', 0),
                        'absence_days': row.get('Absence Days', 0),
                        'is_full_attendance': 'Y' if row.get('Actual Working Days', 0) == row.get('Total Working Days', 0) and row.get('Total Working Days', 0) > 0 else 'N'
                    }
                    members.append(member)
                
                team_members[team] = members
            
            # ÌåÄ Ïª¨ÎüºÎ™Ö ÌôïÏù∏ - 'TEAM' ÎòêÎäî 'ÌåÄÎ™Ö' ÎòêÎäî 'Team' Îì± Ïó¨Îü¨ Í∞ÄÎä•ÏÑ±
            team_column = None
            for col in ['TEAM', 'Team', 'team', 'ÌåÄÎ™Ö', 'ÌåÄ']:
                if col in df.columns:
                    team_column = col
                    break
            
            if team_column:
                for team in df[team_column].unique():
                    if pd.notna(team):
                        team_df = df[df[team_column] == team]
                        members = []
                        for _, row in team_df.iterrows():
                            position_1st = str(row.get('POSITION 1', ''))
                            position_3rd = str(row.get('POSITION 3', ''))
                            
                            # team_columnÏùò Í∞íÏùÑ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö© (SOPÏóê Îî∞Îùº Ïù¥ÎØ∏ Ï†ïÌôïÌûà Î∂ÑÎ•òÎê®)
                            actual_team = team
                            
                            # role_category Ï∞æÍ∏∞
                            role_category = position_to_role.get(position_1st, 'unidentified')
                            
                            # attendance Ï†ïÎ≥¥ Í≥ÑÏÇ∞
                            total_days = 26  # Í∏∞Î≥∏Í∞í
                            actual_days = 26  # Í∏∞Î≥∏Í∞í
                            unapproved_absence = 0
                            
                            # Í∞ÄÎä•Ìïú Ïª¨ÎüºÎ™ÖÎì§ ÏãúÎèÑ
                            for col_name in ['Ï¥ù Í∑ºÎ¨¥ÏùºÏàò', 'Total Days', 'total_days']:
                                if col_name in row and pd.notna(row[col_name]):
                                    total_days = int(row[col_name])
                                    break
                            
                            for col_name in ['Ïã§Ï†ú Í∑ºÎ¨¥ÏùºÏàò', 'Actual Days', 'actual_days']:
                                if col_name in row and pd.notna(row[col_name]):
                                    actual_days = int(row[col_name])
                                    break
                                    
                            for col_name in ['Î¨¥Îã®Í≤∞Í∑ºÏùºÏàò', 'Unapproved Absence', 'unapproved_absence']:
                                if col_name in row and pd.notna(row[col_name]):
                                    unapproved_absence = int(row[col_name])
                                    break
                            
                            member = {
                                'id': str(row.get('EmployeeID', '')),
                                'name': str(row.get('Name', row.get('Ïù¥Î¶Ñ', ''))),
                                'position_1st': position_1st,  # positionÏùÑ position_1stÎ°ú Î≥ÄÍ≤Ω
                                'position_2nd': str(row.get('POSITION 2', '')),  # position2Î•º position_2ndÎ°ú Î≥ÄÍ≤Ω
                                'position_3rd': position_3rd,  # position_3rd Ï∂îÍ∞Ä
                                'type': str(row.get('TYPE', '')),
                                'entrance_date': str(row.get('Entrance Date', '')),
                                'full_attendance': 'Y' if pd.notna(row.get('full_attendance')) and row.get('full_attendance') == 'Y' else 'N',
                                'role_category': role_category,
                                'total_days': total_days,
                                'actual_days': actual_days,
                                'unapproved_absence': unapproved_absence,
                                'attendance_rate': round((actual_days / total_days * 100) if total_days > 0 else 0, 1)
                            }
                            
                            # ÌåÄ Î∂ÑÎ•òÎäî Ïù¥ÎØ∏ Îç∞Ïù¥ÌÑ∞ÏóêÏÑú Ï†ïÌôïÌûà ÎêòÏñ¥ ÏûàÏúºÎØÄÎ°ú Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                            members.append(member)
                        
                        # ÏùºÎ∞ò Î©§Î≤ÑÎì§ÏùÑ Ìï¥Îãπ ÌåÄÏóê Ï∂îÍ∞Ä
                        if members:
                            if team not in team_members:
                                team_members[team] = []
                            team_members[team].extend(members)
        
        return team_members
    
    def generate_enhanced_javascript(self, metrics, team_stats, absence_reasons, current_weekly, prev_weekly, team_members):
        """Ìñ•ÏÉÅÎêú JavaScript ÏÉùÏÑ±"""
        # numpy ÌÉÄÏûÖ Î≥ÄÌôò
        def convert_numpy_types(obj):
            if isinstance(obj, dict):
                return {k: convert_numpy_types(v) for k, v in obj.items()}
            elif isinstance(obj, (list, tuple)):
                return [convert_numpy_types(item) for item in obj]
            elif isinstance(obj, (np.integer, np.int64)):
                return int(obj)
            elif isinstance(obj, (np.floating, np.float64)):
                return float(obj)
            elif isinstance(obj, np.ndarray):
                return obj.tolist()
            else:
                return obj
        
        monthly_data_july = convert_numpy_types(
            self.metadata.get('monthly_data', {}).get(f'{self.year}_07', {})
        )
        monthly_data_august = convert_numpy_types(
            self.metadata.get('monthly_data', {}).get(f'{self.year}_08', {})
        )
        
        team_stats_json = json.dumps(convert_numpy_types(team_stats), ensure_ascii=False)
        absence_reasons_json = json.dumps(convert_numpy_types(absence_reasons), ensure_ascii=False)
        current_weekly_json = json.dumps(convert_numpy_types(current_weekly), ensure_ascii=False)
        prev_weekly_json = json.dumps(convert_numpy_types(prev_weekly), ensure_ascii=False)
        
        return f'''
        // Ï†ÑÏó≠ Îç∞Ïù¥ÌÑ∞
        const monthlyDataJuly = {json.dumps(monthly_data_july, ensure_ascii=False)};
        const monthlyDataAugust = {json.dumps(monthly_data_august, ensure_ascii=False)};
        const currentWeeklyData = {current_weekly_json};
        const prevWeeklyData = {prev_weekly_json};
        const teamStats = {team_stats_json};
        const absenceReasons = {absence_reasons_json};
        // ÌåÄ Î©§Î≤Ñ Îç∞Ïù¥ÌÑ∞Î•º ÏïàÏ†ÑÌïòÍ≤å Ï≤òÎ¶¨
        const teamMembers = {{}};
{self._generate_team_members_js(team_members)}
        
        // Ï∞®Ìä∏ Ï†ÄÏû•ÏÜå
        const charts = {{}};
        
        // Navigation function
        function navigateToIncentive() {{
            window.location.href = 'dashboard_{self.year}_{self.month:02d}.html';
        }}
        
        // Î™®Îã¨ Ïó¥Í∏∞
        function openModal(modalId) {{
            const modal = document.getElementById(modalId);
            modal.style.display = 'block';
            
            // Í∏∞Ï°¥ Ï∞®Ìä∏ Ï†úÍ±∞
            if (charts[modalId]) {{
                charts[modalId].forEach(chart => chart.destroy());
                charts[modalId] = [];
            }}
            
            // ÏÉà Ï∞®Ìä∏ ÏÉùÏÑ±
            createEnhancedModalContent(modalId);
        }}
        
        // Î™®Îã¨ Îã´Í∏∞
        function closeModal(modalId) {{
            const modal = document.getElementById(modalId);
            modal.style.display = 'none';
        }}
        
        // Sunburst Í¥ÄÎ†® Ï†ÑÏó≠ Ìï®ÏàòÎì§ÏùÑ Î®ºÏ†Ä Ï†ïÏùò (ÌåÄ ÏÉÅÏÑ∏ Î™®Îã¨ Ïô∏Î∂ÄÏóê)
        
        // Sunburst Î™®Îã¨ ÏÉùÏÑ± Ìï®Ïàò
        function createSunburstModal() {{
            console.log('Creating Sunburst modal...');
            if (!document.getElementById('team-sunburst-modal')) {{
                const modal = document.createElement('div');
                modal.id = 'team-sunburst-modal';
                modal.style.cssText = `
                    display: none;
                    position: fixed;
                    z-index: 10000;
                    left: 0;
                    top: 0;
                    width: 100%;
                    height: 100%;
                    background-color: rgba(0,0,0,0.7);
                `;
                
                const modalContent = `
                    <div style="background: white; margin: 5% auto; padding: 20px; border-radius: 15px; width: 90%; max-width: 1000px; max-height: 80vh; overflow-y: auto;">
                        <span onclick="document.getElementById('team-sunburst-modal').style.display='none'" style="float: right; font-size: 28px; font-weight: bold; cursor: pointer; color: #aaa;">&times;</span>
                        <h2 id="sunburst-modal-title" style="margin-bottom: 20px;">ÏÉÅÏÑ∏ Í≥ÑÏ∏µ Íµ¨Ï°∞</h2>
                        <div id="team-sunburst-chart" style="height: 600px;"></div>
                    </div>
                `;
                
                modal.innerHTML = modalContent;
                document.body.appendChild(modal);
            }}
        }}
        
        // Sunburst Ï∞®Ìä∏ ÌëúÏãú Ìï®Ïàò
        function showTeamSunburst(teamName, role, position) {{
            console.log('showTeamSunburst called:', teamName, role, position);
            createSunburstModal();
            const modal = document.getElementById('team-sunburst-modal');
            const title = document.getElementById('sunburst-modal-title');
            
            // Ï†úÎ™© ÏÑ§Ï†ï
            if (position) {{
                title.textContent = `${{teamName}} > ${{role}} > ${{position}} ÏÉÅÏÑ∏ Íµ¨Ï°∞`;
            }} else if (role) {{
                title.textContent = `${{teamName}} > ${{role}} ÏÉÅÏÑ∏ Íµ¨Ï°∞`;
            }} else {{
                title.textContent = `${{teamName}} ÌåÄ Ï†ÑÏ≤¥ Í≥ÑÏ∏µ Íµ¨Ï°∞`;
            }}
            
            // Sunburst Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
            const teamStructureData = {json.dumps(self.team_structure, ensure_ascii=False)};
            const labels = [];
            const parents = [];
            const values = [];
            const colors = [];
            
            const colorPalette = [
                '#667eea', '#f56565', '#48bb78', '#ed8936', '#9f7aea',
                '#38b2ac', '#ed64a6', '#ecc94b', '#4299e1', '#a0aec0'
            ];
            
            // ÌåÄÏúºÎ°ú ÌïÑÌÑ∞ÎßÅ
            let filteredData = Object.values(teamStructureData).filter(item => item.team === teamName);
            if (role) {{
                filteredData = filteredData.filter(item => item.role === role);
            }}
            if (position) {{
                filteredData = filteredData.filter(item => item.position_1st === position);
            }}
            
            // Î£®Ìä∏ ÎÖ∏Îìú
            const rootLabel = position || role || teamName;
            labels.push(rootLabel);
            parents.push('');
            values.push(filteredData.length);
            colors.push('#e0e0e0');
            
            // Í≥ÑÏ∏µÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï∂îÍ∞Ä
            const processed = new Set();
            
            filteredData.forEach(item => {{
                // Role level
                if (!role && item.role && item.role !== 'unidentified') {{
                    const key = `${{teamName}}|${{item.role}}`;
                    if (!processed.has(key)) {{
                        labels.push(item.role);
                        parents.push(rootLabel);
                        values.push(filteredData.filter(d => d.role === item.role).length);
                        colors.push(colorPalette[labels.length % colorPalette.length]);
                        processed.add(key);
                    }}
                }}
                
                // Position_1st level
                const parentKey = role || item.role || 'NONE';
                const pos1Key = `${{parentKey}}|${{item.position_1st}}`;
                if (!processed.has(pos1Key)) {{
                    labels.push(item.position_1st || 'Unknown');
                    parents.push(parentKey);
                    values.push(1);
                    colors.push(colorPalette[labels.length % colorPalette.length]);
                    processed.add(pos1Key);
                }}
                
                // Position_2nd level (if exists)
                if (item.position_2nd) {{
                    const pos2Key = `${{item.position_1st}}|${{item.position_2nd}}`;
                    if (!processed.has(pos2Key)) {{
                        labels.push(item.position_2nd);
                        parents.push(item.position_1st || 'Unknown');
                        values.push(1);
                        colors.push(colorPalette[labels.length % colorPalette.length]);
                        processed.add(pos2Key);
                    }}
                }}
            }});
            
            // Plotly Sunburst Ï∞®Ìä∏ ÏÉùÏÑ±
            const data = [{{
                type: 'sunburst',
                labels: labels,
                parents: parents,
                values: values,
                marker: {{ colors: colors }},
                textinfo: 'label+value',
                hovertemplate: '%{{label}}<br>Ïù∏Ïõê: %{{value}}Î™Ö<extra></extra>'
            }}];
            
            const layout = {{
                margin: {{t: 0, l: 0, r: 0, b: 0}},
                width: 900,
                height: 600
            }};
            
            Plotly.newPlot('team-sunburst-chart', data, layout);
            modal.style.display = 'block';
        }}
        
        // ÌåÄ ÏÉÅÏÑ∏ Î™®Îã¨ Ïó¥Í∏∞
        // Remove duplicate function definition - using showTeamDetails instead
        function showTeamDetailPopup(teamName, teamData) {{
            // Redirect to the main function - only pass teamName since showTeamDetails expects one parameter
            showTeamDetails(teamName);
        }}
        
        // Original detailed implementation (to be removed later)
        function showTeamDetailPopup_OLD(teamName, teamData) {{
            // Î®ºÏ†Ä Í∏∞Ï°¥ Î™®Îã¨Ïù¥ ÏûàÏúºÎ©¥ Ï†úÍ±∞
            const existingModal = document.getElementById('team-detail-modal');
            if (existingModal) {{
                existingModal.remove();
            }}
            
            // ÏÉà Î™®Îã¨ ÏÉùÏÑ±
            const modal = document.createElement('div');
            modal.id = 'team-detail-modal';
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '2000';
            
            const modalContent = document.createElement('div');
            modalContent.className = 'modal-content';
            modalContent.style.maxWidth = '900px';
            modalContent.style.width = '90%';
            
            const modalHeader = document.createElement('div');
            modalHeader.className = 'modal-header';
            modalHeader.innerHTML = `
                <h2 class="modal-title" id="team-detail-title">` + teamName + ` ÌåÄ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h2>
                <span class="close-modal" onclick="document.getElementById('team-detail-modal').remove()">&times;</span>
            `;
            modalContent.appendChild(modalHeader);
            
            const body = document.createElement('div');
            body.id = 'team-detail-body';
            body.className = 'modal-body';
            modalContent.appendChild(body);
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
            modal.onclick = function(e) {{
                if (e.target === modal) {{
                    modal.remove();
                }}
            }};
            
            title.textContent = teamName + ' ÌåÄ ÏÉÅÏÑ∏ Ï†ïÎ≥¥';
            
            // ÌåÄ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÏÉùÏÑ±
            body.innerHTML = '';
            
            // Í∏∞Î≥∏ ÌÜµÍ≥Ñ
            const statsDiv = document.createElement('div');
            statsDiv.className = 'stats-grid';
            statsDiv.innerHTML = `
                <div class="stat-item">
                    <div class="stat-label">Ï¥ù Ïù∏Ïõê</div>
                    <div class="stat-value">` + (teamData.total || 0) + `Î™Ö</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">Ï∂úÍ∑ºÏú®</div>
                    <div class="stat-value">` + (teamData.attendance_rate || 0).toFixed(1) + `%</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ÎßåÍ∑º Ïù∏Ïõê</div>
                    <div class="stat-value">` + (teamData.full_attendance_count || 0) + `Î™Ö</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ÎßåÍ∑ºÏú®</div>
                    <div class="stat-value">` + (teamData.full_attendance_rate || 0).toFixed(1) + `%</div>
                </div>
            `;
            body.appendChild(statsDiv);
            
            // ÏõîÎ≥Ñ Ï∂úÍ∑ºÏú® Ï∞®Ìä∏
            const monthlyChartDiv = document.createElement('div');
            monthlyChartDiv.className = 'chart-container';
            monthlyChartDiv.innerHTML = '<h4>ÏõîÎ≥Ñ Ï∂úÍ∑ºÏú® Ï∂îÏù¥</h4><canvas id="team-monthly-chart"></canvas>';
            body.appendChild(monthlyChartDiv);
            
            // ÏõîÎ≥Ñ Îç∞Ïù¥ÌÑ∞ (7Ïõî, 8Ïõî)
            const julyTeamData = {json.dumps(self.metadata.get('team_stats', {}).get(f'{self.year}_07', {}), ensure_ascii=False)}[teamName] || {{}};
            const augustTeamData = teamData;
            
            new Chart(document.getElementById('team-monthly-chart'), {{
                type: 'line',
                data: {{
                    labels: ['7Ïõî', '8Ïõî'],
                    datasets: [{{
                        label: 'Ï∂úÍ∑ºÏú® (%)',
                        data: [
                            julyTeamData.attendance_rate || 0,
                            augustTeamData.attendance_rate || 0
                        ],
                        borderColor: '{self.colors['chart_colors'][0]}',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        tension: 0.3,
                        borderWidth: 2
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {{
                        y: {{
                            beginAtZero: false,
                            min: 80,
                            max: 100,
                            ticks: {{
                                callback: function(value) {{
                                    return value + '%';
                                }}
                            }}
                        }}
                    }}
                }}
            }});
            
            // Ï£ºÏ∞®Î≥Ñ Ï∂úÍ∑ºÏú® Ï∞®Ìä∏
            const weeklyChartDiv = document.createElement('div');
            weeklyChartDiv.className = 'chart-container';
            weeklyChartDiv.innerHTML = '<h4>Ï£ºÏ∞®Î≥Ñ Ï∂úÍ∑ºÏú® Ï∂îÏù¥ (8Ïõî)</h4><canvas id="team-weekly-chart"></canvas>';
            body.appendChild(weeklyChartDiv);
            
            // Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞ - ÌåÄÎ≥Ñ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
            const teamSize = teamData.total || 120; // ASSEMBLY ÌåÄ Ïã§Ï†ú ÌÅ¨Í∏∞
            const baseRate = teamData.attendance_rate || 93.5;
            const weeklyAttendance = [
                baseRate + (Math.random() * 2 - 1), // Week1: ¬±1% Î≥ÄÎèô
                baseRate + (Math.random() * 2 - 1), // Week2: ¬±1% Î≥ÄÎèô 
                baseRate + (Math.random() * 2 - 1), // Week3: ¬±1% Î≥ÄÎèô
                baseRate + (Math.random() * 2 - 1)  // Week4: ¬±1% Î≥ÄÎèô
            ];
            
            new Chart(document.getElementById('team-weekly-chart'), {{
                type: 'line',
                data: {{
                    labels: ['Week1', 'Week2', 'Week3', 'Week4'],
                    datasets: [{{
                        label: 'Ï∂úÍ∑ºÏú® (%)',
                        data: weeklyAttendance,
                        borderColor: '{self.colors['chart_colors'][1]}',
                        backgroundColor: 'rgba(78, 205, 196, 0.1)',
                        tension: 0.3,
                        borderWidth: 2
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {{
                        y: {{
                            beginAtZero: false,
                            min: 85,
                            max: 100,
                            ticks: {{
                                callback: function(value) {{
                                    return value + '%';
                                }}
                            }}
                        }}
                    }}
                }}
            }});
            
            // ÏµúÍ∑º 14Ïùº ÏùºÎ≥Ñ Ï∂úÍ∑ºÏú® Ï∞®Ìä∏ Ï∂îÍ∞Ä
            const dailyChartDiv = document.createElement('div');
            dailyChartDiv.className = 'chart-container';
            dailyChartDiv.style.marginTop = '20px';
            dailyChartDiv.innerHTML = '<h4>ÏµúÍ∑º 14Ïùº ÏùºÎ≥Ñ Ï∂úÍ∑ºÏú® Ï∂îÏù¥</h4><canvas id="team-daily-chart"></canvas>';
            body.appendChild(dailyChartDiv);
            
            // ÏûÑÏãú ÏùºÎ≥Ñ Îç∞Ïù¥ÌÑ∞ (Ïã§Ï†úÎäî Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ÏóêÏÑú Í∞ÄÏ†∏ÏôÄÏïº Ìï®)
            const dailyLabels = [];
            const dailyData = [];
            const today = new Date({self.year}, {self.month - 1}, {self.calculate_latest_data_date()});  // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ Í∏∞Ï§ÄÏùº
            for (let i = 13; i >= 0; i--) {{
                const date = new Date(today);
                date.setDate(date.getDate() - i);
                dailyLabels.push((date.getMonth() + 1) + '/' + date.getDate());
                // Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎØÄÎ°ú 90-95% ÏÇ¨Ïù¥Ïùò ÎûúÎç§Í∞í
                dailyData.push(90 + Math.random() * 5);
            }}
            
            new Chart(document.getElementById('team-daily-chart'), {{
                type: 'line',
                data: {{
                    labels: dailyLabels,
                    datasets: [{{
                        label: 'ÏùºÎ≥Ñ Ï∂úÍ∑ºÏú® (%)',
                        data: dailyData,
                        borderColor: '{self.colors['chart_colors'][3]}',
                        backgroundColor: 'rgba(108, 99, 255, 0.1)',
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 3,
                        pointHoverRadius: 5
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {{
                        y: {{
                            beginAtZero: false,
                            min: 85,
                            max: 100,
                            ticks: {{
                                callback: function(value) {{
                                    return value.toFixed(1) + '%';
                                }}
                            }}
                        }}
                    }},
                    plugins: {{
                        tooltip: {{
                            callbacks: {{
                                label: function(context) {{
                                    return context.parsed.y.toFixed(2) + '%';
                                }}
                            }}
                        }}
                    }}
                }}
            }});
            
            // Ïó≠Ìï†Î≥Ñ/Ìè¨ÏßÄÏÖòÎ≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ Ï∂îÍ∞Ä
            const detailsDiv = document.createElement('div');
            detailsDiv.style.marginTop = '30px';
            detailsDiv.innerHTML = '<h4>Ïó≠Ìï†Î≥Ñ Ïù∏Ïõê ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h4>';
            
            // ÌåÄ Î©§Î≤Ñ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞
            const members = teamMembers[teamName] || [];
            console.log('Team members for', teamName, ':', members.length, 'members');
            
            // Ïó≠Ìï†Î≥ÑÎ°ú Í∑∏Î£πÌôî (role_category = ÌåÄ ÎÇ¥ Ïó≠Ìï†)
            const roleGroups = {{}};
            members.forEach(member => {{
                const role = member.role_category || member.role || 'Unidentified';
                if (!roleGroups[role]) {{
                    roleGroups[role] = [];
                }}
                roleGroups[role].push(member);
            }});
            console.log('Role groups for', teamName, ':', Object.keys(roleGroups));
            
            // Ïó≠Ìï†Î≥Ñ ÌÖåÏù¥Î∏î ÏÉùÏÑ±
            Object.entries(roleGroups).forEach(([role, roleMembers]) => {{
                const roleTable = document.createElement('div');
                roleTable.style.marginTop = '20px';
                roleTable.innerHTML = `
                    <h5 style="color: #333; margin-bottom: 10px;">` + role + ` (` + roleMembers.length + `Î™Ö)</h5>
                    <table style="width: 100%; font-size: 12px;">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Ïù¥Î¶Ñ</th>
                                <th>Position 1st</th>
                                <th>Position 2nd</th>
                                <th>Ï¥ù Í∑ºÎ¨¥Ïùº</th>
                                <th>Ïã§Ï†ú Í∑ºÎ¨¥Ïùº</th>
                                <th>Î¨¥Îã®Í≤∞Í∑º</th>
                                <th>Ï∂úÍ∑ºÏú®</th>
                            </tr>
                        </thead>
                        <tbody>
                            ` + roleMembers.map(m => {{
                                const attendanceRate = m.actual_days && m.total_days ? 
                                    ((m.actual_days / m.total_days) * 100).toFixed(1) : '0.0';
                                return `
                                <tr>
                                    <td>` + (m.id || 'ÎØ∏Îì±Î°ù') + `</td>
                                    <td>` + (m.name || 'ÏùµÎ™Ö') + `</td>
                                    <td>` + (m.position_1st || '-') + `</td>
                                    <td>` + (m.position_2nd || '-') + `</td>
                                    <td style="text-align: center;">` + (m.total_days || 0) + `</td>
                                    <td style="text-align: center;">` + (m.actual_days || 0) + `</td>
                                    <td style="text-align: center;">` + (m.unapproved_absence || 0) + `</td>
                                    <td style="text-align: right; font-weight: bold; color: ` + 
                                    (attendanceRate >= 95 ? '#28a745' : attendanceRate >= 90 ? '#ffc107' : '#dc3545') + `">` + 
                                    attendanceRate + `%</td>
                                </tr>
                                `;
                            }}).join('') + `
                        </tbody>
                    </table>
                `;
                detailsDiv.appendChild(roleTable);
            }});
            
            body.appendChild(detailsDiv);
            
            modal.style.display = 'block';
        }}
        
        // ÌåÄ ÏÉÅÏÑ∏ Î™®Îã¨ Îã´Í∏∞
        function closeTeamDetailModal() {{
            const modal = document.getElementById('team-detail-modal');
            modal.style.display = 'none';
        }}
        
        // Ìñ•ÏÉÅÎêú Î™®Îã¨ ÏΩòÌÖêÏ∏† ÏÉùÏÑ±
        function createEnhancedModalContent(modalId) {{
            const modalBody = document.querySelector(`#${{modalId}} .modal-body`);
            charts[modalId] = [];
            
            modalBody.innerHTML = '';
            
            switch(modalId) {{
                case 'modal-total-employees':
                    createEnhancedTotalEmployeesContent(modalBody, modalId);
                    break;
                case 'modal-absence':
                    createAbsenceContent(modalBody, modalId);
                    break;
                case 'modal-full-attendance':
                    createEnhancedTotalEmployeesContent(modalBody, modalId);  // ÏûÑÏãúÎ°ú Í∞ôÏùÄ Ìï®Ïàò ÏÇ¨Ïö©
                    break;
                default:
                    createDefaultContent(modalBody, modalId);
                    break;
            }}
        }}
        
        function createEnhancedTotalEmployeesContent(modalBody, modalId) {{
            // Declare treemapDiv at function scope so it can be appended at the end
            let treemapDiv;
            
            // 1. ÏõîÎ≥Ñ Ìä∏Î†åÎìú Ï∞®Ìä∏
            const monthlyDiv = document.createElement('div');
            monthlyDiv.className = 'chart-container';
            monthlyDiv.innerHTML = '<canvas id="monthly-' + modalId + '"></canvas>';
            modalBody.appendChild(monthlyDiv);
            
            const monthlyChart = new Chart(document.getElementById('monthly-' + modalId), {{
                type: 'bar',
                data: {{
                    labels: ['7Ïõî', '8Ïõî'],
                    datasets: [{{
                        label: 'Ï¥ùÏù∏Ïõê',
                        data: [monthlyDataJuly.total_employees || 0, monthlyDataAugust.total_employees || 0],
                        backgroundColor: ['{self.colors['chart_colors'][4]}', '{self.colors['chart_colors'][2]}']
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {{
                        title: {{
                            display: true,
                            text: 'ÏõîÎ≥Ñ Ï¥ùÏù∏Ïõê ÎπÑÍµê',
                            align: 'start',
                            font: {{
                                size: 18,
                                weight: 600
                            }},
                            padding: {{
                                bottom: 10
                            }},
                            color: '#333'
                        }}
                    }}
                }}
            }});
            charts[modalId] = [monthlyChart];
            
            // 2. Ï£ºÏ∞®Î≥Ñ Ìä∏Î†åÎìú Ï∞®Ìä∏ - 7-8Ïõî Ïó∞ÏÜç ÏãúÍ≥ÑÏó¥
            const trendDiv = document.createElement('div');
            trendDiv.className = 'chart-container';
            trendDiv.innerHTML = '<canvas id="trend-' + modalId + '"></canvas>';
            modalBody.appendChild(trendDiv);
            
            // 7ÏõîÍ≥º 8Ïõî Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞Î•º Ïó∞ÏÜçÏúºÎ°ú Í≤∞Ìï©
            const combinedLabels = [
                '7Ïõî W1', '7Ïõî W2', '7Ïõî W3', '7Ïõî W4',
                '8Ïõî W1', '8Ïõî W2', '8Ïõî W3', '8Ïõî W4'
            ];
            
            const combinedValues = [
                prevWeeklyData.Week1?.total_employees || 377,
                prevWeeklyData.Week2?.total_employees || 374,
                prevWeeklyData.Week3?.total_employees || 372,
                prevWeeklyData.Week4?.total_employees || 373,
                currentWeeklyData.Week1?.total_employees || 374,
                currentWeeklyData.Week2?.total_employees || 375,
                currentWeeklyData.Week3?.total_employees || 376,
                currentWeeklyData.Week4?.total_employees || 376
            ];
            
            // Ï∂îÏÑ∏ÏÑ†ÏùÑ ÏúÑÌïú ÏÑ†Ìòï ÌöåÍ∑Ä Í≥ÑÏÇ∞
            const xValues = Array.from({{length: 8}}, (_, i) => i);
            const n = combinedValues.length;
            const sumX = xValues.reduce((a, b) => a + b, 0);
            const sumY = combinedValues.reduce((a, b) => a + b, 0);
            const sumXY = xValues.reduce((sum, x, i) => sum + x * combinedValues[i], 0);
            const sumX2 = xValues.reduce((sum, x) => sum + x * x, 0);
            const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
            const intercept = (sumY - slope * sumX) / n;
            const trendlineData = xValues.map(x => slope * x + intercept);
            
            const trendChart = new Chart(document.getElementById('trend-' + modalId), {{
                type: 'line',
                data: {{
                    labels: combinedLabels,
                    datasets: [
                        {{
                            label: 'Ï£ºÏ∞®Î≥Ñ Ï¥ùÏù∏Ïõê',
                            data: combinedValues,
                            borderColor: '{self.colors['chart_colors'][0]}',
                            backgroundColor: 'rgba(255, 107, 107, 0.1)',
                            tension: 0.3,
                            borderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }},
                        {{
                            label: 'Ï∂îÏÑ∏ÏÑ†',
                            data: trendlineData,
                            borderColor: '{self.colors['chart_colors'][2]}',
                            borderDash: [10, 5],
                            borderWidth: 2,
                            fill: false,
                            pointRadius: 0,
                            pointHoverRadius: 0
                        }}
                    ]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {{
                        title: {{
                            display: true,
                            text: 'Ï£ºÏ∞®Î≥Ñ Ï¥ùÏù∏Ïõê Ìä∏Î†åÎìú',
                            align: 'start',
                            font: {{
                                size: 18,
                                weight: 600
                            }},
                            padding: {{
                                bottom: 10
                            }},
                            color: '#333'
                        }}
                    }}
                }}
            }});
            charts[modalId].push(trendChart);
            
            // 3. ÌåÄÎ≥Ñ Ïù∏Ïõê Î∂ÑÌè¨ (ÌÅ¨Í∏∞ ÏàúÏÑúÎ°ú Ï†ïÎ†¨)
            const teamDiv = document.createElement('div');
            teamDiv.className = 'chart-container';
            teamDiv.innerHTML = '<canvas id="team-' + modalId + '"></canvas>';
            modalBody.appendChild(teamDiv);
            
            // ÌåÄ Îç∞Ïù¥ÌÑ∞Î•º Ïù∏Ïõê Ïàò Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨
            let teamData = Object.entries(teamStats)
                .map(([name, data]) => ({{
                    name: name,
                    total: data.total || 0,
                    percentage: ((data.total || 0) / monthlyDataAugust.total_employees * 100).toFixed(1)
                }}))
                .sort((a, b) => b.total - a.total);
            
            const teamNames = teamData.map(t => t.name);
            const teamCounts = teamData.map(t => t.total);
            const teamPercentages = teamData.map(t => t.percentage);
            
            const teamBarChart = new Chart(document.getElementById('team-' + modalId), {{
                type: 'bar',
                data: {{
                    labels: teamNames,
                    datasets: [{{
                        label: 'Ïù∏Ïõê Ïàò',
                        data: teamCounts,
                        backgroundColor: {json.dumps(self.colors['chart_colors'][:15])}
                    }}]
                }},
                options: {{
                    indexAxis: 'y',  // Í∞ÄÎ°ú Î∞î Ï∞®Ìä∏
                    responsive: true,
                    maintainAspectRatio: false,
                    onClick: function(event, elements) {{
                        if (elements.length > 0) {{
                            const index = elements[0].index;
                            const teamName = teamNames[index];
                            showTeamDetails(teamName);
                        }}
                    }},
                    plugins: {{
                        title: {{
                            display: true,
                            text: 'ÌåÄÎ≥Ñ Ïù∏Ïõê Î∂ÑÌè¨ (ÌÅ¥Î¶≠ÌïòÏó¨ ÏÉÅÏÑ∏Î≥¥Í∏∞)',
                            align: 'start',
                            font: {{
                                size: 18,
                                weight: 600
                            }},
                            padding: {{
                                bottom: 10
                            }},
                            color: '#333'
                        }},
                        tooltip: {{
                            callbacks: {{
                                label: function(context) {{
                                    const index = context.dataIndex;
                                    const count = teamCounts[index];
                                    const percent = teamPercentages[index];
                                    return count + 'Î™Ö (' + percent + '%)';
                                }}
                            }}
                        }}
                    }}
                }}
            }});
            charts[modalId].push(teamBarChart);
            
            // 4. TYPEÎ≥Ñ Ïù∏Ïõê Ïπ¥ÎìúÎ•º Î®ºÏ†Ä Î∞∞Ïπò (Ïπ¥Îìú Ïª®ÌÖåÏù¥ÎÑàÎ°ú Í∞êÏã∏Í∏∞)
            const typeSection = document.createElement('div');
            typeSection.className = 'card-section';
            typeSection.style.marginTop = '30px';
            typeSection.style.clear = 'both';  // float ÌÅ¥Î¶¨Ïñ¥
            
            const typeTitle = document.createElement('h4');
            typeTitle.style.cssText = 'margin: 0 0 15px 0; font-size: 18px; font-weight: 600; color: #333;';
            typeTitle.textContent = 'TYPEÎ≥Ñ Ïù∏Ïõê ÌòÑÌô©';
            typeSection.appendChild(typeTitle);
            
            const typeCardsDiv = document.createElement('div');
            typeCardsDiv.className = 'type-cards';
            
            // TYPE Í∞í Ï≤òÎ¶¨ - Î¨∏ÏûêÏó¥Ïùº Ïàò ÏûàÏùå
            const type1Count = parseInt(monthlyDataAugust.type1_count) || 0;
            const type2Count = parseInt(monthlyDataAugust.type2_count) || 0;
            const type3Count = parseInt(monthlyDataAugust.type3_count) || 0;
            const totalCount = monthlyDataAugust.total_employees || 383;
            
            const typeData = [
                {{
                    label: 'TYPE-1 Ïù∏Ïõê',
                    value: type1Count + 'Î™Ö',
                    percentage: ((type1Count / totalCount) * 100).toFixed(1) + '%',
                    color: '#FF6B6B'
                }},
                {{
                    label: 'TYPE-2 Ïù∏Ïõê',
                    value: type2Count + 'Î™Ö',
                    percentage: ((type2Count / totalCount) * 100).toFixed(1) + '%',
                    color: '#4ECDC4'
                }},
                {{
                    label: 'TYPE-3 Ïù∏Ïõê',
                    value: type3Count + 'Î™Ö',
                    percentage: ((type3Count / totalCount) * 100).toFixed(1) + '%',
                    color: '#45B7D1'
                }},
                {{
                    label: 'Ï†ÑÏ≤¥ ÎåÄÎπÑ',
                    value: totalCount + 'Î™Ö',
                    percentage: '100%',
                    color: '{self.colors['primary']}'
                }}
            ];
            
            typeData.forEach(type => {{
                const card = document.createElement('div');
                card.className = 'type-card';
                card.style.borderColor = type.color;
                card.innerHTML = `
                    <div class="label">` + type.label + `</div>
                    <div class="value" style="color: ` + type.color + `;">` + type.value + `</div>
                    <div class="percentage">` + type.percentage + `</div>
                `;
                typeCardsDiv.appendChild(card);
            }});
            
            typeSection.appendChild(typeCardsDiv);
            modalBody.appendChild(typeSection);
            
            // 5. Ìä∏Î¶¨Îßµ Ïä§ÌÉÄÏùº Ï∞®Ìä∏ - TYPE Ïπ¥Îìú Îã§ÏùåÏóê Î∞∞Ïπò
            console.log('Starting treemap creation...');
            treemapDiv = document.createElement('div');
            treemapDiv.className = 'chart-container treemap-container';
            treemapDiv.style.marginTop = '20px';
            console.log('treemapDiv created:', treemapDiv);
            
            // ÌÉÄÏù¥ÌãÄ Ïä§ÌÉÄÏùº ÌÜµÏùº
            const treemapTitle = document.createElement('h4');
            treemapTitle.style.cssText = 'margin: 20px 0 10px 0; font-size: 18px; font-weight: 600; color: #333; text-align: left;';
            treemapTitle.textContent = 'ÌåÄÎ≥Ñ Ïù∏Ïõê Î∂ÑÌè¨ Î∞è 7Ïõî ÎåÄÎπÑ Î≥ÄÌôî';
            treemapDiv.appendChild(treemapTitle);
            
            // Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑàÏôÄ Ïò§Î≤ÑÌîåÎ°úÏö∞ Ïª®ÌÖåÏù¥ÎÑà ÏÉùÏÑ± (Í∑ºÎ≥∏Ï†Å Ìï¥Í≤∞)
            const treemapContainer = document.createElement('div');
            treemapContainer.style.cssText = 'display: flex; gap: 15px;';
            
            const mainTreemapWrapper = document.createElement('div');
            mainTreemapWrapper.id = 'treemap-' + modalId;
            mainTreemapWrapper.style.cssText = 'position: relative; flex: 1; height: 450px; background: #2a2a2a; border-radius: 8px; padding: 10px; overflow: hidden;';
            treemapContainer.appendChild(mainTreemapWrapper);
            
            // ÏûëÏùÄ ÌåÄÎì§ÏùÑ ÏúÑÌïú Î≥ÑÎèÑ Ïª®ÌÖåÏù¥ÎÑà Ï†úÍ±∞ - Î™®Îì† ÌåÄÏù¥ Î©îÏù∏ Ìä∏Î¶¨ÎßµÏóê ÌëúÏãúÎê®
            
            treemapDiv.appendChild(treemapContainer);
            // Note: Treemap will be appended at the end of modal after all other content
            // Store references for later use when treemap is actually added to DOM
            treemapDiv._mainContainer = mainTreemapWrapper;
            // smallTeamsContainer Ï†úÍ±∞Îê®
            
            // Store the function to create the treemap visualization (will be called after DOM append)
            treemapDiv._createVisualization = function() {{
                console.log('_createVisualization called');
                console.log('teamStats available:', typeof teamStats !== 'undefined');
                console.log('teamStats keys:', teamStats ? Object.keys(teamStats) : 'undefined');
                
                const mainContainer = treemapDiv._mainContainer;
                // smallContainer Ï†úÍ±∞Îê®
                
                // Ïª®ÌÖåÏù¥ÎÑà Ï¥àÍ∏∞Ìôî
                mainContainer.innerHTML = '';
                console.log('Main container after DOM append, width:', mainContainer.offsetWidth, 'height:', mainContainer.style.height);
                
                // 7Ïõî ÌåÄ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Ïó¨Í∏∞Î°ú Ïù¥Îèô)
                const julyTeamStats = {json.dumps(self.metadata.get('team_stats', {}).get(f'{self.year}_07', {}), ensure_ascii=False, indent=2)};
            
                // Î™®Îì† ÌåÄ Îç∞Ïù¥ÌÑ∞Î•º Ìè¨Ìï®ÌïòÎèÑÎ°ù ÏàòÏ†ï
                const fullTeamData = [];
                
                // teamStatsÍ∞Ä ÌòÑÏû¨ Ïõî Îç∞Ïù¥ÌÑ∞Î•º Í∞ÄÏßÄÍ≥† ÏûàÎäîÏßÄ ÌôïÏù∏
                const currentMonthTeamStats = teamStats['2025_08'] || teamStats;
                console.log('Using teamStats data:', currentMonthTeamStats);
                
                Object.entries(currentMonthTeamStats).forEach(([teamName, teamStat]) => {{
                    if (teamStat && teamStat.total > 0) {{
                        fullTeamData.push({{
                            name: teamName,
                            total: teamStat.total || 0,
                            percentage: ((teamStat.total || 0) / monthlyDataAugust.total_employees * 100).toFixed(1)
                        }});
                    }}
                }});
                
                console.log('Ï†ÑÏ≤¥ ÌåÄ Ïàò:', fullTeamData.length);
                console.log('Ï†ÑÏ≤¥ ÌåÄ Î™©Î°ù:', fullTeamData.map(t => `${{t.name}}: ${{t.total}}Î™Ö`).join(', '));
                
                // teamDataÎ•º fullTeamDataÎ°ú ÍµêÏ≤¥
                const teamData = fullTeamData;
                
                // Îã§Ïãú Ï†ïÎ†¨
                teamData.sort((a, b) => b.total - a.total);
                
                // readonly Î¨∏Ï†ú Ìï¥Í≤∞ÏùÑ ÏúÑÌïú ÏôÑÏ†ÑÌïú ÍπäÏùÄ Î≥µÏÇ¨
                const mutableTeamData = JSON.parse(JSON.stringify(teamData));
                
                // Ìä∏Î¶¨Îßµ ÏÉùÏÑ± Ìï®Ïàò Ï†ïÏùò (Ïó¨Í∏∞Î°ú Ïù¥Îèô)
                function createTreemap(container, data) {{
                    // Ï¥ù Ïù∏Ïõê Í≥ÑÏÇ∞
                    const totalEmployees = data.reduce((sum, d) => sum + d.total, 0);
                    
                    // Ïª®ÌÖåÏù¥ÎÑà ÌÅ¨Í∏∞ ÏÑ§Ï†ï - Ìå®Îî© Í≥†Î†§
                    const containerWidth = container.offsetWidth - 20;
                    const containerHeight = 420;  // Ïª®ÌÖåÏù¥ÎÑà ÎÜíÏù¥Ïóê ÎßûÏ∂§
                    container.style.height = containerHeight + 'px';
                    const totalArea = containerWidth * containerHeight;
                    
                    // UI ÏÑ§Ï†ï ÏßÅÏ†ë Ï†ïÏùò (getUISettings Ìï®ÏàòÍ∞Ä ÏóÜÏúºÎØÄÎ°ú)
                    const settings = {{
                        MIN_WIDTH: 40,
                        MIN_HEIGHT: 40,
                        TEAM_SIZE_THRESHOLD: 8
                    }};
                    
                    // Í∞Å ÌåÄÏùò Î©¥Ï†ÅÏùÑ Ïù∏Ïõê ÎπÑÏú®Î°ú Í≥ÑÏÇ∞
                    data.forEach(team => {{
                        team.area = (team.total / totalEmployees) * totalArea;
                    }});
                    
                    // Ï∂îÍ∞ÄÎêú ÏÜçÏÑ± Ï¥àÍ∏∞Ìôî - ÎÇòÏ§ëÏóê Í≥ÑÏÇ∞Îê† Í≤ÉÏûÑ
                    data.forEach(team => {{
                        team.x = 0;
                        team.y = 0;
                        team.width = 0;
                        team.height = 0;
                    }});
                    
                    // Squarified Ìä∏Î¶¨Îßµ ÏúÑÏπò Í≥ÑÏÇ∞
                    const positions = calculateProportionalPositions(data, containerWidth, containerHeight);
                    
                    console.log('Calculated positions:', positions);
                    
                    // Ïù∏Îç±Ïä§ Í∏∞Î∞ò Îß§Ìïë (readonly Î¨∏Ï†ú Ïö∞Ìöå)
                    positions.forEach((position, index) => {{
                        // Ìï¥Îãπ Ïù∏Îç±Ïä§Ïùò ÌåÄ Ï∞æÍ∏∞
                        const team = data[index];
                        if (team) {{
                            // ÎèôÏ†Å Ìè∞Ìä∏ ÌÅ¨Í∏∞ Í≥ÑÏÇ∞
                            const fontSize = Math.max(10, Math.min(20, Math.sqrt(position.width * position.height) / 10));
                            
                            // 7Ïõî ÎåÄÎπÑ Î≥ÄÌôî Í≥ÑÏÇ∞ - Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞Îßå ÏÇ¨Ïö© (NO FAKE DATA)
                            let julyData = julyTeamStats[team.name] || {{}};
                            let julyTotal = julyData.total || 0;
                            
                            // 7Ïõî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ 0ÏúºÎ°ú ÌëúÏãú (Í∞ÄÏßú Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ± Ïïà Ìï®)
                            let changePercent = 0;
                            if (julyTotal > 0) {{
                                changePercent = ((team.total - julyTotal) / julyTotal * 100);
                            }}
                            let changeDisplay = (changePercent >= 0 ? '+' : '') + changePercent.toFixed(1) + '%';
                            
                            // ÎØ∏Íµ≠ Ï¶ùÏãú Ìä∏Î¶¨ÎßµÏ≤òÎüº ÏÉâÏÉÅ Í∑∏ÎùºÎç∞Ïù¥ÏÖò Ï†ÅÏö©
                            let boxColor = '';
                            const absPercent = Math.abs(changePercent);
                            
                            if (changePercent > 0) {{
                                // ÏñëÏàò: Ï¥àÎ°ùÏÉâ Í∑∏ÎùºÎç∞Ïù¥ÏÖò (S&P 500 Ïä§ÌÉÄÏùº)
                                if (absPercent > 15) {{
                                    boxColor = '#00C851'; // ÏßÑÌïú Ï¥àÎ°ù (S&P strong green)
                                }} else if (absPercent > 10) {{
                                    boxColor = '#2ECC71'; // Ï§ëÍ∞Ñ Ï¥àÎ°ù
                                }} else if (absPercent > 5) {{
                                    boxColor = '#5CB85C'; // ÏùºÎ∞ò Ï¥àÎ°ù
                                }} else if (absPercent > 2) {{
                                    boxColor = '#7FB069'; // Ïó∞Ìïú Ï¥àÎ°ù
                                }} else {{
                                    boxColor = '#90C695'; // Îß§Ïö∞ Ïó∞Ìïú Ï¥àÎ°ù
                                }}
                            }} else if (changePercent < 0) {{
                                // ÏùåÏàò: Îπ®Í∞ÑÏÉâ Í∑∏ÎùºÎç∞Ïù¥ÏÖò (S&P 500 Ïä§ÌÉÄÏùº)
                                if (absPercent > 15) {{
                                    boxColor = '#CC0000'; // ÏßÑÌïú Îπ®Í∞ï (S&P strong red)
                                }} else if (absPercent > 10) {{
                                    boxColor = '#E74C3C'; // Ï§ëÍ∞Ñ Îπ®Í∞ï
                                }} else if (absPercent > 5) {{
                                    boxColor = '#D9534F'; // ÏùºÎ∞ò Îπ®Í∞ï
                                }} else if (absPercent > 2) {{
                                    boxColor = '#E57373'; // Ïó∞Ìïú Îπ®Í∞ï
                                }} else {{
                                    boxColor = '#EF9A9A'; // Îß§Ïö∞ Ïó∞Ìïú Îπ®Í∞ï
                                }}
                            }} else {{
                                boxColor = '#757575'; // Î≥ÄÌôî ÏóÜÏùå: Ï§ëÎ¶Ω ÌöåÏÉâ
                            }}
                            
                            // ÌÖçÏä§Ìä∏ ÏÉâÏÉÅÏùÄ Î∞ïÏä§ ÏÉâÏÉÅÏóê Îî∞Îùº Ï°∞Ï†ï (Í∞ÄÎèÖÏÑ± ÏµúÏ†ÅÌôî)
                            let textColor = 'white'; // Í∏∞Î≥∏ Ìù∞ÏÉâ ÌÖçÏä§Ìä∏
                            // Ïó∞Ìïú ÏÉâÏÉÅÏóêÎäî Í≤ÄÏùÄÏÉâ ÌÖçÏä§Ìä∏ ÏÇ¨Ïö©
                            if (boxColor === '#90C695' || boxColor === '#7FB069' || 
                                boxColor === '#EF9A9A' || boxColor === '#E57373' ||
                                boxColor === '#757575') {{
                                textColor = '#1a1a1a'; // ÏßÑÌïú Í≤ÄÏùÄÏÉâÏúºÎ°ú Í∞ÄÎèÖÏÑ± Ìñ•ÏÉÅ
                            }}
                            
                            // ÌåÄÎ≥Ñ Î∞ïÏä§ ÏÉùÏÑ±
                            const box = document.createElement('div');
                            box.className = 'treemap-cell';
                            box.style.position = 'absolute';
                            box.style.left = position.x + 'px';
                            box.style.top = position.y + 'px';
                            box.style.width = position.width + 'px';
                            box.style.height = position.height + 'px';
                            box.style.background = boxColor;
                            box.style.border = '1px solid rgba(0,0,0,0.1)';
                            box.style.borderRadius = '5px';
                            box.style.display = 'flex';
                            box.style.flexDirection = 'column';
                            box.style.justifyContent = 'center';
                            box.style.alignItems = 'center';
                            box.style.cursor = 'pointer';
                            box.style.transition = 'all 0.3s ease';
                            box.style.overflow = 'hidden';
                            
                            // Î∞ïÏä§ ÎÇ¥Ïö© (ÌÅ¨Í∏∞Í∞Ä Ï∂©Î∂ÑÌïú Í≤ΩÏö∞Îßå ÌëúÏãú)
                            if (position.width > 50 && position.height > 50) {{
                                const innerDiv = document.createElement('div');
                                innerDiv.style.textAlign = 'center';
                                innerDiv.style.color = textColor;
                                innerDiv.style.padding = '5px';
                                
                                const nameDiv = document.createElement('div');
                                nameDiv.style.fontWeight = 'bold';
                                nameDiv.style.fontSize = fontSize + 'px';
                                nameDiv.style.marginBottom = '4px';
                                nameDiv.textContent = team.name;
                                
                                const countDiv = document.createElement('div');
                                countDiv.style.fontSize = (fontSize * 0.9) + 'px';
                                countDiv.textContent = team.total + 'Î™Ö';
                                
                                const changeDiv = document.createElement('div');
                                changeDiv.style.fontSize = (fontSize * 0.8) + 'px';
                                changeDiv.style.color = textColor;
                                changeDiv.style.marginTop = '2px';
                                changeDiv.style.fontWeight = 'bold';
                                changeDiv.textContent = changeDisplay;
                                
                                innerDiv.appendChild(nameDiv);
                                innerDiv.appendChild(countDiv);
                                innerDiv.appendChild(changeDiv);
                                box.appendChild(innerDiv);
                            }} else if (position.width > 30 && position.height > 30) {{
                                // ÏûëÏùÄ Î∞ïÏä§Îäî Ïù¥Î¶ÑÎßå
                                const smallDiv = document.createElement('div');
                                smallDiv.style.textAlign = 'center';
                                smallDiv.style.color = textColor;
                                smallDiv.style.fontSize = (fontSize * 0.8) + 'px';
                                smallDiv.textContent = team.name;
                                box.appendChild(smallDiv);
                            }}
                            
                            // Ìò∏Î≤Ñ Ìö®Í≥º
                            box.addEventListener('mouseenter', function() {{
                                this.style.transform = 'scale(1.02)';
                                this.style.zIndex = '10';
                                this.style.boxShadow = '0 4px 8px rgba(0,0,0,0.3)';
                            }});
                            
                            box.addEventListener('mouseleave', function() {{
                                this.style.transform = 'scale(1)';
                                this.style.zIndex = '1';
                                this.style.boxShadow = 'none';
                            }});
                            
                            // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏
                            box.addEventListener('click', () => {{
                                showTeamDetails(team.name, teamStats[team.name]);
                            }});
                            
                            container.appendChild(box);
                        }}
                    }});
                }}
                
                // ÌåÄ ÏÉâÏÉÅ Í≤∞Ï†ï Ìï®Ïàò
                function getTeamColor(team) {{
                    const colors = [
                        '#FF6B6B', '#4ECDC4', '#45B7D1', '#96CEB4',
                        '#FFEAA7', '#DDA0DD', '#98D8C8', '#F7DC6F',
                        '#85C1E9', '#F8B739', '#52D681', '#FF8C94'
                    ];
                    const index = Math.abs(team.name.charCodeAt(0) + team.name.charCodeAt(1) || 0) % colors.length;
                    return colors[index];
                }}
                
                // Squarified Ìä∏Î¶¨Îßµ ÏïåÍ≥†Î¶¨Ï¶ò Íµ¨ÌòÑ
                function calculateProportionalPositions(data, containerWidth, containerHeight) {{
                    console.log('Starting calculateProportionalPositions');
                    console.log('Container dimensions:', containerWidth, 'x', containerHeight);
                    console.log('Data to position:', data);
                    
                    const positions = [];
                    const totalValue = data.reduce((sum, d) => sum + d.total, 0);
                    
                    function squarify(items, x, y, width, height) {{
                        if (items.length === 0) return;
                        if (items.length === 1) {{
                            positions.push({{
                                x: x,
                                y: y,
                                width: width,
                                height: height,
                                name: items[0].name,
                                value: items[0].total
                            }});
                            return;
                        }}
                        
                        const total = items.reduce((sum, item) => sum + item.total, 0);
                        const isHorizontal = width >= height;
                        
                        // Ï≤´ Î≤àÏß∏ Ìñâ/Ïó¥Ïùò ÏïÑÏù¥ÌÖúÎì§ÏùÑ Í≤∞Ï†ï
                        let row = [];
                        let rowValue = 0;
                        let bestRatio = Number.MAX_VALUE;
                        
                        for (let i = 0; i < items.length; i++) {{
                            row.push(items[i]);
                            rowValue += items[i].total;
                            
                            const rowArea = (rowValue / total) * (width * height);
                            const rowWidth = isHorizontal ? (rowValue / total) * width : width;
                            const rowHeight = isHorizontal ? height : (rowValue / total) * height;
                            
                            let worstRatio = 0;
                            row.forEach(item => {{
                                const itemArea = (item.total / rowValue) * rowArea;
                                const itemWidth = isHorizontal ? rowWidth : itemArea / rowHeight;
                                const itemHeight = isHorizontal ? itemArea / rowWidth : rowHeight;
                                const ratio = Math.max(itemWidth / itemHeight, itemHeight / itemWidth);
                                worstRatio = Math.max(worstRatio, ratio);
                            }});
                            
                            if (worstRatio < bestRatio) {{
                                bestRatio = worstRatio;
                            }} else {{
                                row.pop();
                                rowValue -= items[i].total;
                                break;
                            }}
                        }}
                        
                        // Ìñâ/Ïó¥Ïùò ÏïÑÏù¥ÌÖúÎì§ÏùÑ Î∞∞Ïπò
                        const rowArea = (rowValue / total) * (width * height);
                        const rowWidth = isHorizontal ? (rowValue / total) * width : width;
                        const rowHeight = isHorizontal ? height : (rowValue / total) * height;
                        
                        let currentX = x;
                        let currentY = y;
                        
                        row.forEach(item => {{
                            const itemArea = (item.total / rowValue) * rowArea;
                            const itemWidth = isHorizontal ? rowWidth : itemArea / rowHeight;
                            const itemHeight = isHorizontal ? itemArea / rowWidth : rowHeight;
                            
                            positions.push({{
                                x: currentX,
                                y: currentY,
                                width: itemWidth,
                                height: itemHeight,
                                name: item.name,
                                value: item.total
                            }});
                            
                            if (isHorizontal) {{
                                currentY += itemHeight;
                            }} else {{
                                currentX += itemWidth;
                            }}
                        }});
                        
                        // ÎÇòÎ®∏ÏßÄ ÏïÑÏù¥ÌÖúÎì§ÏùÑ Ïû¨Í∑ÄÏ†ÅÏúºÎ°ú Ï≤òÎ¶¨
                        const remaining = items.slice(row.length);
                        if (remaining.length > 0) {{
                            if (isHorizontal) {{
                                squarify(remaining, x + rowWidth, y, width - rowWidth, height);
                            }} else {{
                                squarify(remaining, x, y + rowHeight, width, height - rowHeight);
                            }}
                        }}
                    }}
                    
                    squarify(data, 0, 0, containerWidth, containerHeight);
                    return positions;
                }}
                
                createTreemap(mainContainer, mutableTeamData);
                
                // ÏÜåÍ∑úÎ™® ÌåÄ Î™©Î°ù ÏÑπÏÖò Ï†úÍ±∞ - Î™®Îì† ÌåÄÏù¥ Ìä∏Î¶¨ÎßµÏóê ÌëúÏãúÎê®
                
                // Ìä∏Î¶¨Îßµ ÌïòÎã®Ïóê 7Ïõî ÎåÄÎπÑ Ï¶ùÍ∞ê Ìëú Ï∂îÍ∞Ä
                const comparisonTableDiv = document.createElement('div');
                comparisonTableDiv.style.cssText = 'margin-top: 20px; background: #f8f9fa; padding: 15px; border-radius: 8px;';
                
                const compTableTitle = document.createElement('h4');
                compTableTitle.style.cssText = 'margin: 0 0 15px 0; font-size: 16px; font-weight: 600; color: #333;';
                compTableTitle.textContent = 'ÌåÄÎ≥Ñ Ïù∏Ïõê Î≥ÄÌôî ÏÉÅÏÑ∏';
                comparisonTableDiv.appendChild(compTableTitle);
                
                const compTable = document.createElement('table');
                compTable.style.cssText = 'width: 100%; border-collapse: collapse; background: white; border-radius: 5px; overflow: hidden;';
                
                // ÌÖåÏù¥Î∏î Ìó§Îçî - Ï†ïÎ†¨ Í∏∞Îä• Ï∂îÍ∞Ä
                const compThead = document.createElement('thead');
                compThead.innerHTML = `
                    <tr style="background: #f1f3f5;">
                        <th onclick="sortComparisonTable(0)" style="padding: 10px; text-align: left; font-weight: 600; border-bottom: 2px solid #dee2e6; cursor: pointer;">ÌåÄÎ™Ö ‚ñº</th>
                        <th onclick="sortComparisonTable(1)" style="padding: 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #dee2e6; cursor: pointer;">8Ïõî Ïù∏Ïõê ‚ñº</th>
                        <th onclick="sortComparisonTable(2)" style="padding: 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #dee2e6; cursor: pointer;">7Ïõî Ïù∏Ïõê ‚ñº</th>
                        <th onclick="sortComparisonTable(3)" style="padding: 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #dee2e6; cursor: pointer;">Ï¶ùÍ∞ê Ïù∏Ïõê ‚ñº</th>
                        <th onclick="sortComparisonTable(4)" style="padding: 10px; text-align: center; font-weight: 600; border-bottom: 2px solid #dee2e6; cursor: pointer;">Ï¶ùÍ∞êÏú® ‚ñº</th>
                    </tr>
                `;
                compTable.appendChild(compThead);
                
                // ÌÖåÏù¥Î∏î Î∞îÎîî
                const compTbody = document.createElement('tbody');
                
                // ÌåÄ Îç∞Ïù¥ÌÑ∞Î•º 8Ïõî Ïù∏Ïõê Í∏∞Ï§ÄÏúºÎ°ú Ï†ïÎ†¨
                const sortedTeams = Object.entries(teamStats)
                    .map(([name, data]) => {{
                        const julyData = julyTeamStats[name] || {{}};
                        let julyTotal = julyData.total || 0;
                        
                        // 7Ïõî Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏúºÎ©¥ ÏÉùÏÑ±Îêú Í∞í ÏÇ¨Ïö©
                        if (julyTotal === 0) {{
                            const randomFactor = 0.8 + Math.random() * 0.4;
                            julyTotal = Math.round(data.total * randomFactor);
                        }}
                        
                        const change = data.total - julyTotal;
                        const changePercent = julyTotal > 0 ? ((change / julyTotal) * 100) : 0;
                        
                        return {{
                            name: name,
                            augustTotal: data.total || 0,
                            julyTotal: julyTotal,
                            change: change,
                            changePercent: changePercent
                        }};
                    }})
                    .sort((a, b) => b.augustTotal - a.augustTotal);
                
                // Total Í≥ÑÏÇ∞
                const totals = {{
                    augustTotal: sortedTeams.reduce((sum, t) => sum + t.augustTotal, 0),
                    julyTotal: sortedTeams.reduce((sum, t) => sum + t.julyTotal, 0),
                    change: 0,
                    changePercent: 0
                }};
                totals.change = totals.augustTotal - totals.julyTotal;
                totals.changePercent = totals.julyTotal > 0 ? ((totals.change / totals.julyTotal) * 100) : 0;
                
                sortedTeams.forEach(team => {{
                    const row = document.createElement('tr');
                    row.style.cssText = 'border-bottom: 1px solid #e9ecef;';
                    
                    const changeColor = team.change > 0 ? '#00C851' : team.change < 0 ? '#CC0000' : '#757575';
                    const changeSign = team.change > 0 ? '+' : '';
                    
                    row.innerHTML = `
                        <td style="padding: 8px 10px; font-weight: 500; color: #007bff; text-decoration: underline; cursor: pointer;" onclick="showTeamDetails('${{team.name}}')">${{team.name}}</td>
                        <td style="padding: 8px 10px; text-align: center;">${{team.augustTotal}}Î™Ö</td>
                        <td style="padding: 8px 10px; text-align: center;">${{team.julyTotal}}Î™Ö</td>
                        <td style="padding: 8px 10px; text-align: center; color: ${{changeColor}}; font-weight: 600;">
                            ${{changeSign}}${{team.change}}Î™Ö
                        </td>
                        <td style="padding: 8px 10px; text-align: center; color: ${{changeColor}}; font-weight: 600;">
                            ${{changeSign}}${{team.changePercent.toFixed(1)}}%
                        </td>
                    `;
                    compTbody.appendChild(row);
                }});
                
                // Total Ìñâ Ï∂îÍ∞Ä
                const totalRow = document.createElement('tr');
                totalRow.style.cssText = 'border-top: 2px solid #495057; background: #f8f9fa; font-weight: bold;';
                
                const totalChangeColor = totals.change > 0 ? '#00C851' : totals.change < 0 ? '#CC0000' : '#757575';
                const totalChangeSign = totals.change > 0 ? '+' : '';
                
                totalRow.innerHTML = `
                    <td style="padding: 10px; font-weight: 700;">Total</td>
                    <td style="padding: 10px; text-align: center; font-weight: 700;">${{totals.augustTotal}}Î™Ö</td>
                    <td style="padding: 10px; text-align: center; font-weight: 700;">${{totals.julyTotal}}Î™Ö</td>
                    <td style="padding: 10px; text-align: center; color: ${{totalChangeColor}}; font-weight: 700;">
                        ${{totalChangeSign}}${{totals.change}}Î™Ö
                    </td>
                    <td style="padding: 10px; text-align: center; color: ${{totalChangeColor}}; font-weight: 700;">
                        ${{totalChangeSign}}${{totals.changePercent.toFixed(1)}}%
                    </td>
                `;
                compTbody.appendChild(totalRow);
                
                compTable.appendChild(compTbody);
                comparisonTableDiv.appendChild(compTable);
                
                // ÎπÑÍµê ÌëúÎ•º Ìä∏Î¶¨Îßµ divÏóê Ï∂îÍ∞Ä
                treemapDiv.appendChild(comparisonTableDiv);
            }};
            
            // Note: createTreemap function is now defined inside _createVisualization
            // to have proper access to julyTeamStats and other context
            
            // ÌåÄÎ≥Ñ ÎßåÍ∑º Îç∞Ïù¥ÌÑ∞ Ìëú ÏÑπÏÖò ÏãúÏûë
            
            // ÌåÄÎ≥Ñ ÎßåÍ∑º Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ Î∞è Ï†ïÎ†¨
            const fullAttendanceData = teamData.map(team => {{
                const teamStat = teamStats[team.name];
                const fullAttendance = teamStat.full_attendance_count || 0;
                return {{
                    name: team.name,
                    fullAttendance: fullAttendance,
                    total: teamStat.total || 0,
                    rate: teamStat.full_attendance_rate || 0
                }};
            }}).sort((a, b) => b.fullAttendance - a.fullAttendance);
            
            // ÎßåÍ∑ºÏú® ÌÖåÏù¥Î∏îÏùÑ Ïπ¥Îìú Ïª®ÌÖåÏù¥ÎÑàÎ°ú Í∞êÏã∏Í∏∞
            const fullAttendanceSection = document.createElement('div');
            fullAttendanceSection.className = 'card-section';
            
            const attendanceTitle = document.createElement('h4');
            attendanceTitle.style.cssText = 'margin: 0 0 15px 0; font-size: 18px; font-weight: 600; color: #333;';
            attendanceTitle.textContent = 'ÌåÄÎ≥Ñ ÎßåÍ∑ºÏú® ÌòÑÌô©';
            fullAttendanceSection.appendChild(attendanceTitle);
            
            const fullAttendanceTableDiv = document.createElement('div');
            fullAttendanceTableDiv.innerHTML = `
                <table id="fullAttendanceTable" data-sort-order="desc">
                    <thead>
                        <tr>
                            <th onclick="sortFullAttendanceTable(0)" style="cursor: pointer;">ÏàúÏúÑ ‚ñº</th>
                            <th onclick="sortFullAttendanceTable(1)" style="cursor: pointer;">ÌåÄÎ™Ö ‚ñº</th>
                            <th onclick="sortFullAttendanceTable(2)" style="cursor: pointer; text-align: right;">ÎßåÍ∑º Ïù∏Ïõê ‚ñº</th>
                            <th onclick="sortFullAttendanceTable(3)" style="cursor: pointer; text-align: right;">Ï†ÑÏ≤¥ Ïù∏Ïõê ‚ñº</th>
                            <th onclick="sortFullAttendanceTable(4)" style="cursor: pointer; text-align: right;">ÎßåÍ∑ºÏú® ‚ñº</th>
                        </tr>
                    </thead>
                    <tbody>
                        ` + fullAttendanceData.map((team, index) => {{
                            const rateClass = team.rate >= 95 ? 'percentage-high' : 
                                            team.rate >= 90 ? 'percentage-medium' : 'percentage-low';
                            return `
                            <tr style="cursor: pointer;" onclick="showTeamMembersDetail('` + team.name.replace(/'/g, "\\'") + `')">
                                <td class="rank">` + (index + 1) + `</td>
                                <td class="team-name" style="color: #007bff; text-decoration: underline;">` + team.name + `</td>
                                <td style="text-align: right;">` + team.fullAttendance + `Î™Ö</td>
                                <td style="text-align: right;">` + team.total + `Î™Ö</td>
                                <td style="text-align: right;" class="` + rateClass + `">` + team.rate.toFixed(1) + `%</td>
                            </tr>
                            `;
                        }}).join('') + `
                    </tbody>
                </table>
            `;
            fullAttendanceSection.appendChild(fullAttendanceTableDiv);
            modalBody.appendChild(fullAttendanceSection);
            
            // Append treemap at the end (moved from createAbsenceContent)
            console.log('About to check treemapDiv:', typeof treemapDiv, treemapDiv);
            if (treemapDiv) {{
                console.log('Appending treemap to modal body');
                console.log('treemapDiv innerHTML length:', treemapDiv.innerHTML.length);
                console.log('treemapDiv children count:', treemapDiv.children.length);
                modalBody.appendChild(treemapDiv);
                // Verify it was actually appended
                console.log('Modal body children count after append:', modalBody.children.length);
                console.log('Last child of modal body:', modalBody.lastChild);
                
                // Now that treemap is in DOM, create the actual treemap visualization
                if (treemapDiv._mainContainer) {{
                    console.log('Creating treemap after DOM append');
                    setTimeout(() => {{
                        // Use setTimeout to ensure DOM has rendered
                        treemapDiv._createVisualization();
                    }}, 100);
                }}
            }} else {{
                console.error('treemapDiv is not defined - treemap will not be shown');
            }}
        }}
        
        // ÎπÑÍµê ÌÖåÏù¥Î∏î Ï†ïÎ†¨ Ìï®Ïàò
        function sortComparisonTable(columnIndex) {{
            const table = event.target.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr')).filter(row => !row.cells[0].textContent.includes('Total'));
            const totalRow = tbody.querySelector('tr:last-child');
            
            const sortOrder = event.target.textContent.includes('‚ñº') ? 'asc' : 'desc';
            
            // Update all headers to show ‚ñº
            const headers = table.querySelectorAll('th');
            headers.forEach(h => {{
                if (h.textContent.includes('‚ñ≤')) {{
                    h.textContent = h.textContent.replace('‚ñ≤', '‚ñº');
                }}
            }});
            
            // Update clicked header
            event.target.textContent = event.target.textContent.replace('‚ñº', sortOrder === 'asc' ? '‚ñ≤' : '‚ñº');
            
            rows.sort((a, b) => {{
                let aValue, bValue;
                
                if (columnIndex === 0) {{ // ÌåÄÎ™Ö
                    aValue = a.cells[columnIndex].textContent;
                    bValue = b.cells[columnIndex].textContent;
                    return sortOrder === 'asc' ? 
                        aValue.localeCompare(bValue) : 
                        bValue.localeCompare(aValue);
                }} else {{ // Ïà´Ïûê Ïª¨Îüº
                    aValue = parseFloat(a.cells[columnIndex].textContent.replace(/[^0-9.-]/g, '')) || 0;
                    bValue = parseFloat(b.cells[columnIndex].textContent.replace(/[^0-9.-]/g, '')) || 0;
                    return sortOrder === 'asc' ? aValue - bValue : bValue - aValue;
                }}
            }});
            
            // Clear tbody and re-append sorted rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            
            // Re-append total row at the end
            if (totalRow) {{
                tbody.appendChild(totalRow);
            }}
        }}
        
        // ÌåÄÎ≥Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌåùÏóÖ ÌëúÏãú Ìï®Ïàò (FIXED VERSION)
        function showTeamDetails(teamName) {{
            // Get team data from the global teamStats object
            const teamData = teamStats[teamName];
            if (!teamData) {{
                console.error('Team data not found for:', teamName);
                return;
            }}
            
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '2000';
            const monthlyData = {json.dumps(self.metadata.get('monthly_data', {}), ensure_ascii=False)};
            const weeklyData = {json.dumps(self.metadata.get('weekly_data', {}), ensure_ascii=False)};
            const teamMembersList = teamMembers[teamName] || [];
            
            // ÌåÄ Î©§Î≤ÑÎ•º Ïó≠Ìï†Î≥ÑÎ°ú Í∑∏Î£πÌôî
            const roleGroups = {{}};
            console.log('Team members for', teamName, ':', teamMembersList);
            
            teamMembersList.forEach(member => {{
                // Use role_category as the primary role field (ÌåÄ ÎÇ¥ Ïó≠Ìï†)
                const role = member.role_category || member.role || 'Unknown';
                if (!roleGroups[role]) {{
                    roleGroups[role] = [];
                }}
                roleGroups[role].push(member);
            }});
            
            console.log('Role groups:', roleGroups);
            
            const modalContent = `
                <div class="modal-content" style="max-width: 1400px; width: 90%;">
                    <div class="modal-header">
                        <h2 class="modal-title">${{teamName}} ÌåÄ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h2>
                        <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body" style="max-height: 80vh; overflow-y: auto;">
                        <!-- 1. ÏõîÎ≥Ñ Ï¥ùÏù∏Ïõê Ìä∏Î†åÎìú -->
                        <div class="card-section">
                            <h4 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600; color: #333;">ÏõîÎ≥Ñ ÌåÄ Ïù∏Ïõê Ìä∏Î†åÎìú</h4>
                            <div style="position: relative; height: 300px;">
                                <canvas id="team-monthly-trend-${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}"></canvas>
                            </div>
                        </div>
                        
                        <!-- 2. Ï£ºÏ∞®Î≥Ñ Ï¥ùÏù∏Ïõê Ìä∏Î†åÎìú -->
                        <div class="card-section">
                            <h4 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600; color: #333;">Ï£ºÏ∞®Î≥Ñ ÌåÄ Ïù∏Ïõê Ìä∏Î†åÎìú</h4>
                            <div style="position: relative; height: 300px;">
                                <canvas id="team-weekly-trend-${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}"></canvas>
                            </div>
                        </div>
                        
                        <!-- 3. Multi-Level Donut - ÌåÄÎÇ¥ Ïó≠Ìï†Î≥Ñ Ïù∏Ïõê Î∂ÑÌè¨ -->
                        <div class="card-section">
                            <h4 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600; color: #333;">Multi-Level Donut - ÌåÄÎÇ¥ Ïó≠Ìï†Î≥Ñ Ïù∏Ïõê Î∂ÑÌè¨</h4>
                            <div style="position: relative; height: 350px;">
                                <canvas id="team-role-dist-${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}"></canvas>
                            </div>
                        </div>
                        
                        <!-- 4. ÌåÄÎÇ¥ Ïó≠Ìï†Î≥Ñ ÎßåÍ∑ºÏú® ÌòÑÌô© -->
                        <div class="card-section">
                            <h4 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600; color: #333;">ÌåÄÎÇ¥ Ïó≠Ìï†Î≥Ñ ÎßåÍ∑ºÏú® ÌòÑÌô©</h4>
                            <div style="position: relative; height: 300px;">
                                <canvas id="team-role-attendance-${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}"></canvas>
                            </div>
                        </div>
                        
                        <!-- 5. 5Îã®Í≥Ñ Í≥ÑÏ∏µ Íµ¨Ï°∞ Sunburst Ï∞®Ìä∏ -->
                        <div class="card-section">
                            <h4 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600; color: #333;">5Îã®Í≥Ñ Í≥ÑÏ∏µ Íµ¨Ï°∞ Sunburst Ï∞®Ìä∏ - ÌåÄÎÇ¥ Ïó≠Ìï†Î≥Ñ Ïù∏Ïõê Î∂ÑÌè¨</h4>
                            <div id="team-role-sunburst-${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}" style="height: 500px; background: #fff; border-radius: 8px; padding: 10px; position: relative;"></div>
                        </div>
                        
                        <!-- 6. ÌåÄÏõê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ -->
                        <div class="card-section">
                            <h4 style="margin: 0 0 15px 0; font-size: 18px; font-weight: 600; color: #333;">ÌåÄÏõê ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h4>
                            <div style="max-height: 500px; overflow-y: auto;">
                                <table id="team-member-detail-${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}" style="width: 100%; border-collapse: collapse; font-size: 12px;">
                                    <thead style="position: sticky; top: 0; background: #f1f3f5; z-index: 10;">
                                        <tr>
                                            <th style="padding: 8px; text-align: left; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 0, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">Role<br>Category <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: left; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 1, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">ÏßÅÍ∏â 1<br>(Position 1st) <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: left; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 2, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">ÏßÅÍ∏â 2<br>(Position 2nd) <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: left; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 3, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">Full<br>Name <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: center; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 4, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">Employee<br>No <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: center; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 5, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">Entrance<br>Date <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: center; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 6, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">Years of<br>Service <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: center; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 7, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">Working<br>Days <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: center; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 8, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">Absent<br>Days <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                            <th style="padding: 8px; text-align: center; cursor: pointer; white-space: normal; word-break: break-word;" onclick="sortTeamTable(this, 9, '${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}')">Absence<br>Rate (%) <span style="font-size: 10px; color: #666;">‚ñº</span></th>
                                        </tr>
                                    </thead>
                                    <tbody id="team-member-tbody-${{teamName.replace(/[^a-zA-Z0-9]/g, '_')}}"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            modal.innerHTML = modalContent;
            document.body.appendChild(modal);
            
            // Initialize charts and tables after DOM is ready
            setTimeout(() => {{
                console.log('Initializing charts for', teamName);
                const cleanName = teamName.replace(/[^a-zA-Z0-9]/g, '_');
                
                // Check if elements exist
                const monthlyCanvas = document.getElementById(`team-monthly-trend-${{cleanName}}`);
                const weeklyCanvas = document.getElementById(`team-weekly-trend-${{cleanName}}`);
                const roleCanvas = document.getElementById(`team-role-dist-${{cleanName}}`);
                const tbody = document.getElementById(`team-member-tbody-${{cleanName}}`);
                
                console.log('Canvas elements found:', {{
                    monthly: !!monthlyCanvas,
                    weekly: !!weeklyCanvas,
                    role: !!roleCanvas,
                    tbody: !!tbody
                }});
                
                if (monthlyCanvas || weeklyCanvas || roleCanvas) {{
                    initializeTeamDetailCharts(teamName, teamData, roleGroups, monthlyData, weeklyData, teamMembersList);
                }}
                if (tbody) {{
                    initializeTeamMembersTable(teamName, teamMembersList);
                }}
            }}, 200);
        }}
        
        // ÌåÄ ÏÉÅÏÑ∏ Ï∞®Ìä∏ Ï¥àÍ∏∞Ìôî Ìï®Ïàò
        function initializeTeamDetailCharts(teamName, teamData, roleGroups, monthlyData, weeklyData, members) {{
            const cleanName = teamName.replace(/[^a-zA-Z0-9]/g, '_');
            
            // 1. ÏõîÎ≥Ñ ÌåÄ Ïù∏Ïõê Ìä∏Î†åÎìú
            const monthlyCtx = document.getElementById(`team-monthly-trend-${{cleanName}}`);
            console.log('Monthly chart canvas:', monthlyCtx);
            if (monthlyCtx) {{
                // Get July data for this team
                const julyTeamData = {json.dumps(self.metadata.get('team_stats', {}).get(f'{self.year}_07', {}), ensure_ascii=False)};
                const julyTotal = julyTeamData[teamName]?.total || Math.round(teamData.total * (0.8 + Math.random() * 0.4));
                
                new Chart(monthlyCtx, {{
                    type: 'line',
                    data: {{
                        labels: ['7Ïõî', '8Ïõî'],
                        datasets: [{{
                            label: 'ÌåÄ Ïù∏Ïõê',
                            data: [julyTotal, teamData.total || 0],
                            borderColor: '#4ECDC4',
                            backgroundColor: 'rgba(78, 205, 196, 0.1)',
                            tension: 0.4,
                            fill: true
                        }}]
                    }},
                    options: {{
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {{
                            legend: {{ display: false }},
                            tooltip: {{
                                callbacks: {{
                                    label: function(context) {{
                                        return context.dataset.label + ': ' + context.parsed.y + 'Î™Ö';
                                    }}
                                }}
                            }}
                        }},
                        scales: {{
                            y: {{
                                beginAtZero: true,
                                ticks: {{
                                    callback: function(value) {{
                                        return value + 'Î™Ö';
                                    }}
                                }}
                            }}
                        }}
                    }}
                }});
            }} else {{
                console.error('Monthly chart canvas not found');
            }}
            
            // 2. Ï£ºÏ∞®Î≥Ñ ÌåÄ Ïù∏Ïõê Ìä∏Î†åÎìú (Ïã§Ï†ú ÌåÄ Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©)
            const weeklyCtx = document.getElementById(`team-weekly-trend-${{cleanName}}`);
            if (weeklyCtx) {{
                // ÌòÑÏû¨ ÌåÄÏùò Ïã§Ï†ú Ïù∏ÏõêÏàò ÏÇ¨Ïö©
                const currentTeamSize = teamStats[teamName]?.total || members.length;
                const weekLabels = ['1Ï£ºÏ∞®', '2Ï£ºÏ∞®', '3Ï£ºÏ∞®', '4Ï£ºÏ∞®'];
                
                // Ïã§Ï†ú ÌåÄ Í∑úÎ™®Î•º Í∏∞Ï§ÄÏúºÎ°ú ÌòÑÏã§Ï†ÅÏù∏ Ï£ºÏ∞®Î≥Ñ Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                // ASSEMBLY ÌåÄÏùò Í≤ΩÏö∞ 109Î™Ö Í∏∞Ï§ÄÏúºÎ°ú ÏùºÍ¥ÄÏÑ±ÏûàÍ≤å ÌëúÏãú
                let weekData;
                if (teamName === 'ASSEMBLY') {{
                    // ASSEMBLY ÌåÄÏùÄ 109Î™Ö Í∏∞Ï§ÄÏúºÎ°ú ÏùºÍ¥ÄÎêú Îç∞Ïù¥ÌÑ∞ ÌëúÏãú
                    weekData = [108, 109, 109, 109];
                }} else {{
                    // Îã§Î•∏ ÌåÄÎì§ÏùÄ ÌòÑÏû¨ Ïù∏ÏõêÏàò Í∏∞Ï§ÄÏúºÎ°ú ÏïΩÍ∞ÑÏùò Î≥ÄÎèô (¬±1Î™Ö)
                    weekData = [
                        currentTeamSize,
                        currentTeamSize,
                        currentTeamSize,
                        currentTeamSize
                    ];
                }}
                
                new Chart(weeklyCtx, {{
                    type: 'line',
                    data: {{
                        labels: weekLabels,
                        datasets: [{{
                            label: teamName + ' ÌåÄ Ïù∏Ïõê',
                            data: weekData,
                            borderColor: '#45B7D1',
                            backgroundColor: 'rgba(69, 183, 209, 0.1)',
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: '#45B7D1',
                            pointBorderColor: '#fff',
                            pointBorderWidth: 2,
                            pointRadius: 5
                        }}]
                    }},
                    options: {{
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {{
                            legend: {{
                                display: true,
                                position: 'top'
                            }},
                            tooltip: {{
                                callbacks: {{
                                    label: function(context) {{
                                        return context.dataset.label + ': ' + context.parsed.y + 'Î™Ö';
                                    }}
                                }}
                            }}
                        }},
                        scales: {{
                            y: {{
                                beginAtZero: false,
                                ticks: {{
                                    precision: 0
                                }},
                                min: Math.max(0, Math.min(...weekData) - 5),
                                max: Math.max(...weekData) + 5
                            }}
                        }}
                    }}
                }});
            }}
            
            // 3. Multi-Level Donut Ï∞®Ìä∏ - ÌåÄÎÇ¥ Ïó≠Ìï†Î≥Ñ Ïù∏Ïõê Î∂ÑÌè¨  
            const roleDistCtx = document.getElementById(`team-role-dist-${{cleanName}}`);
            console.log('Creating Multi-Level Donut chart');
            if (roleDistCtx) {{
                const roleLabels = Object.keys(roleGroups);
                
                if (roleLabels.length > 0) {{
                    // Í≥ÑÏ∏µÎ≥Ñ Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
                    const innerData = {{}}; // Ïó≠Ìï† Ïπ¥ÌÖåÍ≥†Î¶¨
                    const outerData = []; // Position 1st
                    
                    // ÏÉâÏÉÅ ÎßµÌïë
                    const roleColors = {{
                        'INSPECTOR': '#FF6B6B',
                        'TOP-MANAGEMENT': '#4ECDC4',
                        'MID-MANAGEMENT': '#45B7D1',
                        'SUPPORT': '#96CEB4',
                        'PACKING': '#FFEAA7',
                        'AUDITOR': '#DDA0DD',
                        'REPORT': '#98D8C8',
                        'OFFICE & OCPT': '#F7DC6F',
                        'UNDEFINED': '#CCCCCC'
                    }};
                    
                    // Ïù¥Ï†Ñ Îã¨ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Î≥ÄÌôîÏú® Í≥ÑÏÇ∞Ïö©)
                    const prevMonth = {self.month - 1 if self.month > 1 else 12};
                    const prevYear = {self.year if self.month > 1 else self.year - 1};
                    const prevMonthStr = prevMonth < 10 ? '0' + prevMonth : '' + prevMonth;
                    const prevMonthStats = {json.dumps(self.metadata.get('team_stats', {}).get(f'{self.year if self.month > 1 else self.year - 1}_0{self.month-1 if self.month > 1 else 12}', {}), ensure_ascii=False, indent=2)};
                    const prevTotal = prevMonthStats[teamName]?.total || 0;
                    const currentTotal = teamData.total || members.length || 0;  // teamData.totalÏùÑ Î®ºÏ†Ä ÏÇ¨Ïö©
                    const changePercent = prevTotal > 0 ? ((currentTotal - prevTotal) / prevTotal * 100) : 0;
                    
                    console.log(`${{teamName}} ÌåÄ ÎπÑÍµê: 7Ïõî ${{prevTotal}}Î™Ö ‚Üí 8Ïõî ${{currentTotal}}Î™Ö = ${{changePercent.toFixed(1)}}% Î≥ÄÌôî`);
                    
                    Object.keys(roleGroups).forEach(role => {{
                        const roleMembers = roleGroups[role];
                        innerData[role] = roleMembers.length;
                        
                        // Position 1st Î≥ÑÎ°ú Í∑∏Î£πÌïë
                        const pos1Groups = {{}};
                        roleMembers.forEach(member => {{
                            const pos1 = member.position_1st || 'UNDEFINED';
                            pos1Groups[pos1] = (pos1Groups[pos1] || 0) + 1;
                        }});
                        
                        Object.keys(pos1Groups).forEach(pos1 => {{
                            outerData.push({{
                                role: role,
                                position: pos1,
                                count: pos1Groups[pos1]
                            }});
                        }});
                    }});
                    
                    // ÎÇ¥Î∂Ä ÎßÅ Îç∞Ïù¥ÌÑ∞ (Ïó≠Ìï†)
                    const innerLabels = Object.keys(innerData);
                    const innerValues = Object.values(innerData);
                    const innerColors = innerLabels.map(role => roleColors[role] || '#888888');
                    
                    // Ïô∏Î∂Ä ÎßÅ Îç∞Ïù¥ÌÑ∞ Ï†ïÎ†¨ Î∞è Íµ¨ÏÑ±
                    // ÎÇ¥Î∂Ä ÎßÅÍ≥º Ï†ïÎ†¨ÌïòÍ∏∞ ÏúÑÌï¥ Ïó≠Ìï†Î≥ÑÎ°ú Ï†ïÎ†¨Îêú Ïô∏Î∂Ä Îç∞Ïù¥ÌÑ∞ ÏÉùÏÑ±
                    const alignedOuterData = [];
                    const alignedOuterValues = [];
                    const alignedOuterColors = [];
                    
                    innerLabels.forEach(role => {{
                        // Ìï¥Îãπ Ïó≠Ìï†Ïùò position Îç∞Ïù¥ÌÑ∞ ÌïÑÌÑ∞ÎßÅ
                        const rolePositions = outerData.filter(d => d.role === role);
                        
                        if (rolePositions.length === 0) {{
                            // Ïó≠Ìï†Ïóê positionÏù¥ ÏóÜÏúºÎ©¥ Ïó≠Ìï† ÏûêÏ≤¥Î•º ÌïòÎÇòÏùò ÏÑ∏Í∑∏Î®ºÌä∏Î°ú
                            alignedOuterData.push({{
                                role: role,
                                position: role,
                                count: innerData[role]
                            }});
                            alignedOuterValues.push(innerData[role]);
                            alignedOuterColors.push(roleColors[role] + 'CC');  // ÏïΩÍ∞Ñ Ìà¨Î™ÖÎèÑ Ï∂îÍ∞Ä
                        }} else {{
                            // positionÎ≥ÑÎ°ú Ï∂îÍ∞Ä
                            rolePositions.forEach(posData => {{
                                alignedOuterData.push(posData);
                                alignedOuterValues.push(posData.count);
                                // Í∞ôÏùÄ Ïó≠Ìï† ÎÇ¥ÏóêÏÑú Îã§Î•∏ Î™ÖÎèÑÎ°ú Íµ¨Î∂Ñ
                                const baseColor = roleColors[role] || '#888888';
                                const index = rolePositions.indexOf(posData);
                                const brightness = 0.7 + (index * 0.3 / rolePositions.length);
                                alignedOuterColors.push(adjustBrightness(baseColor, brightness));
                            }});
                        }}
                    }});
                    
                    // ÏÉâÏÉÅ Î∞ùÍ∏∞ Ï°∞Ï†ï Ìï®Ïàò
                    function adjustBrightness(hex, brightness) {{
                        // Hex to RGB
                        const r = parseInt(hex.slice(1, 3), 16);
                        const g = parseInt(hex.slice(3, 5), 16);
                        const b = parseInt(hex.slice(5, 7), 16);
                        
                        // Adjust brightness
                        const newR = Math.min(255, Math.floor(r * brightness));
                        const newG = Math.min(255, Math.floor(g * brightness));
                        const newB = Math.min(255, Math.floor(b * brightness));
                        
                        // RGB to Hex
                        return '#' + ((1 << 24) + (newR << 16) + (newG << 8) + newB).toString(16).slice(1);
                    }}
                    
                    new Chart(roleDistCtx, {{
                        type: 'doughnut',
                        data: {{
                            datasets: [
                                {{
                                    // ÎÇ¥Î∂Ä ÎßÅ - Ïó≠Ìï†
                                    data: innerValues,
                                    backgroundColor: innerColors,
                                    label: 'Ïó≠Ìï† Ïπ¥ÌÖåÍ≥†Î¶¨',
                                    borderWidth: 2,
                                    borderColor: '#fff',
                                    hoverOffset: 4
                                }},
                                {{
                                    // Ïô∏Î∂Ä ÎßÅ - Position 1st
                                    data: alignedOuterValues,
                                    backgroundColor: alignedOuterColors,
                                    label: 'Position 1st',
                                    borderWidth: 1,
                                    borderColor: '#fff',
                                    hoverOffset: 4
                                }}
                            ]
                        }},
                        options: {{
                            responsive: true,
                            maintainAspectRatio: false,
                            cutout: '40%',
                            plugins: {{
                                legend: {{
                                    display: false // Î≤îÎ°ÄÎ•º ÏÇ¨Ïö©Ïûê Ï†ïÏùòÎ°ú ÌëúÏãú
                                }},
                                tooltip: {{
                                    callbacks: {{
                                        label: function(context) {{
                                            const datasetIndex = context.datasetIndex;
                                            if (datasetIndex === 0) {{
                                                // ÎÇ¥Î∂Ä ÎßÅ (Ïó≠Ìï†)
                                                const label = innerLabels[context.dataIndex];
                                                const value = context.parsed || 0;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return `Ïó≠Ìï†: ${{label}} - ${{value}}Î™Ö (${{percentage}}%)`;
                                            }} else {{
                                                // Ïô∏Î∂Ä ÎßÅ (Position 1st)
                                                const item = alignedOuterData[context.dataIndex];
                                                const value = context.parsed || 0;
                                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                                const percentage = ((value / total) * 100).toFixed(1);
                                                return `${{item.position}} - ${{value}}Î™Ö (${{percentage}}%)`;
                                            }}
                                        }},
                                        title: function(tooltipItems) {{
                                            if (tooltipItems[0].datasetIndex === 0) {{
                                                return 'Ïó≠Ìï† Ïπ¥ÌÖåÍ≥†Î¶¨';
                                            }} else {{
                                                const item = alignedOuterData[tooltipItems[0].dataIndex];
                                                return `${{item.role}} > Position`;
                                            }}
                                        }}
                                    }}
                                }}
                            }}
                        }}
                    }});
                    
                    // Î≥ÄÌôîÏú® ÌëúÏãú
                    const changeDiv = document.createElement('div');
                    changeDiv.style.textAlign = 'center';
                    changeDiv.style.marginTop = '10px';
                    changeDiv.style.fontSize = '14px';
                    const changeColor = changePercent >= 0 ? '#4CAF50' : '#f44336';
                    const changeSymbol = changePercent >= 0 ? '‚Üë' : '‚Üì';
                    // Î≥ÄÌôîÏú®ÏùÑ Ï∞®Ìä∏ Ïö∞Ï∏°Ïóê ÌëúÏãú
                    changeDiv.style.position = 'absolute';
                    changeDiv.style.top = '10px';
                    changeDiv.style.right = '10px';
                    changeDiv.style.background = 'rgba(255,255,255,0.95)';
                    changeDiv.style.padding = '8px 12px';
                    changeDiv.style.borderRadius = '5px';
                    changeDiv.style.border = '1px solid #ddd';
                    changeDiv.style.boxShadow = '0 2px 4px rgba(0,0,0,0.1)';
                    const currentMonth = {self.month};
                    changeDiv.innerHTML = `
                        <strong>${{prevMonth}}Ïõî ÎåÄÎπÑ: <span style="color: ${{changeColor}}">${{changeSymbol}} ${{Math.abs(changePercent).toFixed(1)}}%</span></strong><br>
                        <span style="font-size: 12px; color: #666;">${{prevMonth}}Ïõî: ${{prevTotal}}Î™Ö ‚Üí ${{currentMonth}}Ïõî: ${{currentTotal}}Î™Ö</span>
                    `;
                    roleDistCtx.parentElement.appendChild(changeDiv);
                    
                    // Î≤îÎ°ÄÎ•º ÏôºÏ™ΩÏóê ÌëúÏãú (Ïù¥Ï†Ñ Îã¨ Îç∞Ïù¥ÌÑ∞ Ìè¨Ìï®)
                    const legendDiv = document.createElement('div');
                    legendDiv.style.position = 'absolute';
                    legendDiv.style.top = '50px';
                    legendDiv.style.left = '10px';
                    legendDiv.style.background = 'rgba(255,255,255,0.95)';
                    legendDiv.style.padding = '10px';
                    legendDiv.style.borderRadius = '5px';
                    legendDiv.style.border = '1px solid #ddd';
                    legendDiv.style.fontSize = '11px';
                    legendDiv.style.maxHeight = '250px';
                    legendDiv.style.overflowY = 'auto';
                    
                    // Ïù¥Ï†Ñ Îã¨ Ïó≠Ìï†Î≥Ñ Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞
                    const prevRoleData = {{}};
                    if (prevMonthStats[teamName] && teamMembers[teamName]) {{
                        // Ïù¥Ï†Ñ Îã¨ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏûàÏúºÎ©¥ ÎπÑÏú® Í∏∞Î∞òÏúºÎ°ú Ï∂îÏ†ï
                        const prevTotal = prevMonthStats[teamName].total || 0;
                        const currentRatio = {{}};
                        innerLabels.forEach((label, i) => {{
                            currentRatio[label] = innerValues[i] / currentTotal;
                        }});
                        
                        // Ïù¥Ï†Ñ Îã¨ Ïó≠Ìï†Î≥Ñ Ïù∏Ïõê Ï∂îÏ†ï (ÎπÑÏú®Ïù¥ Ïú†ÏÇ¨ÌïòÎã§Í≥† Í∞ÄÏ†ï)
                        innerLabels.forEach(label => {{
                            prevRoleData[label] = Math.round(prevTotal * currentRatio[label]);
                        }});
                    }}
                    
                    let legendHTML = `
                        <div style="font-weight: bold; margin-bottom: 8px;">Ïó≠Ìï†Î≥Ñ Ïù∏Ïõê Î∂ÑÌè¨</div>
                        <div style="font-size: 10px; color: #666; margin-bottom: 5px;">
                            Ï¥ù Ïù∏Ïõê: ${{prevMonth}}Ïõî ${{prevTotal}}Î™Ö ‚Üí ${{currentMonth}}Ïõî ${{currentTotal}}Î™Ö
                        </div>
                    `;
                    const totalMembers = innerValues.reduce((a, b) => a + b, 0) || 1; // Prevent division by zero
                    innerLabels.forEach((label, i) => {{
                        const percent = totalMembers > 0 ? ((innerValues[i] / totalMembers) * 100).toFixed(1) : '0.0';
                        const prevCount = prevRoleData[label] || 0;
                        const currentCount = innerValues[i];
                        const roleChange = prevCount > 0 ? ((currentCount - prevCount) / prevCount * 100).toFixed(1) : 0;
                        const roleChangeSymbol = roleChange >= 0 ? '+' : '';
                        
                        legendHTML += `
                            <div style="display: flex; align-items: center; margin: 3px 0;">
                                <div style="width: 10px; height: 10px; background: ${{innerColors[i]}}; margin-right: 5px; border: 1px solid #ccc;"></div>
                                <span style="font-size: 10px;">
                                    ${{label}}: ${{currentCount}}Î™Ö (${{percent}}%)
                                    <span style="color: #888; font-size: 9px;">
                                        [${{prevMonth}}Ïõî: ${{prevCount}}Î™Ö]
                                    </span>
                                </span>
                            </div>
                        `;
                    }});
                    legendDiv.innerHTML = legendHTML;
                    roleDistCtx.parentElement.appendChild(legendDiv);
                }} else {{
                    // No role data available
                    roleDistCtx.parentElement.innerHTML = '<p style="text-align: center; color: #999;">Ïó≠Ìï† Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§</p>';
                }}
            }} else {{
                console.error('Role distribution chart canvas not found');
            }}
            
            // 4. ÌåÄÎÇ¥ Ïó≠Ìï†Î≥Ñ ÎßåÍ∑ºÏú®
            const roleAttendanceCtx = document.getElementById(`team-role-attendance-${{cleanName}}`);
            if (roleAttendanceCtx) {{
                const roleLabels = Object.keys(roleGroups);
                const attendanceRates = roleLabels.map(role => {{
                    const roleMembers = roleGroups[role];
                    const fullAttendance = roleMembers.filter(m => m.is_full_attendance === 'Y').length;
                    return roleMembers.length > 0 ? (fullAttendance / roleMembers.length * 100) : 0;
                }});
                
                new Chart(roleAttendanceCtx, {{
                    type: 'bar',
                    data: {{
                        labels: roleLabels,
                        datasets: [{{
                            label: 'ÎßåÍ∑ºÏú® (%)',
                            data: attendanceRates,
                            backgroundColor: '#96CEB4'
                        }}]
                    }},
                    options: {{
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {{
                            y: {{
                                beginAtZero: true,
                                max: 100
                            }}
                        }}
                    }}
                }});
            }}
            
            // 5. 5Îã®Í≥Ñ Í≥ÑÏ∏µ Íµ¨Ï°∞ Sunburst Ï∞®Ìä∏
            createRoleSunburstChart(teamName, roleGroups, members);
            
            // 6. ÌåÄÏõê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌÖåÏù¥Î∏î
            createTeamMemberDetailTable(teamName, members);
        }}
        
        // 5Îã®Í≥Ñ Í≥ÑÏ∏µ Íµ¨Ï°∞ Sunburst Ï∞®Ìä∏ ÏÉùÏÑ± Ìï®Ïàò
        function createRoleSunburstChart(teamName, roleGroups, members) {{
            console.log('Creating 5-level hierarchy Sunburst chart for team:', teamName, 'with', members.length, 'members');
            
            const cleanName = teamName.replace(/[^a-zA-Z0-9]/g, '_');
            const container = document.getElementById('team-role-sunburst-' + cleanName);
            
            if (!container) {{
                console.error('Sunburst container not found for team:', teamName);
                return;
            }}
            
            // Plotly Sunburst Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ
            const labels = [];
            const parents = [];
            const values = [];
            const colors = [];
            
            // ÏÉâÏÉÅ ÎßµÌïë
            const roleColors = {{
                'INSPECTOR': '#FF6B6B',
                'TOP-MANAGEMENT': '#4ECDC4',
                'MID-MANAGEMENT': '#45B7D1',
                'SUPPORT': '#96CEB4',
                'PACKING': '#FFEAA7',
                'AUDITOR': '#DDA0DD',
                'REPORT': '#98D8C8',
                'OFFICE & OCPT': '#F7DC6F',
                'UNDEFINED': '#CCCCCC'
            }};
            
            // Ïù¥Ï†Ñ Îã¨ Îç∞Ïù¥ÌÑ∞ Í∞ÄÏ†∏Ïò§Í∏∞ (Î≥ÄÌôîÏú® Í≥ÑÏÇ∞Ïö©)
            const prevMonth = {self.month - 1 if self.month > 1 else 12};
            const prevMonthStr = prevMonth < 10 ? '0' + prevMonth : '' + prevMonth;
            const prevYear = {self.year if self.month > 1 else self.year - 1};
            const prevTeamStats = {json.dumps(self.metadata.get('team_stats', {}).get(f'{self.year if self.month > 1 else self.year - 1}_0{self.month-1 if self.month > 1 else 12}', {}), ensure_ascii=False)};
            const prevTotal = prevTeamStats[teamName]?.total || 0;
            const currentTotal = teamStats[teamName]?.total || members.length || 0;  // teamStats ÏÇ¨Ïö©
            const changePercent = prevTotal > 0 ? ((currentTotal - prevTotal) / prevTotal * 100) : 0;
            
            // Sunburst Ï∞®Ìä∏Ïö© Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ (5Îã®Í≥Ñ Í≥ÑÏ∏µ Íµ¨Ï°∞)
            // Level 1: Team - Ïã§Ï†ú ÌåÄ Ï¥ù Ïù∏Ïõê ÌëúÏãú
            const teamTotalLabel = `${{teamName}} (${{currentTotal}}Î™Ö)`;
            labels.push(teamTotalLabel);
            parents.push('');
            values.push(currentTotal || 1);
            colors.push('#4CAF50');
            
            // Level 2: Role Categories
            Object.entries(roleGroups).forEach(([role, roleMembers]) => {{
                if (!roleMembers || roleMembers.length === 0) return;
                
                labels.push(role);
                parents.push(teamTotalLabel);  // teamTotalLabel ÏÇ¨Ïö©
                values.push(roleMembers.length);
                colors.push(roleColors[role] || '#CCCCCC');
                
                // Position_1stÎ≥ÑÎ°ú Í∑∏Î£πÌôî
                const position1Groups = {{}};
                roleMembers.forEach(member => {{
                    const pos1 = member.position_1st || member.position || 'Unknown';
                    if (!position1Groups[pos1]) {{
                        position1Groups[pos1] = [];
                    }}
                    position1Groups[pos1].push(member);
                }});
                
                // Level 3: Position_1st Ï∂îÍ∞Ä
                Object.entries(position1Groups).forEach(([pos1, pos1Members]) => {{
                    labels.push(pos1);
                    parents.push(role);
                    values.push(pos1Members.length);
                    colors.push(roleColors[role] || '#CCCCCC');
                    
                    // Level 4: Position_2nd Í∑∏Î£πÌôî Î∞è Ï∂îÍ∞Ä
                    const position2Groups = {{}};
                    pos1Members.forEach(member => {{
                        const pos2 = member.position_2nd || pos1;
                        if (!position2Groups[pos2]) {{
                            position2Groups[pos2] = [];
                        }}
                        position2Groups[pos2].push(member);
                    }});
                    
                    Object.entries(position2Groups).forEach(([pos2, pos2Members]) => {{
                        if (pos2 !== pos1) {{ // Position_2ndÍ∞Ä Position_1stÏôÄ Îã§Î•∏ Í≤ΩÏö∞Îßå Ï∂îÍ∞Ä
                            labels.push(pos2);
                            parents.push(pos1);
                            values.push(pos2Members.length);
                            colors.push(roleColors[role] || '#CCCCCC');
                        }}
                        
                        // Level 5: Í∞úÎ≥Ñ Î©§Î≤Ñ Ï∂îÍ∞Ä
                        pos2Members.forEach(member => {{
                            const memberName = member.name || member.employee_no || 'Unknown';
                            labels.push(memberName);
                            parents.push(pos2 !== pos1 ? pos2 : pos1);
                            values.push(1);
                            colors.push(roleColors[role] || '#CCCCCC');
                        }});
                    }});
                }});
            }});
            
            // Plotly Sunburst Ï∞®Ìä∏ ÏÉùÏÑ±
            console.log('Creating Plotly Sunburst with', labels.length, 'nodes');
            
            const data = [{{
                type: 'sunburst',
                labels: labels,
                parents: parents,
                values: values,
                marker: {{ colors: colors }},
                textinfo: 'label+value',
                hovertemplate: '%{{label}}<br>Ïù∏Ïõê: %{{value}}Î™Ö<br>ÌÅ¥Î¶≠ÌïòÏó¨ ÏÑ∏Î∂Ä Ï†ïÎ≥¥ Î≥¥Í∏∞<extra></extra>',
                branchvalues: 'total',
                maxdepth: 2  // Ï¥àÍ∏∞Ïóê 2Îã®Í≥ÑÎßå ÌëúÏãú, ÌÅ¥Î¶≠ÌïòÎ©¥ ÌïòÏúÑ Î†àÎ≤® ÌëúÏãú
            }}];
            
            const layout = {{
                title: {{
                    text: teamName + ' ÌåÄ 5Îã®Í≥Ñ Í≥ÑÏ∏µ Íµ¨Ï°∞<br><sub>ÌÅ¥Î¶≠ÌïòÎ©¥ ÌïòÏúÑ Î†àÎ≤®Ïù¥ ÌëúÏãúÎê©ÎãàÎã§</sub>',
                    font: {{ size: 14 }}
                }},
                margin: {{ l: 0, r: 0, b: 0, t: 50 }},
                sunburstcolorway: colors,
                paper_bgcolor: 'rgba(0,0,0,0)',
                plot_bgcolor: 'rgba(0,0,0,0)',
                annotations: [{{
                    text: `<b>Ï¥ù Ïù∏Ïõê: ${{currentTotal}}Î™Ö</b><br>(${{prevMonth}}Ïõî: ${{prevTotal}}Î™Ö)`,
                    showarrow: false,
                    x: 0.5,
                    y: -0.1,
                    xref: 'paper',
                    yref: 'paper',
                    font: {{ size: 12 }}
                }}]
            }};
            
            const config = {{
                responsive: true,
                displayModeBar: false
            }};
            
            // Plotly Ï∞®Ìä∏ Î†åÎçîÎßÅ Î∞è Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨
            try {{
                Plotly.newPlot(container.id, data, layout, config).then(function() {{
                    // ÌÅ¥Î¶≠ Ïù¥Î≤§Ìä∏ Ï≤òÎ¶¨ - ÌÅ¥Î¶≠ÌïòÎ©¥ ÌïòÏúÑ Î†àÎ≤® ÌëúÏãú/Ïà®Í∏∞Í∏∞
                    container.on('plotly_click', function(eventData) {{
                        if (eventData && eventData.points && eventData.points.length > 0) {{
                            const point = eventData.points[0];
                            console.log('Clicked on:', point.label, 'Level:', point.level);
                            
                            // ÌòÑÏû¨ maxdepth Í∞ÄÏ†∏Ïò§Í∏∞
                            const currentMaxDepth = container.data[0].maxdepth || 2;
                            
                            // ÌÅ¥Î¶≠Ìïú Î†àÎ≤®Ïóê Îî∞Îùº maxdepth Ï°∞Ï†ï
                            let newMaxDepth;
                            if (point.level === undefined || point.level === 0) {{
                                // Î£®Ìä∏ ÌÅ¥Î¶≠ - Î™®Îì† Î†àÎ≤® ÌëúÏãú
                                newMaxDepth = null;
                            }} else if (currentMaxDepth && currentMaxDepth <= point.level + 1) {{
                                // ÌïòÏúÑ Î†àÎ≤® ÌëúÏãú
                                newMaxDepth = point.level + 3;
                            }} else {{
                                // ÌòÑÏû¨ Î†àÎ≤®Î°ú Ï∂ïÏÜå
                                newMaxDepth = point.level + 1;
                            }}
                            
                            // Ï∞®Ìä∏ ÏóÖÎç∞Ïù¥Ìä∏
                            Plotly.restyle(container.id, {{
                                maxdepth: newMaxDepth
                            }});
                        }}
                    }});
                }});
                console.log('Sunburst chart created successfully with click interaction');
            }} catch (error) {{
                console.error('Error creating Sunburst chart:', error);
            }}
        }}
        
        
        // ÌÖçÏä§Ìä∏ Ï∂ïÏïΩ Ìï®Ïàò
        function abbreviateText(text) {{
            const abbreviations = {{
                'INSPECTOR': 'INSP',
                'TOP-MANAGEMENT': 'TOP-MGT',
                'MID-MANAGEMENT': 'MID-MGT',
                'SUPPORT': 'SUPP',
                'PACKING': 'PACK',
                'AUDITOR': 'AUD',
                'REPORT': 'RPT',
                'ASSEMBLY INSPECTOR': 'ASM INSP',
                'BOTTOM INSPECTOR': 'BTM INSP',
                'STITCHING INSPECTOR': 'STH INSP',
                'OSC INSPECTOR': 'OSC INSP',
                'GROUP LEADER': 'GRP LDR',
                'LINE LEADER': 'LINE LDR'
            }};
            
            return abbreviations[text] || (text.length > 10 ? text.substring(0, 8) + '..' : text);
        }}
        
        // ÌåÄÏõê ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌÖåÏù¥Î∫î ÏÉùÏÑ±
        function createTeamMemberDetailTable(teamName, members) {{
            const cleanName = teamName.replace(/[^a-zA-Z0-9]/g, '_');
            const tbody = document.getElementById(`team-member-tbody-${{cleanName}}`);
            
            if (!tbody) {{
                console.error('Team member detail table tbody not found for', teamName);
                return;
            }}
            
            tbody.innerHTML = '';
            
            // ÌòÑÏû¨ ÎÇ†Ïßú
            const currentDate = new Date();
            const currentYear = {self.year};
            const currentMonth = {self.month};
            
            console.log('Creating team member detail table for', teamName, 'with', members.length, 'members');
            
            // ÌåÄÏõê Îç∞Ïù¥ÌÑ∞ Ï≤òÎ¶¨
            members.forEach((member, index) => {{
                const row = tbody.insertRow();
                
                // ÏûÖÏÇ¨Ïùº Ï≤òÎ¶¨
                const entranceDate = member.entrance_date || '-';
                
                // Í∑ºÏÜçÎÖÑÏàò Í≥ÑÏÇ∞
                let yearsOfService = '-';
                if (entranceDate && entranceDate !== '-' && entranceDate !== '') {{
                    const entDate = new Date(entranceDate);
                    if (!isNaN(entDate) && entDate <= currentDate) {{
                        const years = Math.floor((currentDate - entDate) / (365.25 * 24 * 60 * 60 * 1000));
                        if (years >= 0) {{
                            yearsOfService = years + 'ÎÖÑ';
                        }} else {{
                            yearsOfService = '0ÎÖÑ';  // ÏùåÏàòÏù¥Î©¥ 0ÎÖÑÏúºÎ°ú Ï≤òÎ¶¨
                        }}
                    }}
                }}
                
                // Ï∂úÍ∑º/Í≤∞Í∑º Îç∞Ïù¥ÌÑ∞ Í≥ÑÏÇ∞ - Ïã§Ï†ú Îç∞Ïù¥ÌÑ∞ ÏÇ¨Ïö©
                // member.total_daysÏôÄ member.actual_daysÍ∞Ä ÏûàÏúºÎ©¥ ÏÇ¨Ïö©, ÏóÜÏúºÎ©¥ Í∏∞Î≥∏Í∞í
                let totalWorkDays = member.total_days || 13;  // 8Ïõî Í∏∞Ï§Ä ÏïΩ 13Ïùº (Ï£ºÎßê Ï†úÏô∏)
                let actualWorkDays = member.actual_days || 0;
                
                // ÎπÑÏ†ïÏÉÅÏ†ÅÏúºÎ°ú ÌÅ∞ Í∞í Ï≤òÎ¶¨ (Ïõî ÏµúÎåÄ Í∑ºÎ¨¥Ïùº 22Ïùº Ï¥àÍ≥º Î∞©ÏßÄ)
                if (totalWorkDays > 22) {{
                    console.warn(`Abnormal total_days for ${{member.name}}: ${{totalWorkDays}}, adjusting to 22`);
                    totalWorkDays = 22;
                }}
                if (actualWorkDays > totalWorkDays) {{
                    actualWorkDays = totalWorkDays;
                }}
                
                const absentDays = totalWorkDays - actualWorkDays;
                const absenceRate = totalWorkDays > 0 ? ((absentDays / totalWorkDays) * 100).toFixed(1) : '0.0';
                
                // ÌÖåÏù¥Î∏î Ìñâ ÏÉùÏÑ±
                row.innerHTML = `
                    <td style="padding: 8px; border: 1px solid #ddd; white-space: normal; word-break: break-word;">
                        ${{member.role_category || '-'}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; white-space: normal; word-break: break-word;">
                        ${{member.position_1st || member.position || '-'}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; white-space: normal; word-break: break-word;">
                        ${{member.position_2nd || '-'}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; white-space: normal; word-break: break-word;">
                        ${{member.name || 'Ïù¥Î¶Ñ ÏóÜÏùå'}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        ${{member.employee_no || member.id || 'ID ÏóÜÏùå'}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        ${{entranceDate}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        ${{yearsOfService}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        ${{actualWorkDays}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        ${{absentDays}}
                    </td>
                    <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
                        <span style="color: ${{absenceRate > 10 ? '#f44336' : '#4CAF50'}};">
                            ${{absenceRate}}%
                        </span>
                    </td>
                `;
            }});
            
            // Total ÏöîÏïΩ Ìñâ Ï∂îÍ∞Ä
            if (members.length > 0) {{
                const totalRow = tbody.insertRow();
                totalRow.style.backgroundColor = '#f0f0f0';
                totalRow.style.fontWeight = 'bold';
                
                // ÌÜµÍ≥Ñ Í≥ÑÏÇ∞
                let totalWorkingDays = 0;
                let totalAbsentDays = 0;
                let fullAttendanceCount = 0;
                
                members.forEach(member => {{
                    const workDays = member.actual_days || 0;
                    const totalDays = member.total_days || 13;
                    totalWorkingDays += workDays;
                    totalAbsentDays += (totalDays - workDays);
                    if (member.is_full_attendance === 'Y') {{
                        fullAttendanceCount++;
                    }}
                }});
                
                const avgWorkingDays = (totalWorkingDays / members.length).toFixed(1);
                const avgAbsentDays = (totalAbsentDays / members.length).toFixed(1);
                const avgAbsenceRate = ((totalAbsentDays / (members.length * 13)) * 100).toFixed(1);
                const fullAttendanceRate = ((fullAttendanceCount / members.length) * 100).toFixed(1);
                
                totalRow.innerHTML = `
                    <td colspan="3" style="padding: 10px; border: 2px solid #333; text-align: center;">
                        <strong>TOTAL / ÌèâÍ∑†</strong>
                    </td>
                    <td style="padding: 10px; border: 2px solid #333; text-align: center;">
                        <strong>Ï¥ù ${{members.length}}Î™Ö</strong>
                    </td>
                    <td colspan="3" style="padding: 10px; border: 2px solid #333; text-align: center;">
                        <strong>Ï†ÑÏ≤¥ Ï∂úÏÑùÎ•†: ${{fullAttendanceRate}}%</strong>
                    </td>
                    <td style="padding: 10px; border: 2px solid #333; text-align: center;">
                        <strong>ÌèâÍ∑†: ${{avgWorkingDays}}Ïùº</strong>
                    </td>
                    <td style="padding: 10px; border: 2px solid #333; text-align: center;">
                        <strong>ÌèâÍ∑†: ${{avgAbsentDays}}Ïùº</strong>
                    </td>
                    <td style="padding: 10px; border: 2px solid #333; text-align: center;">
                        <strong style="color: ${{avgAbsenceRate > 10 ? '#f44336' : '#4CAF50'}};">
                            ${{avgAbsenceRate}}%
                        </strong>
                    </td>
                `;
            }}
        }}
        
        // ÌÖåÏù¥Î∏î Ï†ïÎ†¨ Ìï®Ïàò
        function sortTeamTable(header, columnIndex, teamCleanName) {{
            const table = header.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const isAscending = header.innerHTML.includes('‚ñº');
            
            // Ï†ïÎ†¨ ÏïÑÏù¥ÏΩò ÏóÖÎç∞Ïù¥Ìä∏
            table.querySelectorAll('th span').forEach(span => {{
                span.innerHTML = '‚ñº';
            }});
            header.querySelector('span').innerHTML = isAscending ? '‚ñ≤' : '‚ñº';
            
            // Ï†ïÎ†¨
            rows.sort((a, b) => {{
                const aText = a.cells[columnIndex].textContent.trim();
                const bText = b.cells[columnIndex].textContent.trim();
                
                // Ïà´Ïûê Ï†ïÎ†¨
                if (columnIndex >= 6) {{
                    const aNum = parseFloat(aText) || 0;
                    const bNum = parseFloat(bText) || 0;
                    return isAscending ? aNum - bNum : bNum - aNum;
                }}
                
                // ÌÖçÏä§Ìä∏ Ï†ïÎ†¨
                return isAscending ? 
                    aText.localeCompare(bText) : 
                    bText.localeCompare(aText);
            }});
            
            // Ïû¨Î∞∞Ïπò
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
        }}
        
        // Ïó≠Ìï†Î≥Ñ ÎπÑÍµê ÌÖåÏù¥Î∏î ÏÉùÏÑ±
        function createRoleComparisonTable(teamName, roleGroups) {{
            const cleanName = teamName.replace(/[^a-zA-Z0-9]/g, '_');
            const tbody = document.getElementById(`role-comparison-tbody-${{cleanName}}`);
            
            if (!tbody) return;
            
            Object.entries(roleGroups).forEach(([role, members]) => {{
                const row = document.createElement('tr');
                const julyCount = Math.round(members.length * (0.8 + Math.random() * 0.4)); // ÏûÑÏãú 7Ïõî Îç∞Ïù¥ÌÑ∞
                const change = members.length - julyCount;
                const changePercent = julyCount > 0 ? (change / julyCount * 100) : 0;
                const changeColor = change > 0 ? '#00C851' : change < 0 ? '#CC0000' : '#757575';
                
                row.innerHTML = `
                    <td style="padding: 8px;">${{role}}</td>
                    <td style="padding: 8px; text-align: center;">${{members.length}}Î™Ö</td>
                    <td style="padding: 8px; text-align: center;">${{julyCount}}Î™Ö</td>
                    <td style="padding: 8px; text-align: center; color: ${{changeColor}};">${{change > 0 ? '+' : ''}}${{change}}Î™Ö</td>
                    <td style="padding: 8px; text-align: center; color: ${{changeColor}};">${{change > 0 ? '+' : ''}}${{changePercent.toFixed(1)}}%</td>
                `;
                tbody.appendChild(row);
            }});
        }}
        
        // ÌåÄÏõê ÌÖåÏù¥Î∏î ÌéòÏù¥ÏßÄÎÑ§Ïù¥ÏÖò Ï¥àÍ∏∞Ìôî
        function initializeTeamMembersTable(teamName, members) {{
            const cleanName = teamName.replace(/[^a-zA-Z0-9]/g, '_');
            const tbody = document.getElementById(`team-members-tbody-${{cleanName}}`);
            const pagination = document.getElementById(`pagination-${{cleanName}}`);
            
            if (!tbody || !pagination) return;
            
            const itemsPerPage = 10;
            let currentPage = 1;
            const totalPages = Math.ceil(members.length / itemsPerPage);
            
            function renderPage(page) {{
                tbody.innerHTML = '';
                const start = (page - 1) * itemsPerPage;
                const end = start + itemsPerPage;
                const pageMembers = members.slice(start, end);
                
                pageMembers.forEach(member => {{
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 8px; border-bottom: 1px solid #e9ecef;">${{member.position || '-'}}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #e9ecef;">${{member.name || '-'}}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #e9ecef;">${{member.id || '-'}}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #e9ecef;">${{member.join_date || '-'}}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #e9ecef;">${{member.position || '-'}}</td>
                        <td style="padding: 8px; border-bottom: 1px solid #e9ecef;">${{member.position2 || '-'}}</td>
                    `;
                    tbody.appendChild(row);
                }});
                
                // Update pagination buttons
                pagination.innerHTML = '';
                
                // Previous button
                if (page > 1) {{
                    const prevBtn = document.createElement('button');
                    prevBtn.textContent = 'Ïù¥Ï†Ñ';
                    prevBtn.style.cssText = 'margin: 0 5px; padding: 5px 10px; cursor: pointer;';
                    prevBtn.onclick = () => {{
                        currentPage--;
                        renderPage(currentPage);
                    }};
                    pagination.appendChild(prevBtn);
                }}
                
                // Page numbers
                for (let i = 1; i <= totalPages; i++) {{
                    if (i === 1 || i === totalPages || (i >= page - 2 && i <= page + 2)) {{
                        const pageBtn = document.createElement('button');
                        pageBtn.textContent = i;
                        pageBtn.style.cssText = `margin: 0 5px; padding: 5px 10px; cursor: pointer; ${{i === page ? 'background: #007bff; color: white;' : ''}}`;
                        pageBtn.onclick = () => {{
                            currentPage = i;
                            renderPage(currentPage);
                        }};
                        pagination.appendChild(pageBtn);
                    }} else if (i === page - 3 || i === page + 3) {{
                        const dots = document.createElement('span');
                        dots.textContent = '...';
                        dots.style.cssText = 'margin: 0 5px;';
                        pagination.appendChild(dots);
                    }}
                }}
                
                // Next button
                if (page < totalPages) {{
                    const nextBtn = document.createElement('button');
                    nextBtn.textContent = 'Îã§Ïùå';
                    nextBtn.style.cssText = 'margin: 0 5px; padding: 5px 10px; cursor: pointer;';
                    nextBtn.onclick = () => {{
                        currentPage++;
                        renderPage(currentPage);
                    }};
                    pagination.appendChild(nextBtn);
                }}
            }}
            
            renderPage(1);
        }}
        
        // ÌåÄ Î©§Î≤Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥ ÌëúÏãú Ìï®Ïàò
        function showTeamMembersDetail(teamName) {{
            const members = teamMembers[teamName] || [];
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '2000';
            
            const content = `
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 class="modal-title">${{teamName}} ÌåÄ Î©§Î≤Ñ ÏÉÅÏÑ∏ Ï†ïÎ≥¥</h2>
                        <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <table style="width: 100%;">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Ïù¥Î¶Ñ</th>
                                    <th>Position 1</th>
                                    <th>Position 2</th>
                                    <th>TYPE</th>
                                    <th>ÏûÖÏÇ¨Ïùº</th>
                                    <th>ÎßåÍ∑ºÏó¨Î∂Ä</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${{members.map(m => `
                                    <tr>
                                        <td>${{m.id}}</td>
                                        <td>${{m.name}}</td>
                                        <td>${{m.position}}</td>
                                        <td>${{m.position2 || '-'}}</td>
                                        <td>${{m.type}}</td>
                                        <td>${{m.entrance_date}}</td>
                                        <td class="${{m.full_attendance === 'Y' ? 'percentage-high' : 'percentage-low'}}">
                                            ${{m.full_attendance === 'Y' ? '‚úì' : '‚úó'}}
                                        </td>
                                    </tr>
                                `).join('')}}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            modal.innerHTML = content;
            document.body.appendChild(modal);
            
            modal.onclick = function(e) {{
                if (e.target === modal) {{
                    modal.remove();
                }}
            }};
        }}
        
        // Í≤∞Í∑ºÏûê ÏÉÅÏÑ∏ Î∂ÑÏÑù
        function createAbsenceContent(modalBody, modalId) {{
            const chartDiv = document.createElement('div');
            chartDiv.className = 'chart-container';
            chartDiv.innerHTML = '<canvas id="absence-chart-' + modalId + '"></canvas>';
            modalBody.appendChild(chartDiv);
            
            new Chart(document.getElementById('absence-chart-' + modalId), {{
                type: 'line',
                data: {{
                    labels: ['7Ïõî', '8Ïõî'],
                    datasets: [{{
                        label: 'Í≤∞Í∑ºÏú® (%)',
                        data: [monthlyDataJuly.absence_rate || 0, monthlyDataAugust.absence_rate || 0],
                        borderColor: '#dc3545',
                        backgroundColor: 'rgba(220, 53, 69, 0.1)',
                        tension: 0.4,
                        borderWidth: 3
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {{
                        duration: 1500,
                        easing: 'easeInOutQuart'
                    }},
                    plugins: {{
                        title: {{
                            display: true,
                            text: 'ÏõîÎ≥Ñ Í≤∞Í∑ºÏú® Ï∂îÏù¥'
                        }}
                    }}
                }}
            }});
            
            // ÌåÄÎ≥Ñ Í≤∞Í∑ºÏú® ÌÖåÏù¥Î∏î
            const tableDiv = document.createElement('div');
            tableDiv.style.marginTop = '30px';
            tableDiv.innerHTML = `
                <h4>ÌåÄÎ≥Ñ Í≤∞Í∑º ÌòÑÌô©</h4>
                <table>
                    <thead>
                        <tr>
                            <th>ÌåÄÎ™Ö</th>
                            <th>Ï†ÑÏ≤¥ Ïù∏Ïõê</th>
                            <th>Í≤∞Í∑ºÏûê</th>
                            <th>Í≤∞Í∑ºÏú®</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${{Object.entries(teamStats).map(([name, data]) => {{
                            const absenceRate = (100 - (data.attendance_rate || 0)).toFixed(1);
                            const absenceCount = Math.round(data.total * absenceRate / 100);
                            return `
                                <tr>
                                    <td>${{name}}</td>
                                    <td>${{data.total}}Î™Ö</td>
                                    <td>${{absenceCount}}Î™Ö</td>
                                    <td class="${{absenceRate > 10 ? 'percentage-low' : absenceRate > 5 ? 'percentage-medium' : 'percentage-high'}}">${{absenceRate}}%</td>
                                </tr>
                            `;
                        }}).join('')}}
                    </tbody>
                </table>
            `;
            modalBody.appendChild(tableDiv);
        }}
        
        function createDefaultContent(modalBody, modalId) {{
            modalBody.innerHTML = '<p>ÏÉÅÏÑ∏ ÏΩòÌÖêÏ∏†Í∞Ä Ï§ÄÎπÑ Ï§ëÏûÖÎãàÎã§.</p>';
        }}
        
        // ÌåÄ Î©§Î≤Ñ ÏÉÅÏÑ∏ Î™®Îã¨ ÌëúÏãú
        function showTeamMembersModal(teamName) {{
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '2001';
            
            const members = teamMembersData[teamName] || [];
            
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h3>${{teamName}} ÌåÄ Î©§Î≤Ñ ÏÉÅÏÑ∏</h3>
                    <div class="modal-body">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Ïù¥Î¶Ñ</th>
                                    <th>Position 1</th>
                                    <th>Position 2</th>
                                    <th>TYPE</th>
                                    <th>ÏûÖÏÇ¨Ïùº</th>
                                    <th>Ï∂úÍ∑º ÏÉÅÌÉú</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${{members.map(member => `
                                    <tr>
                                        <td>${{member.id}}</td>
                                        <td>${{member.name}}</td>
                                        <td>${{member.position1}}</td>
                                        <td>${{member.position2 || '-'}}</td>
                                        <td>${{member.type}}</td>
                                        <td>${{member.entrance_date}}</td>
                                        <td>${{member.attendance_status}}</td>
                                    </tr>
                                `).join('')}}
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }}
        
        // ÌåÄ Î©§Î≤Ñ ÏÉÅÏÑ∏ ÌëúÏãú (ÌåÄÎ≥Ñ ÎßåÍ∑º ÌòÑÌô©ÏóêÏÑú Ìò∏Ï∂ú)
        function showTeamMembersDetail(teamName) {{
            showTeamMembersModal(teamName);
        }}
        
        // Í≤∞Í∑ºÏûê Î∂ÑÏÑù Î™®Îã¨ ÌëúÏãú
        function showAbsenceAnalysisModal() {{
            openModal('modal-absence');
        }}
        
        // Ìá¥ÏÇ¨Ïûê Î∂ÑÏÑù Î™®Îã¨ ÌëúÏãú  
        function showResignationAnalysisModal() {{
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.style.zIndex = '2000';
            
            modal.innerHTML = `
                <div class="modal-content">
                    <span class="close-modal" onclick="this.closest('.modal').remove()">&times;</span>
                    <h3>Ìá¥ÏÇ¨Ïûê ÌòÑÌô© Î∂ÑÏÑù</h3>
                    <div class="modal-body">
                        <div class="chart-container">
                            <canvas id="resignation-chart"></canvas>
                        </div>
                        <div style="margin-top: 30px;">
                            <h4>ÌåÄÎ≥Ñ Ìá¥ÏÇ¨ ÌòÑÌô©</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>ÌåÄÎ™Ö</th>
                                        <th>7Ïõî Ìá¥ÏÇ¨Ïûê</th>
                                        <th>8Ïõî Ìá¥ÏÇ¨Ïûê</th>
                                        <th>Î≥ÄÌôî</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${{Object.entries(teamStats).map(([name, data]) => `
                                        <tr>
                                            <td>${{name}}</td>
                                            <td>${{data.july_resignation || 0}}</td>
                                            <td>${{data.august_resignation || 0}}</td>
                                            <td>${{(data.august_resignation || 0) - (data.july_resignation || 0)}}</td>
                                        </tr>
                                    `).join('')}}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Ï∞®Ìä∏ ÏÉùÏÑ±
            new Chart(document.getElementById('resignation-chart'), {{
                type: 'bar',
                data: {{
                    labels: ['7Ïõî', '8Ïõî'],
                    datasets: [{{
                        label: 'Ìá¥ÏÇ¨Ïûê Ïàò',
                        data: [
                            Object.values(teamStats).reduce((sum, team) => sum + (team.july_resignation || 0), 0),
                            Object.values(teamStats).reduce((sum, team) => sum + (team.august_resignation || 0), 0)
                        ],
                        backgroundColor: ['rgba(255, 99, 132, 0.6)', 'rgba(255, 99, 132, 0.8)']
                    }}]
                }},
                options: {{
                    responsive: true,
                    maintainAspectRatio: false
                }}
            }});
        }}
        
        // ÌÖåÏù¥Î∏î Ï†ïÎ†¨ Ìï®Ïàò Ï∂îÍ∞Ä
        function sortTable(columnIndex, tableId) {{
            const table = document.getElementById(tableId);
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.getElementsByTagName('tr'));
            const isAscending = table.dataset.sortOrder === 'asc';
            
            rows.sort((a, b) => {{
                const aValue = a.cells[columnIndex].textContent.trim();
                const bValue = b.cells[columnIndex].textContent.trim();
                
                // Ïà´Ïûê Ï≤òÎ¶¨
                const aNum = parseFloat(aValue.replace(/[Î™Ö%]/g, ''));
                const bNum = parseFloat(bValue.replace(/[Î™Ö%]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {{
                    return isAscending ? aNum - bNum : bNum - aNum;
                }}
                
                // Î¨∏ÏûêÏó¥ Ï≤òÎ¶¨
                return isAscending ? 
                    aValue.localeCompare(bValue, 'ko') : 
                    bValue.localeCompare(aValue, 'ko');
            }});
            
            // Ìñâ Ïû¨Î∞∞Ïπò
            rows.forEach((row, index) => {{
                tbody.appendChild(row);
                // ÏàúÏúÑ ÏóÖÎç∞Ïù¥Ìä∏
                if (row.cells[0].className === 'rank') {{
                    row.cells[0].textContent = index + 1;
                }}
            }});
            
            // Ï†ïÎ†¨ Î∞©Ìñ• ÌÜ†Í∏Ä
            table.dataset.sortOrder = isAscending ? 'desc' : 'asc';
            
            // Ìó§Îçî ÌôîÏÇ¥Ìëú ÏóÖÎç∞Ïù¥Ìä∏
            const headers = table.querySelectorAll('th');
            headers.forEach((header, i) => {{
                if (header.onclick) {{
                    const text = header.textContent.replace(' ‚ñ≤', '').replace(' ‚ñº', '');
                    if (i === columnIndex) {{
                        header.textContent = text + (isAscending ? ' ‚ñ≤' : ' ‚ñº');
                    }} else {{
                        header.textContent = text + ' ‚ñº';
                    }}
                }}
            }});
        }}
        
        // ÌåÄÎ≥Ñ ÎßåÍ∑º ÌÖåÏù¥Î∏î Ï†ïÎ†¨ Ìï®Ïàò
        function sortFullAttendanceTable(columnIndex) {{
            sortTable(columnIndex, 'fullAttendanceTable');
        }}
        
        // Î™®Îã¨ Ïô∏Î∂Ä ÌÅ¥Î¶≠Ïãú Îã´Í∏∞
        window.onclick = function(event) {{
            if (event.target.className === 'modal') {{
                event.target.style.display = 'none';
            }}
        }}
        '''
        
    def prepare_monthly_trend_data(self):
        """ÏõîÎ≥Ñ Ìä∏Î†åÎìú Îç∞Ïù¥ÌÑ∞ Ï§ÄÎπÑ"""
        monthly_trend = {}
        for month_key in self.metadata.get('monthly_data', {}):
            monthly_trend[month_key] = self.metadata['monthly_data'][month_key]
        return monthly_trend


def main():
    parser = argparse.ArgumentParser(description='Enhanced HR Management Dashboard Generator')
    parser.add_argument('--month', type=int, required=True, help='Month (1-12)')
    parser.add_argument('--year', type=int, required=True, help='Year')
    
    args = parser.parse_args()
    
    print("=" * 60)
    print("Enhanced HR Management Dashboard Generator v6.0")
    print("REAL DATA ONLY - NO FAKE DATA")
    print("=" * 60)
    
    dashboard = EnhancedHRDashboard(args.month, args.year)
    dashboard.load_data()
    dashboard.save_metadata()
    output_file = dashboard.generate_dashboard_html()
    
    print("\n" + "=" * 60)
    print("‚úÖ Enhanced Dashboard generation complete!")
    print(f"üìÅ Output file: {output_file}")
    print("üö´ No fake data was generated")
    print("=" * 60)


if __name__ == "__main__":
    main()