<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>베트남어 인코딩 테스트</title>
    <style>
        body { font-family: 'Noto Sans', sans-serif; padding: 20px; }
        table { border-collapse: collapse; width: 100%; margin: 20px 0; }
        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
        th { background-color: #f2f2f2; }
        .status { margin: 20px 0; padding: 10px; background: #f0f8ff; border-radius: 5px; }
        .pass { color: green; font-weight: bold; }
        .fail { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <h1>베트남어 인코딩 테스트</h1>

    <div class="status" id="status">테스트 진행 중...</div>

    <h2>원본 데이터 (Python에서 생성)</h2>
    <table>
        <tr><th>원본 이름</th><th>예상 결과</th></tr>
        <tr><td>ĐINH KIM NGOAN</td><td>완벽한 베트남어 표시</td></tr>
        <tr><td>TRẦN KIỀU EM</td><td>완벽한 베트남어 표시</td></tr>
        <tr><td>LƯƠNG THỊ CẨM TIÊN</td><td>완벽한 베트남어 표시</td></tr>
        <tr><td>NGUYỄN THỊ BÍCH NGỌC</td><td>완벽한 베트남어 표시</td></tr>
    </table>

    <h2>Base64 디코딩 테스트 결과</h2>
    <table id="resultTable">
        <tr>
            <th>디코딩 방법</th>
            <th>결과</th>
            <th>상태</th>
        </tr>
    </table>

    <script>
        // 테스트 데이터: Python에서 생성한 Base64 인코딩된 베트남어 이름들
        const testData = [
            {"name": "ĐINH KIM NGOAN"},
            {"name": "TRẦN KIỀU EM"},
            {"name": "LƯƠNG THỊ CẨM TIÊN"},
            {"name": "NGUYỄN THỊ BÍCH NGỌC"}
        ];

        // Python과 동일한 방식으로 Base64 인코딩
        const jsonStr = JSON.stringify(testData);
        const base64Data = btoa(unescape(encodeURIComponent(jsonStr)));

        // 1. 잘못된 방법: 일반 atob (문제 재현)
        function wrongDecode(base64) {
            try {
                const decoded = atob(base64);
                return JSON.parse(decoded);
            } catch (e) {
                return "Error: " + e.message;
            }
        }

        // 2. 올바른 방법: UTF-8 지원 디코딩
        function base64DecodeUnicode(str) {
            try {
                const binaryString = atob(str);
                const bytes = new Uint8Array(binaryString.length);
                for (let i = 0; i < binaryString.length; i++) {
                    bytes[i] = binaryString.charCodeAt(i);
                }
                const decoder = new TextDecoder('utf-8');
                return decoder.decode(bytes);
            } catch (e) {
                return null;
            }
        }

        // 테스트 실행
        const table = document.getElementById('resultTable');
        const status = document.getElementById('status');

        // 잘못된 방법 테스트
        const wrongResult = wrongDecode(base64Data);
        const wrongRow = table.insertRow();
        wrongRow.insertCell().textContent = "일반 atob() 사용";
        wrongRow.insertCell().textContent = typeof wrongResult === 'string' ? wrongResult : "디코딩 실패";
        wrongRow.insertCell().innerHTML = '<span class="fail">❌ 깨짐</span>';

        // 올바른 방법 테스트
        const correctDecoded = base64DecodeUnicode(base64Data);
        const correctResult = correctDecoded ? JSON.parse(correctDecoded) : null;
        const correctRow = table.insertRow();
        correctRow.insertCell().textContent = "UTF-8 디코더 사용";

        if (correctResult && Array.isArray(correctResult)) {
            const names = correctResult.map(item => item.name).join(', ');
            correctRow.insertCell().textContent = names;

            // 베트남어 문자 확인
            const hasVietnamese = names.includes('ĐINH') && names.includes('TRẦN') &&
                                 names.includes('LƯƠNG') && names.includes('NGUYỄN');
            correctRow.insertCell().innerHTML = hasVietnamese ?
                '<span class="pass">✅ 정상</span>' :
                '<span class="fail">❌ 문제 있음</span>';

            status.innerHTML = hasVietnamese ?
                '<h3 class="pass">✅ UTF-8 디코딩 해결 완료!</h3><p>베트남어 이름이 올바르게 표시됩니다.</p>' :
                '<h3 class="fail">❌ 아직 문제가 있습니다</h3>';
        } else {
            correctRow.insertCell().textContent = "디코딩 실패";
            correctRow.insertCell().innerHTML = '<span class="fail">❌ 실패</span>';
            status.innerHTML = '<h3 class="fail">❌ 디코딩 실패</h3>';
        }

        // 개별 이름 테스트
        if (correctResult && Array.isArray(correctResult)) {
            const detailsRow = table.insertRow();
            detailsRow.insertCell().textContent = "개별 이름 확인";
            const namesList = correctResult.map(item => `• ${item.name}`).join('<br>');
            detailsRow.insertCell().innerHTML = namesList;

            const allCorrect = correctResult.every(item =>
                !item.name.includes('�') && !item.name.includes('?')
            );
            detailsRow.insertCell().innerHTML = allCorrect ?
                '<span class="pass">✅ 모든 이름 정상</span>' :
                '<span class="fail">❌ 일부 깨짐</span>';
        }
    </script>
</body>
</html>