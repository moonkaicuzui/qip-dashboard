<!DOCTYPE html>
<html>
<head>
    <title>Organization Hierarchy Test</title>
    <meta charset="UTF-8">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        #orgChart {
            width: 100%;
            height: 800px;
            overflow: auto;
            border: 1px solid #ddd;
        }
        .node rect {
            fill: #f0f0f0;
            stroke: #333;
            stroke-width: 2;
        }
        .node text {
            font-size: 11px;
        }
        .link {
            fill: none;
            stroke: #666;
            stroke-width: 1.5;
        }
    </style>
</head>
<body>
    <h2>Vertical Organization Chart Test</h2>
    <div id="orgChart"></div>

    <script>
        // Sample hierarchical data
        const sampleData = [
            { name: "S.Manager Kim", position: "S.MANAGER", boss_name: "" },
            { name: "Manager Lee", position: "MANAGER", boss_name: "S.Manager Kim" },
            { name: "Manager Park", position: "MANAGER", boss_name: "S.Manager Kim" },
            { name: "A.Manager Choi", position: "A.MANAGER", boss_name: "Manager Lee" },
            { name: "A.Manager Jung", position: "A.MANAGER", boss_name: "Manager Lee" },
            { name: "A.Manager Kang", position: "A.MANAGER", boss_name: "Manager Park" },
            { name: "Supervisor Kim", position: "SUPERVISOR", boss_name: "A.Manager Choi" },
            { name: "Supervisor Lee", position: "SUPERVISOR", boss_name: "A.Manager Jung" },
            { name: "Group Leader A", position: "GROUP LEADER", boss_name: "Supervisor Kim" },
            { name: "Group Leader B", position: "GROUP LEADER", boss_name: "Supervisor Kim" },
            { name: "Line Leader 1", position: "LINE LEADER", boss_name: "Group Leader A" },
            { name: "Line Leader 2", position: "LINE LEADER", boss_name: "Group Leader B" },
            { name: "Inspector 1", position: "QIP INSPECTOR", boss_name: "Line Leader 1" },
            { name: "Inspector 2", position: "QIP INSPECTOR", boss_name: "Line Leader 1" },
            { name: "Inspector 3", position: "QIP INSPECTOR", boss_name: "Line Leader 2" }
        ];

        // Build hierarchy
        const root = d3.stratify()
            .id(d => d.name)
            .parentId(d => d.boss_name || null)
            (sampleData);

        // Create tree layout
        const width = 1200;
        const height = 800;
        const margin = {top: 40, right: 120, bottom: 40, left: 120};

        const treeLayout = d3.tree()
            .size([width - margin.left - margin.right, height - margin.top - margin.bottom])
            .separation((a, b) => a.parent === b.parent ? 1.5 : 2);

        treeLayout(root);

        // Create SVG
        const svg = d3.select("#orgChart")
            .append("svg")
            .attr("width", width)
            .attr("height", height);

        const g = svg.append("g")
            .attr("transform", `translate(${margin.left},${margin.top})`);

        // Add zoom
        const zoom = d3.zoom()
            .scaleExtent([0.3, 3])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
            });

        svg.call(zoom);

        // Draw links (vertical step)
        const link = g.selectAll(".link")
            .data(root.links())
            .enter().append("path")
            .attr("class", "link")
            .attr("d", d => {
                const sx = d.source.x;
                const sy = d.source.y + 30; // Start from bottom of parent box
                const tx = d.target.x;
                const ty = d.target.y - 30; // End at top of child box
                const my = (sy + ty) / 2;

                return `M ${sx} ${sy}
                        L ${sx} ${my}
                        L ${tx} ${my}
                        L ${tx} ${ty}`;
            });

        // Draw nodes
        const node = g.selectAll(".node")
            .data(root.descendants())
            .enter().append("g")
            .attr("class", "node")
            .attr("transform", d => `translate(${d.x},${d.y})`);

        // Add rectangles for nodes
        node.append("rect")
            .attr("x", -60)
            .attr("y", -30)
            .attr("width", 120)
            .attr("height", 60)
            .attr("rx", 5)
            .style("fill", d => {
                const pos = d.data.position.toUpperCase();
                if (pos.includes('S.MANAGER')) return '#8b0000';
                if (pos.includes('MANAGER') && !pos.includes('A.')) return '#1f77b4';
                if (pos.includes('A.MANAGER')) return '#2ca02c';
                if (pos.includes('SUPERVISOR')) return '#ff7f0e';
                if (pos.includes('GROUP') && pos.includes('LEADER')) return '#d62728';
                if (pos.includes('LINE') && pos.includes('LEADER')) return '#9467bd';
                return '#8c564b';
            });

        // Add text
        node.append("text")
            .attr("dy", -5)
            .attr("text-anchor", "middle")
            .text(d => d.data.position)
            .style("font-weight", "bold")
            .style("fill", "white");

        node.append("text")
            .attr("dy", 10)
            .attr("text-anchor", "middle")
            .text(d => d.data.name)
            .style("font-size", "10px")
            .style("fill", "white");

        // Set initial zoom
        svg.call(zoom.transform, d3.zoomIdentity.scale(0.8));

        console.log("Hierarchy structure:");
        root.descendants().forEach(d => {
            if (d.children) {
                console.log(`${d.data.name} (${d.data.position}) has ${d.children.length} direct reports`);
            }
        });
    </script>
</body>
</html>